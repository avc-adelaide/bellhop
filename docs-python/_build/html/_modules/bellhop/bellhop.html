<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>bellhop.bellhop &#8212; BELLHOP Python API 0.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=d1102ebc" />
    <link rel="stylesheet" type="text/css" href="../../_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=27fed22d" />
    <script src="../../_static/documentation_options.js?v=2709fde1"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for bellhop.bellhop</h1><div class="highlight"><pre>
<span></span><span class="c1">##############################################################################</span>
<span class="c1">#</span>
<span class="c1"># Copyright (c) 2025-, Will Robertson</span>
<span class="c1"># Copyright (c) 2018-2025, Mandar Chitre</span>
<span class="c1">#</span>
<span class="c1"># This file was originally part of arlpy, released under Simplified BSD License.</span>
<span class="c1"># It has been relicensed in this repository to be compatible with the Bellhop licence (GPL).</span>
<span class="c1">#</span>
<span class="c1">##############################################################################</span>

<span class="sd">&quot;&quot;&quot;Underwater acoustic propagation modeling toolbox.</span>

<span class="sd">This toolbox currently uses the Bellhop acoustic propagation model. For this model</span>
<span class="sd">to work, the `acoustic toolbox &lt;https://oalib-acoustics.org/&gt;`_</span>
<span class="sd">must be installed on your computer and `bellhop.exe` should be in your PATH.</span>

<span class="sd">.. sidebar:: Sample Jupyter notebook</span>

<span class="sd">    For usage examples of this toolbox, see `Bellhop notebook &lt;_static/bellhop.html&gt;`_.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span> <span class="k">as</span> <span class="nn">_os</span>
<span class="kn">import</span> <span class="nn">re</span> <span class="k">as</span> <span class="nn">_re</span>
<span class="kn">import</span> <span class="nn">subprocess</span> <span class="k">as</span> <span class="nn">_proc</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">_np</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">interpolate</span> <span class="k">as</span> <span class="n">_interp</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">_pd</span>
<span class="kn">from</span> <span class="nn">tempfile</span> <span class="kn">import</span> <span class="n">mkstemp</span> <span class="k">as</span> <span class="n">_mkstemp</span>
<span class="kn">from</span> <span class="nn">struct</span> <span class="kn">import</span> <span class="n">unpack</span> <span class="k">as</span> <span class="n">_unpack</span>
<span class="kn">from</span> <span class="nn">sys</span> <span class="kn">import</span> <span class="n">float_info</span> <span class="k">as</span> <span class="n">_fi</span>
<span class="kn">import</span> <span class="nn">bellhop.plot</span> <span class="k">as</span> <span class="nn">_plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">_pyplt</span>
<span class="kn">import</span> <span class="nn">matplotlib.cm</span> <span class="k">as</span> <span class="nn">_cm</span>
<span class="kn">import</span> <span class="nn">bokeh</span> <span class="k">as</span> <span class="nn">_bokeh</span>

<span class="c1"># constants</span>
<span class="n">linear</span> <span class="o">=</span> <span class="s1">&#39;linear&#39;</span>
<span class="n">spline</span> <span class="o">=</span> <span class="s1">&#39;spline&#39;</span>
<span class="n">curvilinear</span> <span class="o">=</span> <span class="s1">&#39;curvilinear&#39;</span>
<span class="n">arrivals</span> <span class="o">=</span> <span class="s1">&#39;arrivals&#39;</span>
<span class="n">eigenrays</span> <span class="o">=</span> <span class="s1">&#39;eigenrays&#39;</span>
<span class="n">rays</span> <span class="o">=</span> <span class="s1">&#39;rays&#39;</span>
<span class="n">coherent</span> <span class="o">=</span> <span class="s1">&#39;coherent&#39;</span>
<span class="n">incoherent</span> <span class="o">=</span> <span class="s1">&#39;incoherent&#39;</span>
<span class="n">semicoherent</span> <span class="o">=</span> <span class="s1">&#39;semicoherent&#39;</span>


<span class="n">interp_map</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="n">spline</span><span class="p">,</span>
    <span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="n">linear</span><span class="p">,</span>
    <span class="s2">&quot;Q&quot;</span><span class="p">:</span> <span class="s2">&quot;quadrilateral&quot;</span><span class="p">,</span>
    <span class="s2">&quot;P&quot;</span><span class="p">:</span> <span class="s2">&quot;pchip&quot;</span><span class="p">,</span>
    <span class="s2">&quot;H&quot;</span><span class="p">:</span> <span class="s2">&quot;hexahedral&quot;</span><span class="p">,</span>
    <span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="s2">&quot;nlinear&quot;</span><span class="p">,</span>
    <span class="s2">&quot; &quot;</span><span class="p">:</span> <span class="s1">&#39;default&#39;</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">topbound_map</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;V&quot;</span><span class="p">:</span> <span class="s2">&quot;vacuum&quot;</span><span class="p">,</span>
    <span class="s2">&quot;A&quot;</span><span class="p">:</span> <span class="s2">&quot;acousto-elastic&quot;</span><span class="p">,</span>
    <span class="s2">&quot;R&quot;</span><span class="p">:</span> <span class="s2">&quot;rigid&quot;</span><span class="p">,</span>
    <span class="s2">&quot;F&quot;</span><span class="p">:</span> <span class="s2">&quot;from-file&quot;</span><span class="p">,</span>
    <span class="s2">&quot; &quot;</span><span class="p">:</span> <span class="s1">&#39;default&#39;</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">attunits_map</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="s2">&quot;nepers per meter&quot;</span><span class="p">,</span>
    <span class="s2">&quot;F&quot;</span><span class="p">:</span> <span class="s2">&quot;frequency dependent&quot;</span><span class="p">,</span>
    <span class="s2">&quot;M&quot;</span><span class="p">:</span> <span class="s2">&quot;dB per meter&quot;</span><span class="p">,</span>
    <span class="s2">&quot;m&quot;</span><span class="p">:</span> <span class="s2">&quot;frequency scaled dB per meter&quot;</span><span class="p">,</span>
    <span class="s2">&quot;W&quot;</span><span class="p">:</span> <span class="s2">&quot;dB per wavelength&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Q&quot;</span><span class="p">:</span> <span class="s2">&quot;quality factor&quot;</span><span class="p">,</span>
    <span class="s2">&quot;L&quot;</span><span class="p">:</span> <span class="s2">&quot;loss parameter&quot;</span><span class="p">,</span>
    <span class="s2">&quot; &quot;</span><span class="p">:</span> <span class="s1">&#39;default&#39;</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">volatt_map</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;&quot;</span><span class="p">:</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span>
    <span class="s2">&quot;T&quot;</span><span class="p">:</span> <span class="s1">&#39;thorp&#39;</span><span class="p">,</span>
    <span class="s2">&quot;F&quot;</span><span class="p">:</span> <span class="s1">&#39;francois-garrison&#39;</span><span class="p">,</span>
    <span class="s2">&quot;B&quot;</span><span class="p">:</span> <span class="s1">&#39;biological&#39;</span><span class="p">,</span>
    <span class="s2">&quot; &quot;</span><span class="p">:</span> <span class="s1">&#39;default&#39;</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">source_map</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;R&quot;</span><span class="p">:</span> <span class="s1">&#39;point&#39;</span><span class="p">,</span>
    <span class="s2">&quot;X&quot;</span><span class="p">:</span> <span class="s1">&#39;line&#39;</span><span class="p">,</span>
    <span class="s2">&quot; &quot;</span><span class="p">:</span> <span class="s1">&#39;default&#39;</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">grid_map</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;R&quot;</span><span class="p">:</span> <span class="s1">&#39;rectilinear&#39;</span><span class="p">,</span>
    <span class="s2">&quot;I&quot;</span><span class="p">:</span> <span class="s1">&#39;irregular&#39;</span><span class="p">,</span>
    <span class="s2">&quot; &quot;</span><span class="p">:</span> <span class="s1">&#39;default&#39;</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">beam_map</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;G&quot;</span><span class="p">:</span> <span class="s1">&#39;hat-cartesian&#39;</span><span class="p">,</span>
    <span class="s2">&quot;^&quot;</span><span class="p">:</span> <span class="s1">&#39;hat-cartesian&#39;</span><span class="p">,</span>
    <span class="s2">&quot;g&quot;</span><span class="p">:</span> <span class="s1">&#39;hat-ray&#39;</span><span class="p">,</span>
    <span class="s2">&quot;B&quot;</span><span class="p">:</span> <span class="s1">&#39;gaussian-cartesian&#39;</span><span class="p">,</span>
    <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="s1">&#39;gaussian-ray&#39;</span><span class="p">,</span>
    <span class="s2">&quot; &quot;</span><span class="p">:</span> <span class="s1">&#39;default&#39;</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">interp_rev</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">interp_map</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
<span class="n">topbound_rev</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">topbound_map</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
<span class="n">attunits_rev</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">attunits_map</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
<span class="n">volatt_rev</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">volatt_map</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
<span class="n">source_rev</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">source_map</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
<span class="n">grid_rev</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">grid_map</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
<span class="n">beam_rev</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">beam_map</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>


<span class="c1"># models (in order of preference)</span>
<span class="n">_models</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="create_env2d">
<a class="viewcode-back" href="../../index.html#bellhop.bellhop.create_env2d">[docs]</a>
<span class="k">def</span> <span class="nf">create_env2d</span><span class="p">(</span><span class="o">**</span><span class="n">kv</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a new 2D underwater environment.</span>

<span class="sd">    A basic environment is created with default values. To see all the parameters</span>
<span class="sd">    available and their default values:</span>

<span class="sd">    &gt;&gt;&gt; import arlpy.uwapm as pm</span>
<span class="sd">    &gt;&gt;&gt; env = pm.create_env2d()</span>
<span class="sd">    &gt;&gt;&gt; pm.print_env(env)</span>

<span class="sd">    The environment parameters may be changed by passing keyword arguments</span>
<span class="sd">    or modified later using a dictionary notation:</span>

<span class="sd">    &gt;&gt;&gt; import arlpy.uwapm as pm</span>
<span class="sd">    &gt;&gt;&gt; env = pm.create_env2d(depth=40, soundspeed=1540)</span>
<span class="sd">    &gt;&gt;&gt; pm.print_env(env)</span>
<span class="sd">    &gt;&gt;&gt; env[&#39;depth&#39;] = 25</span>
<span class="sd">    &gt;&gt;&gt; env[&#39;bottom_soundspeed&#39;] = 1800</span>
<span class="sd">    &gt;&gt;&gt; pm.print_env(env)</span>

<span class="sd">    The default environment has a constant sound speed. A depth dependent sound speed</span>
<span class="sd">    profile be provided as a Nx2 array of (depth, sound speed):</span>

<span class="sd">    &gt;&gt;&gt; import arlpy.uwapm as pm</span>
<span class="sd">    &gt;&gt;&gt; env = pm.create_env2d(depth=20, soundspeed=[[0,1540], [5,1535], [10,1535], [20,1530]])</span>

<span class="sd">    A range-and-depth dependent sound speed profile can be provided as a Pandas frame:</span>

<span class="sd">    &gt;&gt;&gt; import arlpy.uwapm as pm</span>
<span class="sd">    &gt;&gt;&gt; import pandas as pd</span>
<span class="sd">    &gt;&gt;&gt; ssp2 = pd.DataFrame({</span>
<span class="sd">              0: [1540, 1530, 1532, 1533],     # profile at 0 m range</span>
<span class="sd">            100: [1540, 1535, 1530, 1533],     # profile at 100 m range</span>
<span class="sd">            200: [1530, 1520, 1522, 1525] },   # profile at 200 m range</span>
<span class="sd">            index=[0, 10, 20, 30])             # depths of the profile entries in m</span>
<span class="sd">    &gt;&gt;&gt; env = pm.create_env2d(depth=20, soundspeed=ssp2)</span>

<span class="sd">    The default environment has a constant water depth. A range dependent bathymetry</span>
<span class="sd">    can be provided as a Nx2 array of (range, water depth):</span>

<span class="sd">    &gt;&gt;&gt; import arlpy.uwapm as pm</span>
<span class="sd">    &gt;&gt;&gt; env = pm.create_env2d(depth=[[0,20], [300,10], [500,18], [1000,15]])</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">env</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;arlpy&#39;</span><span class="p">,</span>
        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;2D&#39;</span><span class="p">,</span>                   <span class="c1"># 2D/3D</span>
        <span class="s1">&#39;frequency&#39;</span><span class="p">:</span> <span class="mi">25000</span><span class="p">,</span>             <span class="c1"># Hz</span>
        <span class="s1">&#39;ssp_env&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>                <span class="c1">#</span>
        <span class="s1">&#39;soundspeed&#39;</span><span class="p">:</span> <span class="mi">1500</span><span class="p">,</span>             <span class="c1"># m/s</span>
        <span class="s1">&#39;soundspeed_interp&#39;</span><span class="p">:</span> <span class="n">spline</span><span class="p">,</span>    <span class="c1"># spline/linear</span>
        <span class="s1">&#39;bottom_soundspeed&#39;</span><span class="p">:</span> <span class="mi">1600</span><span class="p">,</span>      <span class="c1"># m/s</span>
        <span class="s1">&#39;bottom_soundspeed_shear&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>   <span class="c1"># m/s</span>
        <span class="s1">&#39;bottom_density&#39;</span><span class="p">:</span> <span class="mi">1600</span><span class="p">,</span>         <span class="c1"># kg/m^3</span>
        <span class="s1">&#39;bottom_absorption&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>       <span class="c1"># dB/wavelength??</span>
        <span class="s1">&#39;bottom_absorption_shear&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="c1"># dB/wavelength??</span>
        <span class="s1">&#39;bottom_roughness&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>          <span class="c1"># m (rms)</span>
        <span class="s1">&#39;surface&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>                <span class="c1"># surface profile</span>
        <span class="s1">&#39;surface_interp&#39;</span><span class="p">:</span> <span class="n">linear</span><span class="p">,</span>       <span class="c1"># curvilinear/linear</span>
        <span class="s1">&#39;tx_depth&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>                  <span class="c1"># m</span>
        <span class="s1">&#39;tx_ndepth&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>              <span class="c1">#</span>
        <span class="s1">&#39;tx_directionality&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>      <span class="c1"># [(deg, dB)...]</span>
        <span class="s1">&#39;rx_depth&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>                 <span class="c1"># m</span>
        <span class="s1">&#39;rx_ndepth&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>              <span class="c1">#</span>
        <span class="s1">&#39;rx_range&#39;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span>               <span class="c1"># m</span>
        <span class="s1">&#39;rx_nrange&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>              <span class="c1">#</span>
        <span class="s1">&#39;depth&#39;</span><span class="p">:</span> <span class="mi">25</span><span class="p">,</span>                    <span class="c1"># m</span>
        <span class="s1">&#39;depth_interp&#39;</span><span class="p">:</span> <span class="n">linear</span><span class="p">,</span>         <span class="c1"># curvilinear/linear</span>
        <span class="s1">&#39;depth_npts&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>                <span class="c1">#</span>
        <span class="s1">&#39;depth_sigmaz&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>              <span class="c1">#</span>
        <span class="s1">&#39;depth_max&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>              <span class="c1"># m</span>
        <span class="s1">&#39;min_angle&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">80</span><span class="p">,</span>               <span class="c1"># deg</span>
        <span class="s1">&#39;max_angle&#39;</span><span class="p">:</span> <span class="mi">80</span><span class="p">,</span>                <span class="c1"># deg</span>
        <span class="s1">&#39;nbeams&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>                    <span class="c1"># number of beams (0 = auto)</span>
        <span class="s1">&#39;top_boundary_condition&#39;</span><span class="p">:</span> <span class="s1">&#39;vacuum&#39;</span><span class="p">,</span>
        <span class="s1">&#39;volume_attenuation&#39;</span><span class="p">:</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span>
        <span class="s1">&#39;attenuation_units&#39;</span><span class="p">:</span> <span class="s1">&#39;frequency dependent&#39;</span><span class="p">,</span>
        <span class="s1">&#39;step_size&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;box_depth&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;box_range&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;tx_type&#39;</span><span class="p">:</span> <span class="s1">&#39;default&#39;</span><span class="p">,</span>
        <span class="s1">&#39;beam_type&#39;</span><span class="p">:</span> <span class="s1">&#39;default&#39;</span><span class="p">,</span>
        <span class="s1">&#39;grid&#39;</span><span class="p">:</span> <span class="s1">&#39;default&#39;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kv</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">env</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;Unknown key: &#39;</span><span class="o">+</span><span class="n">k</span><span class="p">)</span>
        <span class="n">env</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">_pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="ow">and</span> <span class="n">_np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">v</span>
    <span class="n">env</span><span class="p">[</span><span class="s1">&#39;depth_max&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;depth_max&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">_np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">])</span>
    <span class="n">env</span> <span class="o">=</span> <span class="n">check_env2d</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">env</span></div>


<div class="viewcode-block" id="read_env2d">
<a class="viewcode-back" href="../../index.html#bellhop.bellhop.read_env2d">[docs]</a>
<span class="k">def</span> <span class="nf">read_env2d</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Read a 2D underwater environment from a BELLHOP .env file.</span>

<span class="sd">    This function parses a BELLHOP .env file and returns a Python data structure</span>
<span class="sd">    that is compatible with create_env2d(). This enables round-trip testing and</span>
<span class="sd">    compatibility between file-based and programmatic environment definitions.</span>

<span class="sd">    :param fname: path to .env file (with or without .env extension)</span>
<span class="sd">    :returns: environment dictionary compatible with create_env2d()</span>

<span class="sd">    The returned environment dictionary contains the following keys:</span>

<span class="sd">    - name: environment title/name</span>
<span class="sd">    - type: &#39;2D&#39; (fixed for 2D environments)</span>
<span class="sd">    - frequency: acoustic frequency in Hz</span>
<span class="sd">    - soundspeed: sound speed profile (scalar for constant, array for depth-dependent)</span>
<span class="sd">    - soundspeed_interp: interpolation method (&#39;linear&#39;, &#39;spline&#39;, &#39;quadrilateral&#39;)</span>
<span class="sd">    - bottom_soundspeed: bottom sediment sound speed in m/s</span>
<span class="sd">    - bottom_soundspeed_shear: bottom sediment sound speed in m/s</span>
<span class="sd">    - bottom_density: bottom sediment density in kg/m³</span>
<span class="sd">    - bottom_absorption: bottom sediment absorption in dB/wavelength</span>
<span class="sd">    - bottom_absorption_shear: bottom sediment absorption in dB/wavelength</span>
<span class="sd">    - bottom_roughness: bottom roughness RMS in meters</span>
<span class="sd">    - surface: surface altimetry profile (None if flat surface)</span>
<span class="sd">    - surface_interp: surface interpolation method (&#39;linear&#39;, &#39;curvilinear&#39;)</span>
<span class="sd">    - top_boundary_condition: (&#39;vacuum&#39;, &#39;acousto-elastic&#39;, &#39;rigid&#39;, &#39;from-file&#39;)</span>
<span class="sd">    - volume_attenuation: (&#39;none&#39;, &#39;thorp&#39;, &#39;francois-garrison&#39;, &#39;biological&#39;)</span>
<span class="sd">    - attenuation_units: (&#39;nepers per meter&#39;, &#39;frequency dependent&#39;, &#39;dB per meter&#39;, &#39;frequency scaled dB per meter&#39;, &#39;dB per wavelength&#39;, &#39;quality factor&#39;, &#39;loss parameter&#39;)</span>
<span class="sd">    - tx_depth: transmitter depth(s) in meters</span>
<span class="sd">    - tx_directionality: transmitter beam pattern (None if omnidirectional)</span>
<span class="sd">    - rx_depth: receiver depth(s) in meters</span>
<span class="sd">    - rx_range: receiver range(s) in meters</span>
<span class="sd">    - depth: maximum water depth in meters</span>
<span class="sd">    - depth_interp: bathymetry interpolation method (&#39;linear&#39;, &#39;curvilinear&#39;)</span>
<span class="sd">    - min_angle: minimum beam angle in degrees</span>
<span class="sd">    - max_angle: maximum beam angle in degrees</span>
<span class="sd">    - nbeams: number of beams (0 for automatic)</span>
<span class="sd">    - step_size: (maximum) step size to trace rays in meters (0 for automatic)</span>
<span class="sd">    - box_depth: box extent to trace rays in meters (auto-calculated based on max depth data if not specified)</span>
<span class="sd">    - box_range: box extent to trace rays in meters (auto-calculated based on max receiver range if not specified)</span>
<span class="sd">    - tx_type: point (default) or line</span>
<span class="sd">    - beam_type: todo</span>
<span class="sd">    - grid: rectilinear or irregular</span>


<span class="sd">    **Supported ENV file formats:**</span>

<span class="sd">    - Standard BELLHOP format with various boundary conditions</span>
<span class="sd">    - Constant or depth-dependent sound speed profiles</span>
<span class="sd">    - Compressed vector notation (e.g., &quot;0.0 5000.0 /&quot; for linearly spaced values)</span>
<span class="sd">    - Comments (lines with ! are handled correctly)</span>
<span class="sd">    - Different top/bottom boundary options (halfspace, file-based, etc.)</span>

<span class="sd">    **Unit conversions performed:**</span>

<span class="sd">    - Receiver ranges: km → m</span>
<span class="sd">    - Bottom density: g/cm³ → kg/m³</span>
<span class="sd">    - All other units preserved as in ENV file</span>

<span class="sd">    **Examples:**</span>

<span class="sd">    &gt;&gt;&gt; import bellhop as bh</span>
<span class="sd">    &gt;&gt;&gt; env = bh.read_env2d(&#39;examples/Munk/MunkB_ray.env&#39;)</span>
<span class="sd">    &gt;&gt;&gt; print(env[&#39;name&#39;])</span>
<span class="sd">    &#39;Munk profile&#39;</span>
<span class="sd">    &gt;&gt;&gt; print(env[&#39;frequency&#39;])</span>
<span class="sd">    50.0</span>

<span class="sd">    &gt;&gt;&gt; # Use with existing functions</span>
<span class="sd">    &gt;&gt;&gt; checked_env = bh.check_env2d(env)</span>
<span class="sd">    &gt;&gt;&gt; rays = bh.compute_rays(env)</span>

<span class="sd">    &gt;&gt;&gt; # Round-trip compatibility</span>
<span class="sd">    &gt;&gt;&gt; env_orig = bh.create_env2d(name=&quot;test&quot;, frequency=100)</span>
<span class="sd">    &gt;&gt;&gt; # ... write to file via BELLHOP ...</span>
<span class="sd">    &gt;&gt;&gt; env_read = bh.read_env2d(&quot;test.env&quot;)</span>
<span class="sd">    &gt;&gt;&gt; assert env_read[&#39;frequency&#39;] == env_orig[&#39;frequency&#39;]</span>

<span class="sd">    **Limitations:**</span>

<span class="sd">    - External files (.ssp, .bty, .ati, .sbp) are noted but not automatically loaded</span>
<span class="sd">    - Some advanced BELLHOP features may not be fully supported</span>
<span class="sd">    - Assumes standard 2D BELLHOP format (not BELLHOP3D)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">os</span>
    <span class="kn">import</span> <span class="nn">re</span>

    <span class="c1"># Add .env extension if not present</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">fname</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.env&#39;</span><span class="p">):</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">fname</span> <span class="o">+</span> <span class="s1">&#39;.env&#39;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Environment file not found: </span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Initialize environment with default values from create_env2d</span>
    <span class="n">env</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;arlpy&#39;</span><span class="p">,</span>
        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;2D&#39;</span><span class="p">,</span>
        <span class="s1">&#39;frequency&#39;</span><span class="p">:</span> <span class="mi">25000</span><span class="p">,</span>
        <span class="s1">&#39;ssp_env&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;soundspeed&#39;</span><span class="p">:</span> <span class="mi">1500</span><span class="p">,</span>
        <span class="s1">&#39;soundspeed_interp&#39;</span><span class="p">:</span> <span class="n">spline</span><span class="p">,</span>
        <span class="s1">&#39;bottom_soundspeed&#39;</span><span class="p">:</span> <span class="mi">1600</span><span class="p">,</span>
        <span class="s1">&#39;bottom_soundspeed_shear&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;bottom_density&#39;</span><span class="p">:</span> <span class="mi">1600</span><span class="p">,</span>
        <span class="s1">&#39;bottom_absorption&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;bottom_absorption_shear&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;bottom_roughness&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;surface&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;surface_interp&#39;</span><span class="p">:</span> <span class="n">linear</span><span class="p">,</span>
        <span class="s1">&#39;tx_depth&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
        <span class="s1">&#39;tx_directionality&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;rx_depth&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
        <span class="s1">&#39;rx_range&#39;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span>
        <span class="s1">&#39;tx_ndepth&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;rx_ndepth&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;rx_nrange&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;depth&#39;</span><span class="p">:</span> <span class="mi">25</span><span class="p">,</span>
        <span class="s1">&#39;depth_interp&#39;</span><span class="p">:</span> <span class="n">linear</span><span class="p">,</span>
        <span class="s1">&#39;depth_npts&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;depth_sigmaz&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;depth_max&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;min_angle&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">80</span><span class="p">,</span>
        <span class="s1">&#39;max_angle&#39;</span><span class="p">:</span> <span class="mi">80</span><span class="p">,</span>
        <span class="s1">&#39;nbeams&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;top_boundary_condition&#39;</span><span class="p">:</span> <span class="s1">&#39;vacuum&#39;</span><span class="p">,</span>
        <span class="s1">&#39;volume_attenuation&#39;</span><span class="p">:</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span>
        <span class="s1">&#39;attenuation_units&#39;</span><span class="p">:</span> <span class="s1">&#39;frequency dependent&#39;</span><span class="p">,</span>
        <span class="s1">&#39;step_size&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;box_depth&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;box_range&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;beam_type&#39;</span><span class="p">:</span> <span class="s1">&#39;default&#39;</span><span class="p">,</span>
        <span class="s1">&#39;tx_type&#39;</span><span class="p">:</span> <span class="s1">&#39;default&#39;</span><span class="p">,</span>
        <span class="s1">&#39;grid&#39;</span><span class="p">:</span> <span class="s1">&#39;default&#39;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="nf">_parse_quoted_string</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract string from within quotes&quot;&quot;&quot;</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;&#39;([^&#39;]*)&#39;&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">match</span> <span class="k">else</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_parse_line</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse a line, removing comments and whitespace&quot;&quot;&quot;</span>
        <span class="c1"># Remove comments (everything after !)</span>
        <span class="k">if</span> <span class="s1">&#39;!&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">[:</span><span class="n">line</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;!&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_parse_vector</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse a vector that starts with count then values, ending with &#39;/&#39;&quot;&quot;&quot;</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unexpected end of file while reading vector&quot;</span><span class="p">)</span>

        <span class="c1"># First line is the count</span>
        <span class="n">linecount</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">_parse_line</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>

        <span class="c1"># Second line has the values</span>
        <span class="n">values_line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">values_line</span> <span class="o">=</span> <span class="n">_parse_line</span><span class="p">(</span><span class="n">values_line</span><span class="p">)</span>

        <span class="c1"># Split by &#39;/&#39; and take only the first part (before the &#39;/&#39;)</span>
        <span class="k">if</span> <span class="s1">&#39;/&#39;</span> <span class="ow">in</span> <span class="n">values_line</span><span class="p">:</span>
            <span class="n">values_line</span> <span class="o">=</span> <span class="n">values_line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="n">parts</span> <span class="o">=</span> <span class="n">values_line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">dtype</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">]</span>

        <span class="c1"># Note that we do not try to interpolate here, since Bellhop has its own routines</span>
        <span class="k">return</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">values</span><span class="p">),</span> <span class="n">linecount</span>

    <span class="k">def</span> <span class="nf">_read_ssp_points</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read sound speed profile points until we find the bottom boundary line&quot;&quot;&quot;</span>
        <span class="n">ssp_points</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="c1"># Check if this is a bottom boundary line (starts with quote)</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">):</span>
                <span class="c1"># This is the bottom boundary line, put it back</span>
                <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">break</span>

            <span class="c1"># Parse SSP point</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">_parse_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">):</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

            <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">depth</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">speed</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">ssp_points</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">depth</span><span class="p">,</span> <span class="n">speed</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="c1"># This might be the end of SSP or a different format</span>
                    <span class="c1"># Put the line back and break</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="k">break</span>

        <span class="k">return</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ssp_points</span><span class="p">)</span> <span class="k">if</span> <span class="n">ssp_points</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="c1"># Line 1: Title</span>
        <span class="n">title_line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">env</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_parse_quoted_string</span><span class="p">(</span><span class="n">title_line</span><span class="p">)</span>

        <span class="c1"># Line 2: Frequency</span>
        <span class="n">freq_line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">env</span><span class="p">[</span><span class="s1">&#39;frequency&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">_parse_line</span><span class="p">(</span><span class="n">freq_line</span><span class="p">))</span>

        <span class="c1"># Line 3: NMedia (should be 1 for BELLHOP)</span>
        <span class="n">nmedia_line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">nmedia</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">_parse_line</span><span class="p">(</span><span class="n">nmedia_line</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">nmedia</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;BELLHOP only supports 1 medium, found </span><span class="si">{</span><span class="n">nmedia</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Line 4: Top boundary options</span>
        <span class="n">topopt_line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">topopt</span> <span class="o">=</span> <span class="n">_parse_quoted_string</span><span class="p">(</span><span class="n">topopt_line</span><span class="p">)</span>

        <span class="c1"># Parse SSP interpolation type from first character</span>
        <span class="k">def</span> <span class="nf">_invalid</span><span class="p">(</span><span class="n">opt</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Interpolation option </span><span class="si">{</span><span class="n">opt</span><span class="si">!r}</span><span class="s2"> not available&quot;</span><span class="p">)</span>
        <span class="n">opt</span> <span class="o">=</span> <span class="n">topopt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">env</span><span class="p">[</span><span class="s2">&quot;soundspeed_interp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">interp_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span> <span class="ow">or</span> <span class="n">_invalid</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span>

        <span class="c1"># Top boundary condition</span>
        <span class="k">def</span> <span class="nf">_invalid</span><span class="p">(</span><span class="n">opt</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Top boundary condition option </span><span class="si">{</span><span class="n">opt</span><span class="si">!r}</span><span class="s2"> not available&quot;</span><span class="p">)</span>
        <span class="n">opt</span> <span class="o">=</span> <span class="n">topopt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">env</span><span class="p">[</span><span class="s2">&quot;top_boundary_condition&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">topbound_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span> <span class="ow">or</span> <span class="n">_invalid</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span>

        <span class="c1"># Attenuation units</span>
        <span class="k">def</span> <span class="nf">_invalid</span><span class="p">(</span><span class="n">opt</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Attenuation units option </span><span class="si">{</span><span class="n">opt</span><span class="si">!r}</span><span class="s2"> not available&quot;</span><span class="p">)</span>
        <span class="n">opt</span> <span class="o">=</span> <span class="n">topopt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">env</span><span class="p">[</span><span class="s2">&quot;attenuation_units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">attunits_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span> <span class="ow">or</span> <span class="n">_invalid</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span>

        <span class="c1"># Volume attenuation</span>
        <span class="k">def</span> <span class="nf">_invalid</span><span class="p">(</span><span class="n">opt</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Volume attenuation option </span><span class="si">{</span><span class="n">opt</span><span class="si">!r}</span><span class="s2"> not available&quot;</span><span class="p">)</span>
        <span class="n">env</span><span class="p">[</span><span class="s2">&quot;volume_attenuation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">topopt</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">opt</span> <span class="o">=</span> <span class="n">topopt</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">opt</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">env</span><span class="p">[</span><span class="s2">&quot;volume_attenuation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">volatt_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span> <span class="ow">or</span> <span class="n">_invalid</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;A&#39;</span> <span class="ow">in</span> <span class="n">topopt</span><span class="p">:</span>
            <span class="c1"># Read halfspace parameters line</span>
            <span class="n">halfspace_line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="c1"># This line contains: depth, alphaR, betaR, rho, alphaI, betaI</span>
            <span class="c1"># We skip this for now as it&#39;s not part of the standard env structure</span>

        <span class="c1"># Check for surface altimetry (indicated by * in topopt)</span>
        <span class="k">if</span> <span class="s1">&#39;*&#39;</span> <span class="ow">in</span> <span class="n">topopt</span><span class="p">:</span>
            <span class="c1"># Surface altimetry file exists - would need to read .ati file</span>
            <span class="c1"># For now, just note that surface is present</span>
            <span class="n">env</span><span class="p">[</span><span class="s1">&#39;surface&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span>  <span class="c1"># placeholder</span>

        <span class="c1"># Line 5 or 6: SSP depth specification (format: npts sigma_z max_depth)</span>
        <span class="n">ssp_spec_line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">ssp_parts</span> <span class="o">=</span> <span class="n">_parse_line</span><span class="p">(</span><span class="n">ssp_spec_line</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">env</span><span class="p">[</span><span class="s1">&#39;depth_npts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ssp_parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ssp_parts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">env</span><span class="p">[</span><span class="s1">&#39;depth_sigmaz&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ssp_parts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ssp_parts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">env</span><span class="p">[</span><span class="s1">&#39;depth_max&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ssp_parts</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">env</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ssp_parts</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

        <span class="c1"># Read SSP points</span>
        <span class="n">ssp_points</span> <span class="o">=</span> <span class="n">_read_ssp_points</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ssp_points</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">ssp_points</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ssp_points</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># Single sound speed value</span>
                <span class="n">env</span><span class="p">[</span><span class="s1">&#39;soundspeed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ssp_points</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Multiple points - depth, sound speed pairs</span>
                <span class="n">env</span><span class="p">[</span><span class="s1">&#39;soundspeed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ssp_points</span>
        <span class="n">env</span><span class="p">[</span><span class="s1">&#39;ssp_env&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ssp_points</span>

        <span class="c1"># Bottom boundary options</span>
        <span class="n">bottom_line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">bottom_parts</span> <span class="o">=</span> <span class="n">_parse_line</span><span class="p">(</span><span class="n">bottom_line</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bottom_parts</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">bottom_opt</span> <span class="o">=</span> <span class="n">_parse_quoted_string</span><span class="p">(</span><span class="n">bottom_parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">env</span><span class="p">[</span><span class="s1">&#39;bottom_roughness&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">bottom_parts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

            <span class="c1"># Check for bathymetry file (indicated by * in bottom option)</span>
            <span class="k">if</span> <span class="s1">&#39;*&#39;</span> <span class="ow">in</span> <span class="n">bottom_opt</span><span class="p">:</span>
                <span class="c1"># Bathymetry file exists - would need to read .bty file</span>
                <span class="c1"># For now, note that depth is range-dependent</span>
                <span class="k">pass</span>

        <span class="c1"># Bottom properties (depth, sound_speed, density, absorption)</span>
        <span class="n">bottom_props_line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">bottom_props_line</span> <span class="o">=</span> <span class="n">_parse_line</span><span class="p">(</span><span class="n">bottom_props_line</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bottom_props_line</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">):</span>
            <span class="n">bottom_props_line</span> <span class="o">=</span> <span class="n">bottom_props_line</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="n">bottom_props</span> <span class="o">=</span> <span class="n">bottom_props_line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="c1"># fortran sources say: &quot;z, alphaR, betaR, rhoR, alphaI, betaI&quot;</span>
        <span class="c1"># docs say:</span>
        <span class="c1">#       Syntax:</span>
        <span class="c1">#</span>
        <span class="c1">#       ZB  CPB  CSB  RHOB  APB  ASB</span>
        <span class="c1">#</span>
        <span class="c1">#       Description:</span>
        <span class="c1">#</span>
        <span class="c1">#       ZB:   Depth (m).</span>
        <span class="c1">#       CPB:  Bottom P-wave speed (m/s).</span>
        <span class="c1">#       CSB:  Bottom S-wave speed (m/s).</span>
        <span class="c1">#       RHOB: Bottom density (g/cm3).</span>
        <span class="c1">#       APB:  Bottom P-wave attenuation. (units as given by TOPOPT(3:3) )</span>
        <span class="c1">#       ASB:  Bottom S-wave attenuation. (  &quot;   &quot;    &quot;    &quot;   &quot;   &quot;     )</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bottom_props</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">env</span><span class="p">[</span><span class="s1">&#39;bottom_soundspeed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">bottom_props</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bottom_props</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">env</span><span class="p">[</span><span class="s1">&#39;bottom_soundspeed_shear&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">bottom_props</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bottom_props</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">env</span><span class="p">[</span><span class="s1">&#39;bottom_density&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">bottom_props</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">*</span> <span class="mi">1000</span>  <span class="c1"># convert from g/cm³ to kg/m³</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bottom_props</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">env</span><span class="p">[</span><span class="s1">&#39;bottom_absorption&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">bottom_props</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bottom_props</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">env</span><span class="p">[</span><span class="s1">&#39;bottom_absorption_shear&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">bottom_props</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>

        <span class="c1"># Source depths</span>
        <span class="n">tx_depths</span><span class="p">,</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;tx_ndepth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_parse_vector</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tx_depths</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">env</span><span class="p">[</span><span class="s1">&#39;tx_depth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tx_depths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">env</span><span class="p">[</span><span class="s1">&#39;tx_depth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tx_depths</span>

        <span class="c1"># Receiver depths</span>
        <span class="n">rx_depths</span><span class="p">,</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;rx_ndepth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_parse_vector</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rx_depths</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">env</span><span class="p">[</span><span class="s1">&#39;rx_depth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rx_depths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">env</span><span class="p">[</span><span class="s1">&#39;rx_depth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rx_depths</span>

        <span class="c1"># Receiver ranges (in km, need to convert to m)</span>
        <span class="n">rx_ranges</span><span class="p">,</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;rx_nrange&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_parse_vector</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">env</span><span class="p">[</span><span class="s1">&#39;rx_range&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rx_ranges</span> <span class="o">*</span> <span class="mi">1000</span>  <span class="c1"># convert km to m</span>

        <span class="c1"># Task/run type (e.g., &#39;R&#39;, &#39;C&#39;, etc.)</span>
        <span class="n">task_line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">task_code</span> <span class="o">=</span> <span class="n">_parse_quoted_string</span><span class="p">(</span><span class="n">task_line</span><span class="p">)</span>
        <span class="n">env</span><span class="p">[</span><span class="s1">&#39;task&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">task_code</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">task_code</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">env</span><span class="p">[</span><span class="s1">&#39;beam_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">beam_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">task_code</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">task_code</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">env</span><span class="p">[</span><span class="s1">&#39;tx_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">source_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">task_code</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">task_code</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">env</span><span class="p">[</span><span class="s1">&#39;grid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grid_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">task_code</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>

        <span class="c1"># Check for source directionality (indicated by * in task code)</span>
        <span class="k">if</span> <span class="s1">&#39;*&#39;</span> <span class="ow">in</span> <span class="n">task_code</span><span class="p">:</span>
            <span class="c1"># Source directionality file exists - would need to read .sbp file</span>
            <span class="c1"># For now, just note that directionality is present</span>
            <span class="n">env</span><span class="p">[</span><span class="s1">&#39;tx_directionality&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span>  <span class="c1"># placeholder</span>

        <span class="c1"># Number of beams</span>
        <span class="n">nbeams_line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">env</span><span class="p">[</span><span class="s1">&#39;nbeams&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">_parse_line</span><span class="p">(</span><span class="n">nbeams_line</span><span class="p">))</span>

        <span class="c1"># Beam angles (min_angle, max_angle)</span>
        <span class="n">angles_line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">angles_line</span> <span class="o">=</span> <span class="n">_parse_line</span><span class="p">(</span><span class="n">angles_line</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">angles_line</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">):</span>
            <span class="n">angles_line</span> <span class="o">=</span> <span class="n">angles_line</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="n">angle_parts</span> <span class="o">=</span> <span class="n">angles_line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">angle_parts</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">env</span><span class="p">[</span><span class="s1">&#39;min_angle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">angle_parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">env</span><span class="p">[</span><span class="s1">&#39;max_angle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">angle_parts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># Ray tracing limits (step, max_depth, max_range) - last line</span>
        <span class="n">limits_line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">limits_line</span> <span class="o">=</span> <span class="n">_parse_line</span><span class="p">(</span><span class="n">limits_line</span><span class="p">)</span>
        <span class="n">limits_parts</span> <span class="o">=</span> <span class="n">limits_line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">env</span><span class="p">[</span><span class="s1">&#39;step_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">limits_parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">env</span><span class="p">[</span><span class="s1">&#39;box_depth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">limits_parts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">env</span><span class="p">[</span><span class="s1">&#39;box_range&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1000</span><span class="o">*</span><span class="nb">float</span><span class="p">(</span><span class="n">limits_parts</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">env</span></div>


<div class="viewcode-block" id="read_ssp">
<a class="viewcode-back" href="../../index.html#bellhop.bellhop.read_ssp">[docs]</a>
<span class="k">def</span> <span class="nf">read_ssp</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Read a 2D sound speed profile (.ssp) file used by BELLHOP.</span>

<span class="sd">    This function reads BELLHOP&#39;s .ssp files which contain range-dependent</span>
<span class="sd">    sound speed profiles. The file format is:</span>
<span class="sd">    - Line 1: Number of range profiles (NPROFILES)</span>
<span class="sd">    - Line 2: Range coordinates in km (space-separated)</span>
<span class="sd">    - Line 3+: Sound speed values, one line per depth point across all ranges</span>

<span class="sd">    :param fname: path to .ssp file (with or without .ssp extension)</span>
<span class="sd">    :returns: for single-profile files: numpy array with [depth, soundspeed] pairs;</span>
<span class="sd">              for multi-profile files: pandas DataFrame with range-dependent sound speed data</span>

<span class="sd">    **Return format:**</span>

<span class="sd">    - **Single-profile files (1 range)**: Returns a 2D numpy array with [depth, soundspeed] pairs,</span>
<span class="sd">      compatible with create_env2d() soundspeed parameter.</span>

<span class="sd">    - **Multi-profile files (&gt;1 ranges)**: Returns a pandas DataFrame where:</span>

<span class="sd">      - **Columns**: Range coordinates (in meters, converted from km in file)</span>
<span class="sd">      - **Index**: Depth indices (0, 1, 2, ... for each depth level in the file)</span>
<span class="sd">      - **Values**: Sound speeds (m/s)</span>

<span class="sd">      This DataFrame can be directly assigned to create_env2d() soundspeed parameter</span>
<span class="sd">      for range-dependent acoustic modeling.</span>

<span class="sd">    **Note on depths**: For multi-profile files, depth indices are used (0, 1, 2, ...)</span>
<span class="sd">    since the actual depth coordinates come from the associated BELLHOP .env file.</span>
<span class="sd">    Users can modify the DataFrame index if actual depth values are known.</span>

<span class="sd">    **Examples:**</span>

<span class="sd">    &gt;&gt;&gt; import bellhop as bh</span>
<span class="sd">    &gt;&gt;&gt; # Single-profile file</span>
<span class="sd">    &gt;&gt;&gt; ssp1 = bh.read_ssp(&quot;single_profile.ssp&quot;)  # Returns numpy array</span>
<span class="sd">    &gt;&gt;&gt; env = bh.create_env2d()</span>
<span class="sd">    &gt;&gt;&gt; env[&quot;soundspeed&quot;] = ssp1</span>
<span class="sd">    &gt;&gt;&gt;</span>
<span class="sd">    &gt;&gt;&gt; # Multi-profile file</span>
<span class="sd">    &gt;&gt;&gt; ssp2 = bh.read_ssp(&quot;tests/MunkB_geo_rot/MunkB_geo_rot.ssp&quot;)  # Returns DataFrame</span>
<span class="sd">    &gt;&gt;&gt; env = bh.create_env2d()</span>
<span class="sd">    &gt;&gt;&gt; env[&quot;soundspeed&quot;] = ssp2  # Range-dependent sound speed</span>

<span class="sd">    **File format example:**</span>

<span class="sd">    ::</span>

<span class="sd">        30</span>
<span class="sd">        -50 -5 -1 -.8 -.75 -.6 -.4 -.2 0 0.2 0.4 0.6 0.8 1.0 1.2 1.4 1.6 1.8 2.0 2.2 2.4 2.6 2.8 3.0 3.2 3.4 3.6 3.8 4.0 10.0</span>
<span class="sd">        1500 1500 1548.52 1530.29 1526.69 1517.78 1509.49 1504.30 1501.38 1500.14 1500.12 1501.02 1502.57 1504.62 1507.02 1509.69 1512.55 1515.56 1518.67 1521.85 1525.10 1528.38 1531.70 1535.04 1538.39 1541.76 1545.14 1548.52 1551.91 1551.91</span>
<span class="sd">        1500 1500 1548.52 1530.29 1526.69 1517.78 1509.49 1504.30 1501.38 1500.14 1500.12 1501.02 1502.57 1504.62 1507.02 1509.69 1512.55 1515.56 1518.67 1521.85 1525.10 1528.38 1531.70 1535.04 1538.39 1541.76 1545.14 1548.52 1551.91 1551.91</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">os</span>

    <span class="c1"># Add .ssp extension if not present</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">fname</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.ssp&#39;</span><span class="p">):</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">fname</span> <span class="o">+</span> <span class="s1">&#39;.ssp&#39;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SSP file not found: </span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="c1"># Read number of range profiles</span>
        <span class="n">nprofiles</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>

        <span class="c1"># Read range coordinates (in km)</span>
        <span class="n">range_line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">ranges</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">range_line</span><span class="o">.</span><span class="n">split</span><span class="p">()])</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ranges</span><span class="p">)</span> <span class="o">!=</span> <span class="n">nprofiles</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expected </span><span class="si">{</span><span class="n">nprofiles</span><span class="si">}</span><span class="s2"> range profiles, but found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ranges</span><span class="p">)</span><span class="si">}</span><span class="s2"> ranges&quot;</span><span class="p">)</span>

        <span class="c1"># Read sound speed data - read all remaining lines as a matrix</span>
        <span class="n">ssp_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">line</span><span class="p">:</span>  <span class="c1"># Skip empty lines</span>
                <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">==</span> <span class="n">nprofiles</span><span class="p">:</span>
                    <span class="n">ssp_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>

        <span class="n">ssp_array</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ssp_data</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ssp_array</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No sound speed data found in file&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">nprofiles</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Single profile - return as [depth, soundspeed] pairs for backward compatibility</span>
            <span class="c1"># Create depth values - linearly spaced from 0 to number of depth points</span>
            <span class="n">ndepths</span> <span class="o">=</span> <span class="n">ssp_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">depths</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ndepths</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ndepths</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">_np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">([</span><span class="n">depths</span><span class="p">,</span> <span class="n">ssp_array</span><span class="o">.</span><span class="n">flatten</span><span class="p">()])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Multiple ranges - return as pandas DataFrame for range-dependent modeling</span>
            <span class="c1"># Convert ranges from km to meters (as expected by create_env2d)</span>
            <span class="n">ranges_m</span> <span class="o">=</span> <span class="n">ranges</span> <span class="o">*</span> <span class="mi">1000</span>

            <span class="c1"># Create depth indices (actual depths would come from associated .env file)</span>
            <span class="n">ndepths</span> <span class="o">=</span> <span class="n">ssp_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">depths</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ndepths</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

            <span class="c1"># Create DataFrame with ranges as columns and depths as index</span>
            <span class="c1"># ssp_array is [ndepths, nprofiles] which is the correct orientation</span>
            <span class="k">return</span> <span class="n">_pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">ssp_array</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">depths</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">ranges_m</span><span class="p">)</span></div>


<div class="viewcode-block" id="read_bty">
<a class="viewcode-back" href="../../index.html#bellhop.bellhop.read_bty">[docs]</a>
<span class="k">def</span> <span class="nf">read_bty</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Read a bathymetry (.bty) file used by BELLHOP.</span>

<span class="sd">    This function reads BELLHOP&#39;s .bty files which define the bottom depth</span>
<span class="sd">    profile. The file format is:</span>
<span class="sd">    - Line 1: Interpolation type (&#39;L&#39; for linear, &#39;C&#39; for curvilinear)</span>
<span class="sd">    - Line 2: Number of points</span>
<span class="sd">    - Line 3+: Range (km) and depth (m) pairs</span>

<span class="sd">    :param fname: path to .bty file (with or without .bty extension)</span>
<span class="sd">    :returns: numpy array with [range, depth] pairs compatible with create_env2d()</span>

<span class="sd">    The returned array can be assigned to env[&quot;depth&quot;] for range-dependent bathymetry.</span>

<span class="sd">    **Examples:**</span>

<span class="sd">    &gt;&gt;&gt; import bellhop as bh</span>
<span class="sd">    &gt;&gt;&gt; bty = bh.read_bty(&quot;tests/MunkB_geo_rot/MunkB_geo_rot.bty&quot;)</span>
<span class="sd">    &gt;&gt;&gt; env = bh.create_env2d()</span>
<span class="sd">    &gt;&gt;&gt; env[&quot;depth&quot;] = bty</span>
<span class="sd">    &gt;&gt;&gt; arrivals = bh.calculate_arrivals(env)</span>

<span class="sd">    **File format example:**</span>

<span class="sd">    ::</span>

<span class="sd">        &#39;L&#39;</span>
<span class="sd">        5</span>
<span class="sd">        0 3000</span>
<span class="sd">        10 3000</span>
<span class="sd">        20 500</span>
<span class="sd">        30 3000</span>
<span class="sd">        100 3000</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">os</span>

    <span class="c1"># Add .bty extension if not present</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">fname</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.bty&#39;</span><span class="p">):</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">fname</span> <span class="o">+</span> <span class="s1">&#39;.bty&#39;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;BTY file not found: </span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="c1"># Read interpolation type (usually &#39;L&#39; or &#39;C&#39;)</span>
        <span class="n">interp_type</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Read number of points</span>
        <span class="n">npoints</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>

        <span class="c1"># Read range,depth pairs</span>
        <span class="n">ranges</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">depths</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npoints</span><span class="p">):</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">line</span><span class="p">:</span>  <span class="c1"># Skip empty lines</span>
                <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">ranges</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>  <span class="c1"># Range in km</span>
                    <span class="n">depths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>  <span class="c1"># Depth in m</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ranges</span><span class="p">)</span> <span class="o">!=</span> <span class="n">npoints</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expected </span><span class="si">{</span><span class="n">npoints</span><span class="si">}</span><span class="s2"> bathymetry points, but found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ranges</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Convert ranges from km to m for consistency with bellhop env structure</span>
        <span class="n">ranges_m</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ranges</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
        <span class="n">depths_array</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">depths</span><span class="p">)</span>

        <span class="c1"># Return as [range, depth] pairs</span>
        <span class="k">return</span> <span class="n">_np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">([</span><span class="n">ranges_m</span><span class="p">,</span> <span class="n">depths_array</span><span class="p">])</span></div>


<div class="viewcode-block" id="check_env2d">
<a class="viewcode-back" href="../../index.html#bellhop.bellhop.check_env2d">[docs]</a>
<span class="k">def</span> <span class="nf">check_env2d</span><span class="p">(</span><span class="n">env</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check the validity of a 2D underwater environment definition.</span>

<span class="sd">    :param env: environment definition</span>

<span class="sd">    Exceptions are thrown with appropriate error messages if the environment is invalid.</span>

<span class="sd">    &gt;&gt;&gt; import arlpy.uwapm as pm</span>
<span class="sd">    &gt;&gt;&gt; env = pm.create_env2d()</span>
<span class="sd">    &gt;&gt;&gt; check_env2d(env)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;2D&#39;</span><span class="p">,</span> <span class="s1">&#39;Not a 2D environment&#39;</span>
        <span class="n">max_range</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;rx_range&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;surface&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">_np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;surface&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;surface must be an Nx2 array&#39;</span>
            <span class="k">assert</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;surface&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;surface must be a scalar or an Nx2 array&#39;</span>
            <span class="k">assert</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;surface&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;surface must be a scalar or an Nx2 array&#39;</span>
            <span class="k">assert</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;surface&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;First range in surface array must be 0 m&#39;</span>
            <span class="k">assert</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;surface&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">max_range</span><span class="p">,</span> <span class="s1">&#39;Last range in surface array must be beyond maximum range: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">max_range</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; m&#39;</span>
            <span class="k">assert</span> <span class="n">_np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;surface&#39;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span> <span class="s1">&#39;surface array must be strictly monotonic in range&#39;</span>
            <span class="k">assert</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;surface_interp&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">curvilinear</span> <span class="ow">or</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;surface_interp&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">linear</span><span class="p">,</span> <span class="s1">&#39;Invalid interpolation type: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;surface_interp&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">_np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;depth must be a scalar or an Nx2 array&#39;</span>
            <span class="k">assert</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;depth must be a scalar or an Nx2 array&#39;</span>
            <span class="k">assert</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;First range in depth array must be 0 m&#39;</span>
            <span class="k">assert</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">max_range</span><span class="p">,</span> <span class="s1">&#39;Last range in depth array must be beyond maximum range: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">max_range</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; m&#39;</span>
            <span class="k">assert</span> <span class="n">_np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span> <span class="s1">&#39;Depth array must be strictly monotonic in range&#39;</span>
            <span class="k">assert</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;depth_interp&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">curvilinear</span> <span class="ow">or</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;depth_interp&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">linear</span><span class="p">,</span> <span class="s1">&#39;Invalid interpolation type: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;depth_interp&#39;</span><span class="p">])</span>
            <span class="n">max_depth</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">][:,</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">max_depth</span> <span class="o">=</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;soundspeed&#39;</span><span class="p">],</span> <span class="n">_pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="c1"># For DataFrames, apply the same minimum point requirements as numpy arrays</span>
            <span class="k">if</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;soundspeed_interp&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;spline&#39;</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;soundspeed&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;soundspeed profile must have at least 4 points for spline interpolation&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;soundspeed&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;soundspeed profile must have at least 2 points&#39;</span>
            <span class="k">assert</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;soundspeed&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;First depth in soundspeed array must be 0 m&#39;</span>
            <span class="k">assert</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;soundspeed&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">max_depth</span><span class="p">,</span> <span class="s1">&#39;Last depth in soundspeed array must be beyond water depth: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">max_depth</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; m&#39;</span>
            <span class="k">assert</span> <span class="n">_np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;soundspeed&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span> <span class="s1">&#39;Soundspeed array must be strictly monotonic in depth&#39;</span>
        <span class="k">elif</span> <span class="n">_np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;soundspeed&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;soundspeed&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;soundspeed must be a scalar or an Nx2 array&#39;</span>
            <span class="k">assert</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;soundspeed&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;soundspeed must be a scalar or an Nx2 array&#39;</span>
            <span class="c1"># Minimum points depend on interpolation type</span>
            <span class="k">if</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;soundspeed_interp&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;spline&#39;</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;soundspeed&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;soundspeed profile must have at least 4 points for spline interpolation&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;soundspeed&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;soundspeed profile must have at least 2 points&#39;</span>
            <span class="k">assert</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;soundspeed&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;First depth in soundspeed array must be 0 m&#39;</span>
            <span class="k">assert</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;soundspeed&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">max_depth</span><span class="p">,</span> <span class="s1">&#39;Last depth in soundspeed array must be beyond water depth: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">max_depth</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; m&#39;</span>
            <span class="k">assert</span> <span class="n">_np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;soundspeed&#39;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span> <span class="s1">&#39;Soundspeed array must be strictly monotonic in depth&#39;</span>
            <span class="k">assert</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;soundspeed_interp&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">interp_rev</span><span class="p">,</span> <span class="s1">&#39;Invalid interpolation type: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;soundspeed_interp&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">max_depth</span> <span class="ow">in</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;soundspeed&#39;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">indlarger</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;soundspeed&#39;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="n">max_depth</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;soundspeed_interp&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">spline</span><span class="p">:</span>
                    <span class="n">tck</span> <span class="o">=</span> <span class="n">_interp</span><span class="o">.</span><span class="n">splrep</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;soundspeed&#39;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;soundspeed&#39;</span><span class="p">][:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">insert_ss_val</span> <span class="o">=</span> <span class="n">_interp</span><span class="o">.</span><span class="n">splev</span><span class="p">(</span><span class="n">max_depth</span><span class="p">,</span> <span class="n">tck</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">insert_ss_val</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">max_depth</span><span class="p">,</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;soundspeed&#39;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;soundspeed&#39;</span><span class="p">][:,</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">env</span><span class="p">[</span><span class="s1">&#39;soundspeed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;soundspeed&#39;</span><span class="p">],</span><span class="n">indlarger</span><span class="p">,[</span><span class="n">max_depth</span><span class="p">,</span><span class="n">insert_ss_val</span><span class="p">],</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">env</span><span class="p">[</span><span class="s1">&#39;soundspeed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;soundspeed&#39;</span><span class="p">][:</span><span class="n">indlarger</span><span class="o">+</span><span class="mi">1</span><span class="p">,:]</span>
        <span class="k">assert</span> <span class="n">_np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;tx_depth&#39;</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="n">max_depth</span><span class="p">,</span> <span class="s1">&#39;tx_depth cannot exceed water depth: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">max_depth</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; m&#39;</span>
        <span class="k">assert</span> <span class="n">_np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;rx_depth&#39;</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="n">max_depth</span><span class="p">,</span> <span class="s1">&#39;rx_depth cannot exceed water depth: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">max_depth</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; m&#39;</span>
        <span class="k">assert</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;min_angle&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">180</span> <span class="ow">and</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;min_angle&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">180</span><span class="p">,</span> <span class="s1">&#39;min_angle must be in range (-180, 180)&#39;</span>
        <span class="k">assert</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;max_angle&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">180</span> <span class="ow">and</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;max_angle&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">180</span><span class="p">,</span> <span class="s1">&#39;max_angle must be in range (-180, 180)&#39;</span>
        <span class="k">if</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;tx_directionality&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">_np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;tx_directionality&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;tx_directionality must be an Nx2 array&#39;</span>
            <span class="k">assert</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;tx_directionality&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;tx_directionality must be an Nx2 array&#39;</span>
            <span class="k">assert</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;tx_directionality&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;tx_directionality must be an Nx2 array&#39;</span>
            <span class="k">assert</span> <span class="n">_np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;tx_directionality&#39;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mi">180</span><span class="p">)</span> <span class="ow">and</span> <span class="n">_np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;tx_directionality&#39;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">180</span><span class="p">),</span> <span class="s1">&#39;tx_directionality angles must be in [-90, 90]&#39;</span>
        <span class="k">return</span> <span class="n">env</span>
    <span class="k">except</span> <span class="ne">AssertionError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span></div>


<div class="viewcode-block" id="print_env">
<a class="viewcode-back" href="../../index.html#bellhop.bellhop.print_env">[docs]</a>
<span class="k">def</span> <span class="nf">print_env</span><span class="p">(</span><span class="n">env</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Display the environment in a human readable form.</span>

<span class="sd">    :param env: environment definition</span>

<span class="sd">    &gt;&gt;&gt; import arlpy.uwapm as pm</span>
<span class="sd">    &gt;&gt;&gt; env = pm.create_env2d(depth=40, soundspeed=1540)</span>
<span class="sd">    &gt;&gt;&gt; pm.print_env(env)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">env</span> <span class="o">=</span> <span class="n">check_env2d</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="o">-</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
        <span class="n">v</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
        <span class="k">if</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%20s</span><span class="s1"> : &#39;</span><span class="o">%</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">v1</span> <span class="ow">in</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%20s</span><span class="s1">   &#39;</span><span class="o">%</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">v1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%20s</span><span class="s1"> : &#39;</span><span class="o">%</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">v</span><span class="p">)</span></div>


<div class="viewcode-block" id="plot_env">
<a class="viewcode-back" href="../../index.html#bellhop.bellhop.plot_env">[docs]</a>
<span class="k">def</span> <span class="nf">plot_env</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">surface_color</span><span class="o">=</span><span class="s1">&#39;dodgerblue&#39;</span><span class="p">,</span> <span class="n">bottom_color</span><span class="o">=</span><span class="s1">&#39;peru&#39;</span><span class="p">,</span> <span class="n">tx_color</span><span class="o">=</span><span class="s1">&#39;orangered&#39;</span><span class="p">,</span> <span class="n">rx_color</span><span class="o">=</span><span class="s1">&#39;midnightblue&#39;</span><span class="p">,</span> <span class="n">rx_plot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plots a visual representation of the environment.</span>

<span class="sd">    :param env: environment description</span>
<span class="sd">    :param surface_color: color of the surface (see `Bokeh colors &lt;https://bokeh.pydata.org/en/latest/docs/reference/colors.html&gt;`_)</span>
<span class="sd">    :param bottom_color: color of the bottom (see `Bokeh colors &lt;https://bokeh.pydata.org/en/latest/docs/reference/colors.html&gt;`_)</span>
<span class="sd">    :param tx_color: color of transmitters (see `Bokeh colors &lt;https://bokeh.pydata.org/en/latest/docs/reference/colors.html&gt;`_)</span>
<span class="sd">    :param rx_color: color of receviers (see `Bokeh colors &lt;https://bokeh.pydata.org/en/latest/docs/reference/colors.html&gt;`_)</span>
<span class="sd">    :param rx_plot: True to plot all receivers, False to not plot any receivers, None to automatically decide</span>

<span class="sd">    Other keyword arguments applicable for `arlpy.plot.plot()` are also supported.</span>

<span class="sd">    The surface, bottom, transmitters (marker: &#39;*&#39;) and receivers (marker: &#39;o&#39;)</span>
<span class="sd">    are plotted in the environment. If `rx_plot` is set to None and there are</span>
<span class="sd">    more than 2000 receivers, they are not plotted.</span>

<span class="sd">    &gt;&gt;&gt; import arlpy.uwapm as pm</span>
<span class="sd">    &gt;&gt;&gt; env = pm.create_env2d(depth=[[0, 40], [100, 30], [500, 35], [700, 20], [1000,45]])</span>
<span class="sd">    &gt;&gt;&gt; pm.plot_env(env)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">env</span> <span class="o">=</span> <span class="n">check_env2d</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="n">min_x</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">max_x</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;rx_range&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">max_x</span><span class="o">-</span><span class="n">min_x</span> <span class="o">&gt;</span> <span class="mi">10000</span><span class="p">:</span>
        <span class="n">divisor</span> <span class="o">=</span> <span class="mi">1000</span>
        <span class="n">min_x</span> <span class="o">/=</span> <span class="n">divisor</span>
        <span class="n">max_x</span> <span class="o">/=</span> <span class="n">divisor</span>
        <span class="n">xlabel</span> <span class="o">=</span> <span class="s1">&#39;Range (km)&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">divisor</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">xlabel</span> <span class="o">=</span> <span class="s1">&#39;Range (m)&#39;</span>
    <span class="k">if</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;surface&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">min_y</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">min_y</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;surface&#39;</span><span class="p">][:,</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">_np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">max_y</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">][:,</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">max_y</span> <span class="o">=</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">]</span>
    <span class="n">mgn_x</span> <span class="o">=</span> <span class="mf">0.01</span><span class="o">*</span><span class="p">(</span><span class="n">max_x</span><span class="o">-</span><span class="n">min_x</span><span class="p">)</span>
    <span class="n">mgn_y</span> <span class="o">=</span> <span class="mf">0.1</span><span class="o">*</span><span class="p">(</span><span class="n">max_y</span><span class="o">-</span><span class="n">min_y</span><span class="p">)</span>
    <span class="n">oh</span> <span class="o">=</span> <span class="n">_plt</span><span class="o">.</span><span class="n">hold</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;surface&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">min_x</span><span class="p">,</span> <span class="n">max_x</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">xlabel</span><span class="o">=</span><span class="n">xlabel</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Depth (m)&#39;</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="n">min_x</span><span class="o">-</span><span class="n">mgn_x</span><span class="p">,</span> <span class="n">max_x</span><span class="o">+</span><span class="n">mgn_x</span><span class="p">),</span> <span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="n">max_y</span><span class="o">-</span><span class="n">mgn_y</span><span class="p">,</span> <span class="o">-</span><span class="n">min_y</span><span class="o">+</span><span class="n">mgn_y</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="n">surface_color</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># linear and curvilinear options use the same altimetry, just with different normals</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;surface&#39;</span><span class="p">]</span>
        <span class="n">_plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">s</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">divisor</span><span class="p">,</span> <span class="o">-</span><span class="n">s</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">xlabel</span><span class="o">=</span><span class="n">xlabel</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Depth (m)&#39;</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="n">min_x</span><span class="o">-</span><span class="n">mgn_x</span><span class="p">,</span> <span class="n">max_x</span><span class="o">+</span><span class="n">mgn_x</span><span class="p">),</span> <span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="n">max_y</span><span class="o">-</span><span class="n">mgn_y</span><span class="p">,</span> <span class="o">-</span><span class="n">min_y</span><span class="o">+</span><span class="n">mgn_y</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="n">surface_color</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">_plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">min_x</span><span class="p">,</span> <span class="n">max_x</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">],</span> <span class="o">-</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">]],</span> <span class="n">color</span><span class="o">=</span><span class="n">bottom_color</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># linear and curvilinear options use the same bathymetry, just with different normals</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">]</span>
        <span class="n">_plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">s</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">divisor</span><span class="p">,</span> <span class="o">-</span><span class="n">s</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">bottom_color</span><span class="p">)</span>
    <span class="n">txd</span> <span class="o">=</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;tx_depth&#39;</span><span class="p">]</span>
    <span class="n">_plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">_np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">txd</span><span class="p">),</span> <span class="o">-</span><span class="n">txd</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">tx_color</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rx_plot</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">rx_plot</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;rx_depth&#39;</span><span class="p">])</span><span class="o">*</span><span class="n">_np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;rx_range&#39;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">2000</span>
    <span class="k">if</span> <span class="n">rx_plot</span><span class="p">:</span>
        <span class="n">rxr</span> <span class="o">=</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;rx_range&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">_np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">rxr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">rxr</span> <span class="o">=</span> <span class="p">[</span><span class="n">rxr</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rxr</span><span class="p">):</span>
            <span class="n">rxd</span> <span class="o">=</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;rx_depth&#39;</span><span class="p">]</span>
            <span class="n">_plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">r</span><span class="o">/</span><span class="n">divisor</span><span class="p">]</span><span class="o">*</span><span class="n">_np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">rxd</span><span class="p">),</span> <span class="o">-</span><span class="n">rxd</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">rx_color</span><span class="p">)</span>
    <span class="n">_plt</span><span class="o">.</span><span class="n">hold</span><span class="p">(</span><span class="n">oh</span><span class="p">)</span></div>


<div class="viewcode-block" id="plot_ssp">
<a class="viewcode-back" href="../../index.html#bellhop.bellhop.plot_ssp">[docs]</a>
<span class="k">def</span> <span class="nf">plot_ssp</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plots the sound speed profile.</span>

<span class="sd">    :param env: environment description</span>

<span class="sd">    Other keyword arguments applicable for `arlpy.plot.plot()` are also supported.</span>

<span class="sd">    If the sound speed profile is range-dependent, this function only plots the first profile.</span>

<span class="sd">    &gt;&gt;&gt; import arlpy.uwapm as pm</span>
<span class="sd">    &gt;&gt;&gt; env = pm.create_env2d(soundspeed=[[ 0, 1540], [10, 1530], [20, 1532], [25, 1533], [30, 1535]])</span>
<span class="sd">    &gt;&gt;&gt; pm.plot_ssp(env)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">env</span> <span class="o">=</span> <span class="n">check_env2d</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="n">svp</span> <span class="o">=</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;soundspeed&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">svp</span><span class="p">,</span> <span class="n">_pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="n">svp</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">svp</span><span class="o">.</span><span class="n">index</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">_np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">svp</span><span class="p">)))</span>
    <span class="k">if</span> <span class="n">_np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">svp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">_np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">max_y</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">][:,</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">max_y</span> <span class="o">=</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">]</span>
        <span class="n">_plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">svp</span><span class="p">,</span> <span class="n">svp</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">max_y</span><span class="p">],</span> <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Soundspeed (m/s)&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Depth (m)&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;soundspeed_interp&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">spline</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">svp</span>
        <span class="n">ynew</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">svp</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]),</span> <span class="n">_np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">svp</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]),</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">tck</span> <span class="o">=</span> <span class="n">_interp</span><span class="o">.</span><span class="n">splrep</span><span class="p">(</span><span class="n">svp</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">svp</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">xnew</span> <span class="o">=</span> <span class="n">_interp</span><span class="o">.</span><span class="n">splev</span><span class="p">(</span><span class="n">ynew</span><span class="p">,</span> <span class="n">tck</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">_plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xnew</span><span class="p">,</span> <span class="o">-</span><span class="n">ynew</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Soundspeed (m/s)&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Depth (m)&#39;</span><span class="p">,</span> <span class="n">hold</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">_plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">svp</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="o">-</span><span class="n">svp</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">_plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">svp</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="o">-</span><span class="n">svp</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Soundspeed (m/s)&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Depth (m)&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="compute_arrivals">
<a class="viewcode-back" href="../../index.html#bellhop.bellhop.compute_arrivals">[docs]</a>
<span class="k">def</span> <span class="nf">compute_arrivals</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fname_base</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute arrivals between each transmitter and receiver.</span>

<span class="sd">    :param env: environment definition</span>
<span class="sd">    :param model: propagation model to use (None to auto-select)</span>
<span class="sd">    :param debug: generate debug information for propagation model</span>
<span class="sd">    :param fname_base: base file name for Bellhop working files, default (None), creates a temporary file</span>
<span class="sd">    :returns: arrival times and coefficients for all transmitter-receiver combinations</span>

<span class="sd">    &gt;&gt;&gt; import arlpy.uwapm as pm</span>
<span class="sd">    &gt;&gt;&gt; env = pm.create_env2d()</span>
<span class="sd">    &gt;&gt;&gt; arrivals = pm.compute_arrivals(env)</span>
<span class="sd">    &gt;&gt;&gt; pm.plot_arrivals(arrivals)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">env</span> <span class="o">=</span> <span class="n">check_env2d</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span> <span class="o">=</span> <span class="n">_select_model</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">arrivals</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[DEBUG] Model: &#39;</span><span class="o">+</span><span class="n">model_name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">arrivals</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">fname_base</span><span class="p">)</span></div>


<div class="viewcode-block" id="compute_eigenrays">
<a class="viewcode-back" href="../../index.html#bellhop.bellhop.compute_eigenrays">[docs]</a>
<span class="k">def</span> <span class="nf">compute_eigenrays</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">tx_depth_ndx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">rx_depth_ndx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">rx_range_ndx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fname_base</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute eigenrays between a given transmitter and receiver.</span>

<span class="sd">    :param env: environment definition</span>
<span class="sd">    :param tx_depth_ndx: transmitter depth index</span>
<span class="sd">    :param rx_depth_ndx: receiver depth index</span>
<span class="sd">    :param rx_range_ndx: receiver range index</span>
<span class="sd">    :param model: propagation model to use (None to auto-select)</span>
<span class="sd">    :param debug: generate debug information for propagation model</span>
<span class="sd">    :param fname_base: base file name for Bellhop working files, default (None), creates a temporary file</span>
<span class="sd">    :returns: eigenrays paths</span>

<span class="sd">    &gt;&gt;&gt; import arlpy.uwapm as pm</span>
<span class="sd">    &gt;&gt;&gt; env = pm.create_env2d()</span>
<span class="sd">    &gt;&gt;&gt; rays = pm.compute_eigenrays(env)</span>
<span class="sd">    &gt;&gt;&gt; pm.plot_rays(rays, width=1000)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">env</span> <span class="o">=</span> <span class="n">check_env2d</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="n">env</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">_np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;tx_depth&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">env</span><span class="p">[</span><span class="s1">&#39;tx_depth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;tx_depth&#39;</span><span class="p">][</span><span class="n">tx_depth_ndx</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">_np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;rx_depth&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">env</span><span class="p">[</span><span class="s1">&#39;rx_depth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;rx_depth&#39;</span><span class="p">][</span><span class="n">rx_depth_ndx</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">_np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;rx_range&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">env</span><span class="p">[</span><span class="s1">&#39;rx_range&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;rx_range&#39;</span><span class="p">][</span><span class="n">rx_range_ndx</span><span class="p">]</span>
    <span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span> <span class="o">=</span> <span class="n">_select_model</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">eigenrays</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[DEBUG] Model: &#39;</span><span class="o">+</span><span class="n">model_name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">eigenrays</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">fname_base</span><span class="p">)</span></div>


<div class="viewcode-block" id="compute_rays">
<a class="viewcode-back" href="../../index.html#bellhop.bellhop.compute_rays">[docs]</a>
<span class="k">def</span> <span class="nf">compute_rays</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">tx_depth_ndx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fname_base</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute rays from a given transmitter.</span>

<span class="sd">    :param env: environment definition</span>
<span class="sd">    :param tx_depth_ndx: transmitter depth index</span>
<span class="sd">    :param model: propagation model to use (None to auto-select)</span>
<span class="sd">    :param debug: generate debug information for propagation model</span>
<span class="sd">    :param fname_base: base file name for Bellhop working files, default (None), creates a temporary file</span>
<span class="sd">    :returns: ray paths</span>

<span class="sd">    &gt;&gt;&gt; import arlpy.uwapm as pm</span>
<span class="sd">    &gt;&gt;&gt; env = pm.create_env2d()</span>
<span class="sd">    &gt;&gt;&gt; rays = pm.compute_rays(env)</span>
<span class="sd">    &gt;&gt;&gt; pm.plot_rays(rays, width=1000)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">env</span> <span class="o">=</span> <span class="n">check_env2d</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;tx_depth&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">env</span><span class="p">[</span><span class="s1">&#39;tx_depth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;tx_depth&#39;</span><span class="p">][</span><span class="n">tx_depth_ndx</span><span class="p">]</span>
    <span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span> <span class="o">=</span> <span class="n">_select_model</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">rays</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[DEBUG] Model: &#39;</span><span class="o">+</span><span class="n">model_name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">rays</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">fname_base</span><span class="p">)</span></div>


<div class="viewcode-block" id="compute_transmission_loss">
<a class="viewcode-back" href="../../index.html#bellhop.bellhop.compute_transmission_loss">[docs]</a>
<span class="k">def</span> <span class="nf">compute_transmission_loss</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">tx_depth_ndx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">coherent</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tx_type</span><span class="o">=</span><span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fname_base</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute transmission loss from a given transmitter to all receviers.</span>

<span class="sd">    :param env: environment definition</span>
<span class="sd">    :param tx_depth_ndx: transmitter depth index</span>
<span class="sd">    :param mode: coherent, incoherent or semicoherent</span>
<span class="sd">    :param model: propagation model to use (None to auto-select)</span>
<span class="sd">    :param tx_type: point or line</span>
<span class="sd">    :param debug: generate debug information for propagation model</span>
<span class="sd">    :param fname_base: base file name for Bellhop working files, default (None), creates a temporary file</span>
<span class="sd">    :returns: complex transmission loss at each receiver depth and range</span>

<span class="sd">    &gt;&gt;&gt; import arlpy.uwapm as pm</span>
<span class="sd">    &gt;&gt;&gt; env = pm.create_env2d()</span>
<span class="sd">    &gt;&gt;&gt; tloss = pm.compute_transmission_loss(env, mode=pm.incoherent)</span>
<span class="sd">    &gt;&gt;&gt; pm.plot_transmission_loss(tloss, width=1000)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">env</span> <span class="o">=</span> <span class="n">check_env2d</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">coherent</span><span class="p">,</span> <span class="n">incoherent</span><span class="p">,</span> <span class="n">semicoherent</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unknown transmission loss mode: &#39;</span><span class="o">+</span><span class="n">mode</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">tx_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">source_rev</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unknown source type: </span><span class="si">{</span><span class="n">tx_type</span><span class="si">!r}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;tx_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span>
        <span class="n">env</span><span class="p">[</span><span class="s1">&#39;tx_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tx_type</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">tx_type</span> <span class="o">==</span> <span class="s1">&#39;default&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;tx_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">tx_type</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;ENV file defines source type &quot;&#39;</span><span class="o">+</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;tx_type&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;&quot; inconsistent with Python argument tx_type=&quot;&#39;</span><span class="o">+</span><span class="n">tx_type</span><span class="o">+</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;tx_depth&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">env</span><span class="p">[</span><span class="s1">&#39;tx_depth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;tx_depth&#39;</span><span class="p">][</span><span class="n">tx_depth_ndx</span><span class="p">]</span>
    <span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span> <span class="o">=</span> <span class="n">_select_model</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[DEBUG] Model: &#39;</span><span class="o">+</span><span class="n">model_name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">fname_base</span><span class="p">)</span></div>


<div class="viewcode-block" id="arrivals_to_impulse_response">
<a class="viewcode-back" href="../../index.html#bellhop.bellhop.arrivals_to_impulse_response">[docs]</a>
<span class="k">def</span> <span class="nf">arrivals_to_impulse_response</span><span class="p">(</span><span class="n">arrivals</span><span class="p">,</span> <span class="n">fs</span><span class="p">,</span> <span class="n">abs_time</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert arrival times and coefficients to an impulse response.</span>

<span class="sd">    :param arrivals: arrivals times (s) and coefficients</span>
<span class="sd">    :param fs: sampling rate (Hz)</span>
<span class="sd">    :param abs_time: absolute time (True) or relative time (False)</span>
<span class="sd">    :returns: impulse response</span>

<span class="sd">    If `abs_time` is set to True, the impulse response is placed such that</span>
<span class="sd">    the zero time corresponds to the time of transmission of signal.</span>

<span class="sd">    &gt;&gt;&gt; import arlpy.uwapm as pm</span>
<span class="sd">    &gt;&gt;&gt; env = pm.create_env2d()</span>
<span class="sd">    &gt;&gt;&gt; arrivals = pm.compute_arrivals(env)</span>
<span class="sd">    &gt;&gt;&gt; ir = pm.arrivals_to_impulse_response(arrivals, fs=192000)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">abs_time</span> <span class="k">else</span> <span class="nb">min</span><span class="p">(</span><span class="n">arrivals</span><span class="o">.</span><span class="n">time_of_arrival</span><span class="p">)</span>
    <span class="n">irlen</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="nb">max</span><span class="p">(</span><span class="n">arrivals</span><span class="o">.</span><span class="n">time_of_arrival</span><span class="p">)</span><span class="o">-</span><span class="n">t0</span><span class="p">)</span><span class="o">*</span><span class="n">fs</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span>
    <span class="n">ir</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">irlen</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">complex128</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">arrivals</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">ndx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">round</span><span class="p">((</span><span class="n">row</span><span class="o">.</span><span class="n">time_of_arrival</span><span class="o">.</span><span class="n">real</span><span class="o">-</span><span class="n">t0</span><span class="p">)</span><span class="o">*</span><span class="n">fs</span><span class="p">))</span>
        <span class="n">ir</span><span class="p">[</span><span class="n">ndx</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">arrival_amplitude</span>
    <span class="k">return</span> <span class="n">ir</span></div>


<div class="viewcode-block" id="plot_arrivals">
<a class="viewcode-back" href="../../index.html#bellhop.bellhop.plot_arrivals">[docs]</a>
<span class="k">def</span> <span class="nf">plot_arrivals</span><span class="p">(</span><span class="n">arrivals</span><span class="p">,</span> <span class="n">dB</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plots the arrival times and amplitudes.</span>

<span class="sd">    :param arrivals: arrivals times (s) and coefficients</span>
<span class="sd">    :param dB: True to plot in dB, False for linear scale</span>
<span class="sd">    :param color: line color (see `Bokeh colors &lt;https://bokeh.pydata.org/en/latest/docs/reference/colors.html&gt;`_)</span>

<span class="sd">    Other keyword arguments applicable for `arlpy.plot.plot()` are also supported.</span>

<span class="sd">    &gt;&gt;&gt; import arlpy.uwapm as pm</span>
<span class="sd">    &gt;&gt;&gt; env = pm.create_env2d()</span>
<span class="sd">    &gt;&gt;&gt; arrivals = pm.compute_arrivals(env)</span>
<span class="sd">    &gt;&gt;&gt; pm.plot_arrivals(arrivals)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">arrivals</span><span class="o">.</span><span class="n">time_of_arrival</span><span class="p">)</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">arrivals</span><span class="o">.</span><span class="n">time_of_arrival</span><span class="p">)</span>
    <span class="n">oh</span> <span class="o">=</span> <span class="n">_plt</span><span class="o">.</span><span class="n">hold</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">dB</span><span class="p">:</span>
        <span class="n">min_y</span> <span class="o">=</span> <span class="mi">20</span><span class="o">*</span><span class="n">_np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">arrivals</span><span class="o">.</span><span class="n">arrival_amplitude</span><span class="p">)))</span><span class="o">-</span><span class="mi">60</span>
        <span class="n">ylabel</span> <span class="o">=</span> <span class="s1">&#39;Amplitude (dB)&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ylabel</span> <span class="o">=</span> <span class="s1">&#39;Amplitude&#39;</span>
        <span class="n">_plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">t0</span><span class="p">,</span> <span class="n">t1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Arrival time (s)&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="n">ylabel</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">min_y</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">arrivals</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">time_of_arrival</span><span class="o">.</span><span class="n">real</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">arrival_amplitude</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dB</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">20</span><span class="o">*</span><span class="n">_np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">_fi</span><span class="o">.</span><span class="n">epsilon</span><span class="o">+</span><span class="n">y</span><span class="p">),</span> <span class="n">min_y</span><span class="p">)</span>
        <span class="n">_plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">t</span><span class="p">,</span> <span class="n">t</span><span class="p">],</span> <span class="p">[</span><span class="n">min_y</span><span class="p">,</span> <span class="n">y</span><span class="p">],</span> <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Arrival time (s)&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="n">ylabel</span><span class="p">,</span> <span class="n">ylim</span><span class="o">=</span><span class="p">[</span><span class="n">min_y</span><span class="p">,</span> <span class="n">min_y</span><span class="o">+</span><span class="mi">70</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">_plt</span><span class="o">.</span><span class="n">hold</span><span class="p">(</span><span class="n">oh</span><span class="p">)</span></div>


<div class="viewcode-block" id="plot_rays">
<a class="viewcode-back" href="../../index.html#bellhop.bellhop.plot_rays">[docs]</a>
<span class="k">def</span> <span class="nf">plot_rays</span><span class="p">(</span><span class="n">rays</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">invert_colors</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plots ray paths.</span>

<span class="sd">    :param rays: ray paths</span>
<span class="sd">    :param env: environment definition</span>
<span class="sd">    :param invert_colors: False to use black for high intensity rays, True to use white</span>

<span class="sd">    If environment definition is provided, it is overlayed over this plot using default</span>
<span class="sd">    parameters for `arlpy.uwapm.plot_env()`.</span>

<span class="sd">    Other keyword arguments applicable for `arlpy.plot.plot()` are also supported.</span>

<span class="sd">    &gt;&gt;&gt; import arlpy.uwapm as pm</span>
<span class="sd">    &gt;&gt;&gt; env = pm.create_env2d()</span>
<span class="sd">    &gt;&gt;&gt; rays = pm.compute_eigenrays(env)</span>
<span class="sd">    &gt;&gt;&gt; pm.plot_rays(rays, width=1000)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rays</span> <span class="o">=</span> <span class="n">rays</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;bottom_bounces&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">max_amp</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">rays</span><span class="o">.</span><span class="n">bottom_bounces</span><span class="p">))</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rays</span><span class="o">.</span><span class="n">bottom_bounces</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">max_amp</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">max_amp</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">divisor</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">xlabel</span> <span class="o">=</span> <span class="s1">&#39;Range (m)&#39;</span>
    <span class="n">r</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rays</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">r</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">ray</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">-</span><span class="nb">min</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10000</span><span class="p">:</span>
        <span class="n">divisor</span> <span class="o">=</span> <span class="mi">1000</span>
        <span class="n">xlabel</span> <span class="o">=</span> <span class="s1">&#39;Range (km)&#39;</span>
    <span class="n">oh</span> <span class="o">=</span> <span class="n">_plt</span><span class="o">.</span><span class="n">hold</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rays</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">c</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">255</span><span class="o">*</span><span class="n">_np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">bottom_bounces</span><span class="p">)</span><span class="o">/</span><span class="n">max_amp</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">invert_colors</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="mi">255</span><span class="o">-</span><span class="n">c</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">_bokeh</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">RGB</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
        <span class="n">_plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">ray</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">divisor</span><span class="p">,</span> <span class="o">-</span><span class="n">row</span><span class="o">.</span><span class="n">ray</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="n">xlabel</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Depth (m)&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">env</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plot_env</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="n">_plt</span><span class="o">.</span><span class="n">hold</span><span class="p">(</span><span class="n">oh</span><span class="p">)</span></div>


<div class="viewcode-block" id="plot_transmission_loss">
<a class="viewcode-back" href="../../index.html#bellhop.bellhop.plot_transmission_loss">[docs]</a>
<span class="k">def</span> <span class="nf">plot_transmission_loss</span><span class="p">(</span><span class="n">tloss</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plots transmission loss.</span>

<span class="sd">    :param tloss: complex transmission loss</span>
<span class="sd">    :param env: environment definition</span>

<span class="sd">    If environment definition is provided, it is overlayed over this plot using default</span>
<span class="sd">    parameters for `arlpy.uwapm.plot_env()`.</span>

<span class="sd">    Other keyword arguments applicable for `arlpy.plot.image()` are also supported.</span>

<span class="sd">    &gt;&gt;&gt; import arlpy.uwapm as pm</span>
<span class="sd">    &gt;&gt;&gt; import numpy as np</span>
<span class="sd">    &gt;&gt;&gt; env = pm.create_env2d(</span>
<span class="sd">            rx_depth=np.arange(0, 25),</span>
<span class="sd">            rx_range=np.arange(0, 1000),</span>
<span class="sd">            min_angle=-45,</span>
<span class="sd">            max_angle=45</span>
<span class="sd">        )</span>
<span class="sd">    &gt;&gt;&gt; tloss = pm.compute_transmission_loss(env)</span>
<span class="sd">    &gt;&gt;&gt; pm.plot_transmission_loss(tloss, width=1000)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">xr</span> <span class="o">=</span> <span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">tloss</span><span class="o">.</span><span class="n">columns</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">tloss</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>
    <span class="n">yr</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="nb">max</span><span class="p">(</span><span class="n">tloss</span><span class="o">.</span><span class="n">index</span><span class="p">),</span> <span class="o">-</span><span class="nb">min</span><span class="p">(</span><span class="n">tloss</span><span class="o">.</span><span class="n">index</span><span class="p">))</span>
    <span class="n">xlabel</span> <span class="o">=</span> <span class="s1">&#39;Range (m)&#39;</span>
    <span class="k">if</span> <span class="n">xr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">xr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">10000</span><span class="p">:</span>
        <span class="n">xr</span> <span class="o">=</span> <span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">tloss</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">tloss</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">/</span><span class="mi">1000</span><span class="p">)</span>
        <span class="n">xlabel</span> <span class="o">=</span> <span class="s1">&#39;Range (km)&#39;</span>
    <span class="n">oh</span> <span class="o">=</span> <span class="n">_plt</span><span class="o">.</span><span class="n">hold</span><span class="p">()</span>
    <span class="n">_plt</span><span class="o">.</span><span class="n">image</span><span class="p">(</span><span class="mi">20</span><span class="o">*</span><span class="n">_np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">_fi</span><span class="o">.</span><span class="n">epsilon</span><span class="o">+</span><span class="n">_np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tloss</span><span class="p">)))),</span> <span class="n">x</span><span class="o">=</span><span class="n">xr</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">yr</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="n">xlabel</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Depth (m)&#39;</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="n">xr</span><span class="p">,</span> <span class="n">ylim</span><span class="o">=</span><span class="n">yr</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">env</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plot_env</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">rx_plot</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">_plt</span><span class="o">.</span><span class="n">hold</span><span class="p">(</span><span class="n">oh</span><span class="p">)</span></div>


<div class="viewcode-block" id="pyplot_env">
<a class="viewcode-back" href="../../index.html#bellhop.bellhop.pyplot_env">[docs]</a>
<span class="k">def</span> <span class="nf">pyplot_env</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">surface_color</span><span class="o">=</span><span class="s1">&#39;dodgerblue&#39;</span><span class="p">,</span> <span class="n">bottom_color</span><span class="o">=</span><span class="s1">&#39;peru&#39;</span><span class="p">,</span> <span class="n">tx_color</span><span class="o">=</span><span class="s1">&#39;orangered&#39;</span><span class="p">,</span> <span class="n">rx_color</span><span class="o">=</span><span class="s1">&#39;midnightblue&#39;</span><span class="p">,</span>
               <span class="n">rx_plot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plots a visual representation of the environment with matplotlib.</span>

<span class="sd">    :param env: environment description</span>
<span class="sd">    :param surface_color: color of the surface (see `Bokeh colors &lt;https://bokeh.pydata.org/en/latest/docs/reference/colors.html&gt;`_)</span>
<span class="sd">    :param bottom_color: color of the bottom (see `Bokeh colors &lt;https://bokeh.pydata.org/en/latest/docs/reference/colors.html&gt;`_)</span>
<span class="sd">    :param tx_color: color of transmitters (see `Bokeh colors &lt;https://bokeh.pydata.org/en/latest/docs/reference/colors.html&gt;`_)</span>
<span class="sd">    :param rx_color: color of receviers (see `Bokeh colors &lt;https://bokeh.pydata.org/en/latest/docs/reference/colors.html&gt;`_)</span>
<span class="sd">    :param rx_plot: True to plot all receivers, False to not plot any receivers, None to automatically decide</span>

<span class="sd">    Other keyword arguments applicable for `arlpy.plot.plot()` are also supported.</span>

<span class="sd">    The surface, bottom, transmitters (marker: &#39;*&#39;) and receivers (marker: &#39;o&#39;)</span>
<span class="sd">    are plotted in the environment. If `rx_plot` is set to None and there are</span>
<span class="sd">    more than 2000 receivers, they are not plotted.</span>

<span class="sd">    &gt;&gt;&gt; import arlpy.uwapm as pm</span>
<span class="sd">    &gt;&gt;&gt; env = pm.create_env2d(depth=[[0, 40], [100, 30], [500, 35], [700, 20], [1000,45]])</span>
<span class="sd">    &gt;&gt;&gt; pm.plot_env(env)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">env</span> <span class="o">=</span> <span class="n">check_env2d</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;rx_range&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">min_x</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;rx_range&#39;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">min_x</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">max_x</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;rx_range&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">max_x</span> <span class="o">-</span> <span class="n">min_x</span> <span class="o">&gt;</span> <span class="mi">10000</span><span class="p">:</span>
        <span class="n">divisor</span> <span class="o">=</span> <span class="mi">1000</span>
        <span class="n">min_x</span> <span class="o">/=</span> <span class="n">divisor</span>
        <span class="n">max_x</span> <span class="o">/=</span> <span class="n">divisor</span>
        <span class="n">xlabel</span> <span class="o">=</span> <span class="s1">&#39;Range (km)&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">divisor</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">xlabel</span> <span class="o">=</span> <span class="s1">&#39;Range (m)&#39;</span>
    <span class="k">if</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;surface&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">min_y</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">min_y</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;surface&#39;</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">_np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">max_y</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">max_y</span> <span class="o">=</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">]</span>
    <span class="n">mgn_x</span> <span class="o">=</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="p">(</span><span class="n">max_x</span> <span class="o">-</span> <span class="n">min_x</span><span class="p">)</span>
    <span class="n">mgn_y</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="p">(</span><span class="n">max_y</span> <span class="o">-</span> <span class="n">min_y</span><span class="p">)</span>
    <span class="n">oh</span> <span class="o">=</span> <span class="n">_plt</span><span class="o">.</span><span class="n">hold</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;surface&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_pyplt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">min_x</span><span class="p">,</span> <span class="n">max_x</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">surface_color</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">_pyplt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>
        <span class="n">_pyplt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Depth (m)&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">min_x</span><span class="p">,</span> <span class="n">mgn_x</span><span class="p">,</span> <span class="n">max_x</span><span class="p">,</span> <span class="n">mgn_x</span><span class="p">)</span>
        <span class="n">_pyplt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="n">min_x</span> <span class="o">-</span> <span class="n">mgn_x</span><span class="p">,</span> <span class="n">max_x</span> <span class="o">+</span> <span class="n">mgn_x</span><span class="p">])</span>
        <span class="n">_pyplt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="o">-</span><span class="n">max_y</span> <span class="o">-</span> <span class="n">mgn_y</span><span class="p">,</span> <span class="o">-</span><span class="n">min_y</span> <span class="o">+</span> <span class="n">mgn_y</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># linear and curvilinear options use the same altimetry, just with different normals</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;surface&#39;</span><span class="p">]</span>
        <span class="n">_pyplt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">s</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">divisor</span><span class="p">,</span> <span class="o">-</span><span class="n">s</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">surface_color</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">_pyplt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>
        <span class="n">_pyplt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Depth (m)&#39;</span><span class="p">)</span>
        <span class="n">_pyplt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="n">min_x</span> <span class="o">-</span> <span class="n">mgn_x</span><span class="p">,</span> <span class="n">max_x</span> <span class="o">+</span> <span class="n">mgn_x</span><span class="p">])</span>
        <span class="n">_pyplt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="o">-</span><span class="n">max_y</span> <span class="o">-</span> <span class="n">mgn_y</span><span class="p">,</span> <span class="o">-</span><span class="n">min_y</span> <span class="o">+</span> <span class="n">mgn_y</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">_np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">_pyplt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">min_x</span><span class="p">,</span> <span class="n">max_x</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">],</span> <span class="o">-</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">]],</span> <span class="n">color</span><span class="o">=</span><span class="n">bottom_color</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># linear and curvilinear options use the same bathymetry, just with different normals</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">]</span>
        <span class="n">_pyplt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">s</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">divisor</span><span class="p">,</span> <span class="o">-</span><span class="n">s</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">bottom_color</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">txd</span> <span class="o">=</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;tx_depth&#39;</span><span class="p">]</span>
    <span class="c1"># print(txd, [0]*_np.size(txd))</span>
    <span class="n">_pyplt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">_np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">txd</span><span class="p">),</span> <span class="o">-</span><span class="n">txd</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">tx_color</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rx_plot</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">rx_plot</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;rx_depth&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="n">_np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;rx_range&#39;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">2000</span>
    <span class="k">if</span> <span class="n">rx_plot</span><span class="p">:</span>
        <span class="n">rxr</span> <span class="o">=</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;rx_range&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">_np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">rxr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">rxr</span> <span class="o">=</span> <span class="p">[</span><span class="n">rxr</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rxr</span><span class="p">):</span>
            <span class="n">rxd</span> <span class="o">=</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;rx_depth&#39;</span><span class="p">]</span>
            <span class="n">_pyplt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">r</span> <span class="o">/</span> <span class="n">divisor</span><span class="p">]</span> <span class="o">*</span> <span class="n">_np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">rxd</span><span class="p">),</span> <span class="o">-</span><span class="n">rxd</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">rx_color</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="pyplot_ssp">
<a class="viewcode-back" href="../../index.html#bellhop.bellhop.pyplot_ssp">[docs]</a>
<span class="k">def</span> <span class="nf">pyplot_ssp</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plots the sound speed profile with matplotlib.</span>

<span class="sd">    :param env: environment description</span>

<span class="sd">    Other keyword arguments applicable for `arlpy.plot.plot()` are also supported.</span>

<span class="sd">    If the sound speed profile is range-dependent, this function only plots the first profile.</span>

<span class="sd">    &gt;&gt;&gt; import arlpy.uwapm as pm</span>
<span class="sd">    &gt;&gt;&gt; env = pm.create_env2d(soundspeed=[[ 0, 1540], [10, 1530], [20, 1532], [25, 1533], [30, 1535]])</span>
<span class="sd">    &gt;&gt;&gt; pm.plot_ssp(env)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">env</span> <span class="o">=</span> <span class="n">check_env2d</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="n">svp</span> <span class="o">=</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;soundspeed&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">svp</span><span class="p">,</span> <span class="n">_pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="n">svp</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">svp</span><span class="o">.</span><span class="n">index</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">_np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">svp</span><span class="p">)))</span>
    <span class="k">if</span> <span class="n">_np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">svp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">_np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">max_y</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">max_y</span> <span class="o">=</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">]</span>
        <span class="n">_pyplt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">svp</span><span class="p">,</span> <span class="n">svp</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">max_y</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">_pyplt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Soundspeed (m/s)&#39;</span><span class="p">)</span>
        <span class="n">_pyplt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Depth (m)&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;soundspeed_interp&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">spline</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">svp</span>
        <span class="n">ynew</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">svp</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]),</span> <span class="n">_np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">svp</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]),</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">tck</span> <span class="o">=</span> <span class="n">_interp</span><span class="o">.</span><span class="n">splrep</span><span class="p">(</span><span class="n">svp</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">svp</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">xnew</span> <span class="o">=</span> <span class="n">_interp</span><span class="o">.</span><span class="n">splev</span><span class="p">(</span><span class="n">ynew</span><span class="p">,</span> <span class="n">tck</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">_pyplt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xnew</span><span class="p">,</span> <span class="o">-</span><span class="n">ynew</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">_pyplt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Soundspeed (m/s)&#39;</span><span class="p">)</span>
        <span class="n">_pyplt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Depth (m)&#39;</span><span class="p">)</span>
        <span class="n">_pyplt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">svp</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="o">-</span><span class="n">svp</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">_pyplt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">svp</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="o">-</span><span class="n">svp</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">_pyplt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Soundspeed (m/s)&#39;</span><span class="p">)</span>
        <span class="n">_pyplt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Depth (m)&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="pyplot_arrivals">
<a class="viewcode-back" href="../../index.html#bellhop.bellhop.pyplot_arrivals">[docs]</a>
<span class="k">def</span> <span class="nf">pyplot_arrivals</span><span class="p">(</span><span class="n">arrivals</span><span class="p">,</span> <span class="n">dB</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plots the arrival times and amplitudes with matplotlib.</span>

<span class="sd">    :param arrivals: arrivals times (s) and coefficients</span>
<span class="sd">    :param dB: True to plot in dB, False for linear scale</span>
<span class="sd">    :param color: line color (see `Bokeh colors &lt;https://bokeh.pydata.org/en/latest/docs/reference/colors.html&gt;`_)</span>

<span class="sd">    Other keyword arguments applicable for `arlpy.plot.plot()` are also supported.</span>

<span class="sd">    &gt;&gt;&gt; import arlpy.uwapm as pm</span>
<span class="sd">    &gt;&gt;&gt; env = pm.create_env2d()</span>
<span class="sd">    &gt;&gt;&gt; arrivals = pm.compute_arrivals(env)</span>
<span class="sd">    &gt;&gt;&gt; pm.plot_arrivals(arrivals)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">arrivals</span><span class="o">.</span><span class="n">time_of_arrival</span><span class="p">)</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">arrivals</span><span class="o">.</span><span class="n">time_of_arrival</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dB</span><span class="p">:</span>
        <span class="n">min_y</span> <span class="o">=</span> <span class="mi">20</span> <span class="o">*</span> <span class="n">_np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">arrivals</span><span class="o">.</span><span class="n">arrival_amplitude</span><span class="p">)))</span> <span class="o">-</span> <span class="mi">60</span>
        <span class="n">ylabel</span> <span class="o">=</span> <span class="s1">&#39;Amplitude (dB)&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ylabel</span> <span class="o">=</span> <span class="s1">&#39;Amplitude&#39;</span>
        <span class="n">_pyplt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">t0</span><span class="p">,</span> <span class="n">t1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">_pyplt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Arrival time (s)&#39;</span><span class="p">)</span>
        <span class="n">_pyplt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>
        <span class="n">min_y</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">arrivals</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">time_of_arrival</span><span class="o">.</span><span class="n">real</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">arrival_amplitude</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dB</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">20</span> <span class="o">*</span> <span class="n">_np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">_fi</span><span class="o">.</span><span class="n">epsilon</span> <span class="o">+</span> <span class="n">y</span><span class="p">),</span> <span class="n">min_y</span><span class="p">)</span>
        <span class="n">_pyplt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">t</span><span class="p">,</span> <span class="n">t</span><span class="p">],</span> <span class="p">[</span><span class="n">min_y</span><span class="p">,</span> <span class="n">y</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">_pyplt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Arrival time (s)&#39;</span><span class="p">)</span>
        <span class="n">_pyplt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span></div>


<div class="viewcode-block" id="pyplot_rays">
<a class="viewcode-back" href="../../index.html#bellhop.bellhop.pyplot_rays">[docs]</a>
<span class="k">def</span> <span class="nf">pyplot_rays</span><span class="p">(</span><span class="n">rays</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">invert_colors</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plots ray paths with matplotlib</span>

<span class="sd">    :param rays: ray paths</span>
<span class="sd">    :param env: environment definition</span>
<span class="sd">    :param invert_colors: False to use black for high intensity rays, True to use white</span>

<span class="sd">    If environment definition is provided, it is overlayed over this plot using default</span>
<span class="sd">    parameters for `arlpy.uwapm.plot_env()`.</span>

<span class="sd">    Other keyword arguments applicable for `arlpy.plot.plot()` are also supported.</span>

<span class="sd">    &gt;&gt;&gt; import arlpy.uwapm as pm</span>
<span class="sd">    &gt;&gt;&gt; env = pm.create_env2d()</span>
<span class="sd">    &gt;&gt;&gt; rays = pm.compute_eigenrays(env)</span>
<span class="sd">    &gt;&gt;&gt; pm.plot_rays(rays, width=1000)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rays</span> <span class="o">=</span> <span class="n">rays</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;bottom_bounces&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">max_amp</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">rays</span><span class="o">.</span><span class="n">bottom_bounces</span><span class="p">))</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rays</span><span class="o">.</span><span class="n">bottom_bounces</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">max_amp</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">max_amp</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">divisor</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">xlabel</span> <span class="o">=</span> <span class="s1">&#39;Range (m)&#39;</span>
    <span class="n">r</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rays</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">r</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">ray</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10000</span><span class="p">:</span>
        <span class="n">divisor</span> <span class="o">=</span> <span class="mi">1000</span>
        <span class="n">xlabel</span> <span class="o">=</span> <span class="s1">&#39;Range (km)&#39;</span>
    <span class="n">oh</span> <span class="o">=</span> <span class="n">_plt</span><span class="o">.</span><span class="n">hold</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rays</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">bottom_bounces</span><span class="p">)</span> <span class="o">/</span> <span class="n">max_amp</span>
        <span class="k">if</span> <span class="n">invert_colors</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">c</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">_cm</span><span class="o">.</span><span class="n">gray</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;color&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">_pyplt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">ray</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">divisor</span><span class="p">,</span> <span class="o">-</span><span class="n">row</span><span class="o">.</span><span class="n">ray</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_pyplt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">ray</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">divisor</span><span class="p">,</span> <span class="o">-</span><span class="n">row</span><span class="o">.</span><span class="n">ray</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">_pyplt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>
        <span class="n">_pyplt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Depth (m)&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">env</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">pyplot_env</span><span class="p">(</span><span class="n">env</span><span class="p">)</span></div>


<div class="viewcode-block" id="pyplot_transmission_loss">
<a class="viewcode-back" href="../../index.html#bellhop.bellhop.pyplot_transmission_loss">[docs]</a>
<span class="k">def</span> <span class="nf">pyplot_transmission_loss</span><span class="p">(</span><span class="n">tloss</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plots transmission loss with matplotlib.</span>

<span class="sd">    :param tloss: complex transmission loss</span>
<span class="sd">    :param env: environment definition</span>

<span class="sd">    If environment definition is provided, it is overlayed over this plot using default</span>
<span class="sd">    parameters for `arlpy.uwapm.plot_env()`.</span>

<span class="sd">    Other keyword arguments applicable for `arlpy.plot.image()` are also supported.</span>

<span class="sd">    &gt;&gt;&gt; import arlpy.uwapm as pm</span>
<span class="sd">    &gt;&gt;&gt; import numpy as np</span>
<span class="sd">    &gt;&gt;&gt; env = pm.create_env2d(</span>
<span class="sd">            rx_depth=np.arange(0, 25),</span>
<span class="sd">            rx_range=np.arange(0, 1000),</span>
<span class="sd">            min_angle=-45,</span>
<span class="sd">            max_angle=45</span>
<span class="sd">        )</span>
<span class="sd">    &gt;&gt;&gt; tloss = pm.compute_transmission_loss(env)</span>
<span class="sd">    &gt;&gt;&gt; pm.plot_transmission_loss(tloss, width=1000)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">xr</span> <span class="o">=</span> <span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">tloss</span><span class="o">.</span><span class="n">columns</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">tloss</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>
    <span class="n">yr</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="nb">max</span><span class="p">(</span><span class="n">tloss</span><span class="o">.</span><span class="n">index</span><span class="p">),</span> <span class="o">-</span><span class="nb">min</span><span class="p">(</span><span class="n">tloss</span><span class="o">.</span><span class="n">index</span><span class="p">))</span>
    <span class="n">xlabel</span> <span class="o">=</span> <span class="s1">&#39;Range (m)&#39;</span>
    <span class="k">if</span> <span class="n">xr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">xr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">10000</span><span class="p">:</span>
        <span class="n">xr</span> <span class="o">=</span> <span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">tloss</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">tloss</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span>
        <span class="n">xlabel</span> <span class="o">=</span> <span class="s1">&#39;Range (km)&#39;</span>
    <span class="n">oh</span> <span class="o">=</span> <span class="n">_plt</span><span class="o">.</span><span class="n">hold</span><span class="p">()</span>
    <span class="n">trans_loss</span> <span class="o">=</span> <span class="mi">20</span> <span class="o">*</span> <span class="n">_np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">_fi</span><span class="o">.</span><span class="n">epsilon</span> <span class="o">+</span> <span class="n">_np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tloss</span><span class="p">))))</span>
    <span class="n">x_mesh</span><span class="p">,</span> <span class="n">ymesh</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">xr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">trans_loss</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                                 <span class="n">_np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">yr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">yr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">trans_loss</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">trans_loss</span> <span class="o">=</span> <span class="n">trans_loss</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># print(trans_loss.shape)</span>
    <span class="k">if</span> <span class="s2">&quot;vmin&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">trans_loss</span><span class="p">[</span><span class="n">trans_loss</span> <span class="o">&lt;</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;vmin&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;vmin&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s2">&quot;vmax&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">trans_loss</span><span class="p">[</span><span class="n">trans_loss</span> <span class="o">&gt;</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;vmax&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;vmax&quot;</span><span class="p">]</span>
    <span class="n">trans_loss</span> <span class="o">=</span> <span class="n">trans_loss</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">x_mesh</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">_pyplt</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">x_mesh</span><span class="p">,</span> <span class="n">ymesh</span><span class="p">,</span> <span class="n">trans_loss</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;jet&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">_pyplt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>
    <span class="n">_pyplt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Depth (m)&#39;</span><span class="p">)</span>
    <span class="n">_pyplt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;Transmission Loss(dB)&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">env</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">pyplot_env</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">rx_plot</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>


<div class="viewcode-block" id="models">
<a class="viewcode-back" href="../../index.html#bellhop.bellhop.models">[docs]</a>
<span class="k">def</span> <span class="nf">models</span><span class="p">(</span><span class="n">env</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">task</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;List available models.</span>

<span class="sd">    :param env: environment to model</span>
<span class="sd">    :param task: arrivals/eigenrays/rays/coherent/incoherent/semicoherent</span>
<span class="sd">    :returns: list of models that can be used</span>

<span class="sd">    &gt;&gt;&gt; import arlpy.uwapm as pm</span>
<span class="sd">    &gt;&gt;&gt; pm.models()</span>
<span class="sd">    [&#39;bellhop&#39;]</span>
<span class="sd">    &gt;&gt;&gt; env = pm.create_env2d()</span>
<span class="sd">    &gt;&gt;&gt; pm.models(env, task=coherent)</span>
<span class="sd">    [&#39;bellhop&#39;]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">env</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">check_env2d</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">env</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">task</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">env</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">task</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;env and task should be both specified together&#39;</span><span class="p">)</span>
    <span class="n">rv</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">_models</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">]()</span><span class="o">.</span><span class="n">supports</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">task</span><span class="p">):</span>
            <span class="n">rv</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">rv</span></div>


<span class="k">def</span> <span class="nf">_select_model</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">_models</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">model</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">]())</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unknown model: &#39;</span><span class="o">+</span><span class="n">model</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">_models</span><span class="p">:</span>
        <span class="n">mm</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">]()</span>
        <span class="k">if</span> <span class="n">mm</span><span class="o">.</span><span class="n">supports</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">task</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mm</span><span class="p">)</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No suitable propagation model available&#39;</span><span class="p">)</span>

<span class="c1">### Bellhop propagation model ###</span>

<span class="k">class</span> <span class="nc">_Bellhop</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">supports</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">task</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">env</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;2D&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">fh</span><span class="p">,</span> <span class="n">fname</span> <span class="o">=</span> <span class="n">_mkstemp</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;.env&#39;</span><span class="p">)</span>
        <span class="n">_os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>
        <span class="n">fname_base</span> <span class="o">=</span> <span class="n">fname</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_unlink</span><span class="p">(</span><span class="n">fname_base</span><span class="o">+</span><span class="s1">&#39;.env&#39;</span><span class="p">)</span>
        <span class="n">rv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bellhop</span><span class="p">(</span><span class="n">fname_base</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_unlink</span><span class="p">(</span><span class="n">fname_base</span><span class="o">+</span><span class="s1">&#39;.prt&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_unlink</span><span class="p">(</span><span class="n">fname_base</span><span class="o">+</span><span class="s1">&#39;.log&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rv</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fname_base</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">taskmap</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">arrivals</span><span class="p">:</span>     <span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_arrivals</span><span class="p">],</span>
            <span class="n">eigenrays</span><span class="p">:</span>    <span class="p">[</span><span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_rays</span><span class="p">],</span>
            <span class="n">rays</span><span class="p">:</span>         <span class="p">[</span><span class="s1">&#39;R&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_rays</span><span class="p">],</span>
            <span class="n">coherent</span><span class="p">:</span>     <span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_shd</span><span class="p">],</span>
            <span class="n">incoherent</span><span class="p">:</span>   <span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_shd</span><span class="p">],</span>
            <span class="n">semicoherent</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_shd</span><span class="p">]</span>
        <span class="p">}</span>
        <span class="n">fname_flag</span><span class="o">=</span><span class="kc">False</span>
        <span class="k">if</span> <span class="n">fname_base</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fname_flag</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">fname_base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_env_file</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">taskmap</span><span class="p">[</span><span class="n">task</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">fname_base</span><span class="p">)</span>

        <span class="n">results</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bellhop</span><span class="p">(</span><span class="n">fname_base</span><span class="p">):</span>
            <span class="n">err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_error</span><span class="p">(</span><span class="n">fname_base</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">err</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">results</span> <span class="o">=</span> <span class="n">taskmap</span><span class="p">[</span><span class="n">task</span><span class="p">][</span><span class="mi">1</span><span class="p">](</span><span class="n">fname_base</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[WARN] Bellhop did not generate expected output file&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[DEBUG] Bellhop working files: &#39;</span><span class="o">+</span><span class="n">fname_base</span><span class="o">+</span><span class="s1">&#39;.*&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">fname_flag</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[CUSTOM FILES] Bellhop working files: &#39;</span><span class="o">+</span><span class="n">fname_base</span><span class="o">+</span><span class="s1">&#39;.*&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_unlink</span><span class="p">(</span><span class="n">fname_base</span><span class="o">+</span><span class="s1">&#39;.env&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_unlink</span><span class="p">(</span><span class="n">fname_base</span><span class="o">+</span><span class="s1">&#39;.bty&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_unlink</span><span class="p">(</span><span class="n">fname_base</span><span class="o">+</span><span class="s1">&#39;.ssp&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_unlink</span><span class="p">(</span><span class="n">fname_base</span><span class="o">+</span><span class="s1">&#39;.ati&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_unlink</span><span class="p">(</span><span class="n">fname_base</span><span class="o">+</span><span class="s1">&#39;.sbp&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_unlink</span><span class="p">(</span><span class="n">fname_base</span><span class="o">+</span><span class="s1">&#39;.prt&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_unlink</span><span class="p">(</span><span class="n">fname_base</span><span class="o">+</span><span class="s1">&#39;.log&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_unlink</span><span class="p">(</span><span class="n">fname_base</span><span class="o">+</span><span class="s1">&#39;.arr&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_unlink</span><span class="p">(</span><span class="n">fname_base</span><span class="o">+</span><span class="s1">&#39;.ray&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_unlink</span><span class="p">(</span><span class="n">fname_base</span><span class="o">+</span><span class="s1">&#39;.shd&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">results</span>

    <span class="k">def</span> <span class="nf">_bellhop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">runcmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;bellhop.exe </span><span class="si">{</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">))</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="c1">#print(f&quot;RUNNING {runcmd}&quot;)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">_proc</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">runcmd</span><span class="p">,</span>
                        <span class="n">stderr</span><span class="o">=</span><span class="n">_proc</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">_proc</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                        <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1">#print(f&quot;RETURN CODE: {result.returncode}&quot;)</span>
            <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">127</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_unlink</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_print</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">_os</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="p">(</span><span class="n">s</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="n">newline</span> <span class="k">else</span> <span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">_print_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">nn</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">nn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nn</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nn</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%0.6f</span><span class="s2"> /&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">a</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">nn</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">a</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%0.6f</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="n">newline</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_create_env_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">taskcode</span><span class="p">,</span> <span class="n">fname_base</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="c1"># get env file name</span>
        <span class="k">if</span> <span class="n">fname_base</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="n">fname_base</span><span class="o">+</span><span class="s1">&#39;.env&#39;</span>
            <span class="n">fh</span> <span class="o">=</span> <span class="n">_os</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">fname</span><span class="p">),</span> <span class="n">_os</span><span class="o">.</span><span class="n">O_WRONLY</span> <span class="o">|</span> <span class="n">_os</span><span class="o">.</span><span class="n">O_CREAT</span> <span class="o">|</span> <span class="n">_os</span><span class="o">.</span><span class="n">O_TRUNC</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fh</span><span class="p">,</span> <span class="n">fname</span> <span class="o">=</span> <span class="n">_mkstemp</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;.env&#39;</span><span class="p">)</span>
            <span class="n">fname_base</span> <span class="o">=</span> <span class="n">fname</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="s2">&quot;&#39;&quot;</span><span class="o">+</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%0.6f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;frequency&#39;</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">)</span>
        <span class="n">svp</span> <span class="o">=</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;soundspeed&#39;</span><span class="p">]</span>
        <span class="n">svp_depth</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">svp_interp</span> <span class="o">=</span> <span class="n">interp_rev</span><span class="p">[</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;soundspeed_interp&#39;</span><span class="p">]]</span>
        <span class="n">svp_topbound</span> <span class="o">=</span> <span class="n">topbound_rev</span><span class="p">[</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;top_boundary_condition&#39;</span><span class="p">]]</span>
        <span class="n">svp_attunits</span> <span class="o">=</span> <span class="n">attunits_rev</span><span class="p">[</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;attenuation_units&#39;</span><span class="p">]]</span>
        <span class="n">svp_volatt</span> <span class="o">=</span> <span class="n">volatt_rev</span><span class="p">[</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;volume_attenuation&#39;</span><span class="p">]]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">svp</span><span class="p">,</span> <span class="n">_pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="n">svp_depth</span> <span class="o">=</span> <span class="n">svp</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">svp</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">svp_interp</span> <span class="o">==</span> <span class="s1">&#39;Q&#39;</span><span class="p">,</span> <span class="s2">&quot;SVP DataFrame with multiple columns implies quadrilateral interpolation.&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">svp</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">svp</span><span class="o">.</span><span class="n">index</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">_np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">svp</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;surface&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">svp_interp</span><span class="si">}{</span><span class="n">svp_topbound</span><span class="si">}{</span><span class="n">svp_attunits</span><span class="si">}{</span><span class="n">svp_volatt</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="s2">&quot;&#39;</span><span class="si">%c</span><span class="s2">VWT*&#39;&quot;</span> <span class="o">%</span> <span class="n">svp_interp</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_bty_ati_file</span><span class="p">(</span><span class="n">fname_base</span><span class="o">+</span><span class="s1">&#39;.ati&#39;</span><span class="p">,</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;surface&#39;</span><span class="p">],</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;surface_interp&#39;</span><span class="p">])</span>
        <span class="c1"># max depth should be the depth of the acoustic domain, which can be deeper than the max depth bathymetry</span>
        <span class="n">max_depth</span> <span class="o">=</span> <span class="n">env</span><span class="p">[</span><span class="s2">&quot;depth_max&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">env</span><span class="p">[</span><span class="s2">&quot;depth_max&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">_np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="nb">max</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">][:,</span><span class="mi">1</span><span class="p">]),</span> <span class="n">svp_depth</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;depth_npts&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;depth_sigmaz&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;depth_max&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">_np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">svp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="s2">&quot;0.0 </span><span class="si">%0.6f</span><span class="s2"> /&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">svp</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%0.6f</span><span class="s2"> </span><span class="si">%0.6f</span><span class="s2"> /&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">max_depth</span><span class="p">,</span> <span class="n">svp</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">svp_interp</span> <span class="o">==</span> <span class="s1">&#39;Q&#39;</span><span class="p">:</span>
            <span class="n">sspenv</span> <span class="o">=</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;ssp_env&#39;</span><span class="p">]</span>
            <span class="c1"># if the SSP data was provided in the ENV file, use that:</span>
            <span class="k">if</span> <span class="n">sspenv</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sspenv</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%0.6f</span><span class="s2"> </span><span class="si">%0.6f</span><span class="s2"> /&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sspenv</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">sspenv</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="mi">1</span><span class="p">]))</span>
            <span class="c1"># otherwise use the SSP data specified in the dataframe:</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">svp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%0.6f</span><span class="s2"> </span><span class="si">%0.6f</span><span class="s2"> /&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">svp</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">svp</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_ssp_file</span><span class="p">(</span><span class="n">fname_base</span><span class="o">+</span><span class="s1">&#39;.ssp&#39;</span><span class="p">,</span> <span class="n">svp</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">svp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%0.6f</span><span class="s2"> </span><span class="si">%0.6f</span><span class="s2"> /&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">svp</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">svp</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">depth</span> <span class="o">=</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">_np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="s2">&quot;&#39;A&#39; </span><span class="si">%0.6f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;bottom_roughness&#39;</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="s2">&quot;&#39;A*&#39; </span><span class="si">%0.6f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;bottom_roughness&#39;</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_bty_ati_file</span><span class="p">(</span><span class="n">fname_base</span><span class="o">+</span><span class="s1">&#39;.bty&#39;</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;depth_interp&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;bottom_absorption&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%0.6f</span><span class="s2"> </span><span class="si">%0.6f</span><span class="s2"> </span><span class="si">%0.6f</span><span class="s2"> </span><span class="si">%0.6f</span><span class="s2"> /&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;depth_max&#39;</span><span class="p">],</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;bottom_soundspeed&#39;</span><span class="p">],</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;bottom_soundspeed_shear&#39;</span><span class="p">],</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;bottom_density&#39;</span><span class="p">]</span><span class="o">/</span><span class="mi">1000</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;bottom_absorption_shear&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%0.6f</span><span class="s2"> </span><span class="si">%0.6f</span><span class="s2"> </span><span class="si">%0.6f</span><span class="s2"> </span><span class="si">%0.6f</span><span class="s2"> </span><span class="si">%0.6f</span><span class="s2"> /&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;depth_max&#39;</span><span class="p">],</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;bottom_soundspeed&#39;</span><span class="p">],</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;bottom_soundspeed_shear&#39;</span><span class="p">],</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;bottom_density&#39;</span><span class="p">]</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;bottom_absorption&#39;</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%0.6f</span><span class="s2"> </span><span class="si">%0.6f</span><span class="s2"> </span><span class="si">%0.6f</span><span class="s2"> </span><span class="si">%0.6f</span><span class="s2"> </span><span class="si">%0.6f</span><span class="s2"> </span><span class="si">%0.6f</span><span class="s2"> /&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;depth_max&#39;</span><span class="p">],</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;bottom_soundspeed&#39;</span><span class="p">],</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;bottom_soundspeed_shear&#39;</span><span class="p">],</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;bottom_density&#39;</span><span class="p">]</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;bottom_absorption&#39;</span><span class="p">],</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;bottom_absorption_shear&#39;</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print_array</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;tx_depth&#39;</span><span class="p">],</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;tx_ndepth&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print_array</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;rx_depth&#39;</span><span class="p">],</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;rx_ndepth&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print_array</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;rx_range&#39;</span><span class="p">]</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;rx_nrange&#39;</span><span class="p">])</span>

        <span class="n">beamtype</span> <span class="o">=</span> <span class="n">beam_rev</span><span class="p">[</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;beam_type&#39;</span><span class="p">]]</span>
        <span class="n">beampattern</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span>
        <span class="n">txtype</span> <span class="o">=</span> <span class="n">source_rev</span><span class="p">[</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;tx_type&#39;</span><span class="p">]]</span>
        <span class="n">gridtype</span> <span class="o">=</span> <span class="n">grid_rev</span><span class="p">[</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;grid&#39;</span><span class="p">]]</span>
        <span class="k">if</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;tx_directionality&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">beampattern</span> <span class="o">=</span> <span class="s2">&quot;*&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_sbp_file</span><span class="p">(</span><span class="n">fname_base</span><span class="o">+</span><span class="s1">&#39;.sbp&#39;</span><span class="p">,</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;tx_directionality&#39;</span><span class="p">])</span>
        <span class="n">runtype_str</span> <span class="o">=</span> <span class="n">taskcode</span> <span class="o">+</span> <span class="n">beamtype</span> <span class="o">+</span> <span class="n">beampattern</span> <span class="o">+</span> <span class="n">txtype</span> <span class="o">+</span> <span class="n">gridtype</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">runtype_str</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;nbeams&#39;</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%0.6f</span><span class="s2"> </span><span class="si">%0.6f</span><span class="s2"> /   ! ALPHA1,2 (degrees)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;min_angle&#39;</span><span class="p">],</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;max_angle&#39;</span><span class="p">]))</span>
        <span class="n">step_size</span> <span class="o">=</span> <span class="n">env</span><span class="p">[</span><span class="s2">&quot;step_size&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="mf">0.0</span>
        <span class="n">box_depth</span> <span class="o">=</span> <span class="n">env</span><span class="p">[</span><span class="s2">&quot;box_depth&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="mf">1.01</span><span class="o">*</span><span class="n">max_depth</span>
        <span class="n">box_range</span> <span class="o">=</span> <span class="n">env</span><span class="p">[</span><span class="s2">&quot;box_range&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="mf">1.01</span><span class="o">*</span><span class="n">_np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;rx_range&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">step_size</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">box_depth</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">box_range</span><span class="o">/</span><span class="mi">1000</span><span class="si">}</span><span class="s2"> ! STEP (m), ZBOX (m), RBOX (km)&quot;</span><span class="p">)</span>
        <span class="n">_os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fname_base</span>

    <span class="k">def</span> <span class="nf">_create_bty_ati_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">interp</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;wt&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">%c</span><span class="s2">&#39;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;C&#39;</span> <span class="k">if</span> <span class="n">interp</span> <span class="o">==</span> <span class="n">curvilinear</span> <span class="k">else</span> <span class="s1">&#39;L&#39;</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">depth</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">depth</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%0.6f</span><span class="s2"> </span><span class="si">%0.6f</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">depth</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span> <span class="n">depth</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="mi">1</span><span class="p">]))</span>

    <span class="k">def</span> <span class="nf">_create_sbp_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="nb">dir</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;wt&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">dir</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">dir</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%0.6f</span><span class="s2"> </span><span class="si">%0.6f</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">dir</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="nb">dir</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="mi">1</span><span class="p">]))</span>

    <span class="k">def</span> <span class="nf">_create_ssp_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">svp</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;wt&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">svp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">svp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%0.6f%c</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">svp</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="n">svp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39; &#39;</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">svp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">svp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%0.6f%c</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">svp</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">j</span><span class="p">],</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="n">svp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39; &#39;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_readf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">types</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">_re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39; +&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">_re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39; +&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">types</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">j</span><span class="p">:</span>
                <span class="n">p</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">types</span><span class="p">[</span><span class="n">j</span><span class="p">](</span><span class="n">p</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">p</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">dtype</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_check_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname_base</span><span class="p">):</span>
        <span class="n">err</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname_base</span><span class="o">+</span><span class="s1">&#39;.prt&#39;</span><span class="p">,</span> <span class="s1">&#39;rt&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">lno</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">err</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">err</span> <span class="o">+=</span> <span class="s1">&#39;[BELLHOP] &#39;</span> <span class="o">+</span> <span class="n">s</span>
                    <span class="k">elif</span> <span class="s1">&#39;*** FATAL ERROR ***&#39;</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
                        <span class="n">err</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">[BELLHOP] &#39;</span> <span class="o">+</span> <span class="n">s</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">return</span> <span class="n">err</span>

    <span class="k">def</span> <span class="nf">_load_arrivals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname_base</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname_base</span><span class="o">+</span><span class="s1">&#39;.arr&#39;</span><span class="p">,</span> <span class="s1">&#39;rt&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">hdr</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">hdr</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;2D&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">freq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_readf</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,))</span>
                <span class="n">tx_depth_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_readf</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,),</span> <span class="nb">float</span><span class="p">)</span>
                <span class="n">tx_depth_count</span> <span class="o">=</span> <span class="n">tx_depth_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">tx_depth</span> <span class="o">=</span> <span class="n">tx_depth_info</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="k">assert</span> <span class="n">tx_depth_count</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">tx_depth</span><span class="p">)</span>
                <span class="n">rx_depth_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_readf</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,),</span> <span class="nb">float</span><span class="p">)</span>
                <span class="n">rx_depth_count</span> <span class="o">=</span> <span class="n">rx_depth_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">rx_depth</span> <span class="o">=</span> <span class="n">rx_depth_info</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="k">assert</span> <span class="n">rx_depth_count</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">rx_depth</span><span class="p">)</span>
                <span class="n">rx_range_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_readf</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,),</span> <span class="nb">float</span><span class="p">)</span>
                <span class="n">rx_range_count</span> <span class="o">=</span> <span class="n">rx_range_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">rx_range</span> <span class="o">=</span> <span class="n">rx_range_info</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="k">assert</span> <span class="n">rx_range_count</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">rx_range</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">freq</span><span class="p">,</span> <span class="n">tx_depth_count</span><span class="p">,</span> <span class="n">rx_depth_count</span><span class="p">,</span> <span class="n">rx_range_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_readf</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">))</span>
                <span class="n">tx_depth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_readf</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,)</span><span class="o">*</span><span class="n">tx_depth_count</span><span class="p">)</span>
                <span class="n">rx_depth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_readf</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,)</span><span class="o">*</span><span class="n">rx_depth_count</span><span class="p">)</span>
                <span class="n">rx_range</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_readf</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,)</span><span class="o">*</span><span class="n">rx_range_count</span><span class="p">)</span>
            <span class="n">arrivals</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">tx_depth_count</span><span class="p">):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rx_depth_count</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rx_range_count</span><span class="p">):</span>
                        <span class="n">count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">())</span>
                        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
                            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_readf</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">))</span>
                            <span class="n">arrivals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
                                <span class="s1">&#39;tx_depth_ndx&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">j</span><span class="p">],</span>
                                <span class="s1">&#39;rx_depth_ndx&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">k</span><span class="p">],</span>
                                <span class="s1">&#39;rx_range_ndx&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">m</span><span class="p">],</span>
                                <span class="s1">&#39;tx_depth&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">tx_depth</span><span class="p">[</span><span class="n">j</span><span class="p">]],</span>
                                <span class="s1">&#39;rx_depth&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">rx_depth</span><span class="p">[</span><span class="n">k</span><span class="p">]],</span>
                                <span class="s1">&#39;rx_range&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">rx_range</span><span class="p">[</span><span class="n">m</span><span class="p">]],</span>
                                <span class="s1">&#39;arrival_number&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">n</span><span class="p">],</span>
                                <span class="c1"># &#39;arrival_amplitude&#39;: [data[0]*_np.exp(1j * data[1]* _np.pi/180)],</span>
                                <span class="s1">&#39;arrival_amplitude&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">_np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="o">-</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="n">freq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">_np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1</span><span class="n">j</span> <span class="o">+</span>  <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">])))],</span>
                                <span class="s1">&#39;time_of_arrival&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span>
                                <span class="s1">&#39;complex_time_of_arrival&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]],</span>
                                <span class="s1">&#39;angle_of_departure&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]],</span>
                                <span class="s1">&#39;angle_of_arrival&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">]],</span>
                                <span class="s1">&#39;surface_bounces&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="mi">6</span><span class="p">]],</span>
                                <span class="s1">&#39;bottom_bounces&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="mi">7</span><span class="p">]]</span>
                            <span class="p">},</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">arrivals</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">_pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">arrivals</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_load_rays</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname_base</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname_base</span><span class="o">+</span><span class="s1">&#39;.ray&#39;</span><span class="p">,</span> <span class="s1">&#39;rt&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
            <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
            <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
            <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
            <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
            <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
            <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
            <span class="n">rays</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">a</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="n">pts</span><span class="p">,</span> <span class="n">sb</span><span class="p">,</span> <span class="n">bb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_readf</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">))</span>
                <span class="n">ray</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">pts</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">pts</span><span class="p">):</span>
                    <span class="n">ray</span><span class="p">[</span><span class="n">k</span><span class="p">,:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_readf</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span>
                <span class="n">rays</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
                    <span class="s1">&#39;angle_of_departure&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">a</span><span class="p">],</span>
                    <span class="s1">&#39;surface_bounces&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">sb</span><span class="p">],</span>
                    <span class="s1">&#39;bottom_bounces&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">bb</span><span class="p">],</span>
                    <span class="s1">&#39;ray&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">ray</span><span class="p">]</span>
                <span class="p">}))</span>
        <span class="k">return</span> <span class="n">_pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">rays</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_load_shd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname_base</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname_base</span><span class="o">+</span><span class="s1">&#39;.shd&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">recl</span><span class="p">,</span> <span class="o">=</span> <span class="n">_unpack</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
            <span class="n">title</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">80</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">recl</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">ptype</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">assert</span> <span class="n">ptype</span> <span class="o">==</span> <span class="s1">&#39;rectilin&#39;</span><span class="p">,</span> <span class="s1">&#39;Invalid file format (expecting ptype == &quot;rectilin&quot;)&#39;</span>
            <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="n">recl</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">nfreq</span><span class="p">,</span> <span class="n">ntheta</span><span class="p">,</span> <span class="n">nsx</span><span class="p">,</span> <span class="n">nsy</span><span class="p">,</span> <span class="n">nsd</span><span class="p">,</span> <span class="n">nrd</span><span class="p">,</span> <span class="n">nrr</span><span class="p">,</span> <span class="n">atten</span> <span class="o">=</span> <span class="n">_unpack</span><span class="p">(</span><span class="s1">&#39;iiiiiiif&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">32</span><span class="p">))</span>
            <span class="k">assert</span> <span class="n">nfreq</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Invalid file format (expecting nfreq == 1)&#39;</span>
            <span class="k">assert</span> <span class="n">ntheta</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Invalid file format (expecting ntheta == 1)&#39;</span>
            <span class="k">assert</span> <span class="n">nsd</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Invalid file format (expecting nsd == 1)&#39;</span>
            <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">32</span><span class="o">*</span><span class="n">recl</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">pos_r_depth</span> <span class="o">=</span> <span class="n">_unpack</span><span class="p">(</span><span class="s1">&#39;f&#39;</span><span class="o">*</span><span class="n">nrd</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">nrd</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">36</span><span class="o">*</span><span class="n">recl</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">pos_r_range</span> <span class="o">=</span> <span class="n">_unpack</span><span class="p">(</span><span class="s1">&#39;f&#39;</span><span class="o">*</span><span class="n">nrr</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">nrr</span><span class="p">))</span>
            <span class="n">pressure</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nrd</span><span class="p">,</span> <span class="n">nrr</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">complex128</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ird</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nrd</span><span class="p">):</span>
                <span class="n">recnum</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">+</span> <span class="n">ird</span>
                <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">recnum</span><span class="o">*</span><span class="mi">4</span><span class="o">*</span><span class="n">recl</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">_unpack</span><span class="p">(</span><span class="s1">&#39;f&#39;</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">nrr</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">nrr</span><span class="o">*</span><span class="mi">4</span><span class="p">)))</span>
                <span class="n">pressure</span><span class="p">[</span><span class="n">ird</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[::</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">temp</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">_pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">pressure</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">pos_r_depth</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">pos_r_range</span><span class="p">)</span>

<span class="n">_models</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;bellhop&#39;</span><span class="p">,</span> <span class="n">_Bellhop</span><span class="p">))</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">BELLHOP Python API</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2025, Will Robertson, Mandar Chitre.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
    </div>

    

    
  </body>
</html>