<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coverage Report: influence.f90</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            margin: 20px;
            background-color: #f9f9f9;
        }
        .header {
            background-color: #2c3e50;
            color: white;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .summary {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        .metric {
            background-color: #ecf0f1;
            padding: 10px;
            border-radius: 3px;
            text-align: center;
            min-width: 120px;
        }
        .metric-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #27ae60;
        }
        .code-container {
            background-color: white;
            border: 1px solid #bdc3c7;
            border-radius: 5px;
            overflow: auto;
        }
        .code-line {
            display: flex;
            border-bottom: 1px solid #ecf0f1;
        }
        .line-number {
            background-color: #f8f9fa;
            padding: 2px 8px;
            width: 60px;
            text-align: right;
            border-right: 1px solid #dee2e6;
            color: #6c757d;
        }
        .execution-count {
            background-color: #f8f9fa;
            padding: 2px 8px;
            width: 80px;
            text-align: right;
            border-right: 1px solid #dee2e6;
            color: #495057;
        }
        .source-code {
            padding: 2px 8px;
            flex: 1;
            white-space: pre;
        }
        .executed { background-color: #d4edda; }
        .not-executed { background-color: #f8d7da; }
        .non-executable { background-color: #f8f9fa; }
        .footer {
            margin-top: 20px;
            padding: 15px;
            background-color: #e9ecef;
            border-radius: 5px;
            font-size: 0.9em;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Coverage Report: influence.f90</h1>
        <p>Generated from GCOV analysis of Fortran source code</p>
    </div>

    <div class="summary">
        <div class="metric">
            <div class="metric-value">36.5%</div>
            <div>Lines Executed</div>
            <div>433 total lines</div>
        </div>
        <div class="metric">
            <div class="metric-value">60.6%</div>
            <div>Branches Executed</div>
            <div>525 total branches</div>
        </div>
        <div class="metric">
            <div class="metric-value">100.0%</div>
            <div>Calls Executed</div>
            <div>10 total calls</div>
        </div>
    </div>

    <div class="code-container">
        <div class="code-line non-executable">
            <div class="line-number">0</div>
            <div class="execution-count">-</div>
            <div class="source-code">Source:influence.f90</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">0</div>
            <div class="execution-count">-</div>
            <div class="source-code">Graph:influence.gcno</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">0</div>
            <div class="execution-count">-</div>
            <div class="source-code">Data:influence.gcda</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">0</div>
            <div class="execution-count">-</div>
            <div class="source-code">Runs:57</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">1</div>
            <div class="execution-count">-</div>
            <div class="source-code">!! Beam influence computation for pressure field calculation</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">2</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">3</div>
            <div class="execution-count">-</div>
            <div class="source-code">MODULE Influence</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">4</div>
            <div class="execution-count">-</div>
            <div class="source-code">  !! Computes beam contributions to complex pressure fields using various beam weighting approaches</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">5</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">6</div>
            <div class="execution-count">-</div>
            <div class="source-code">  ! Compute the beam influence, i.e. the contribution of a single beam to the complex pressure</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">7</div>
            <div class="execution-count">-</div>
            <div class="source-code">  ! mbp 12/2018, based on much older subroutines</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">8</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">9</div>
            <div class="execution-count">-</div>
            <div class="source-code">  USE bellhopMod</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">10</div>
            <div class="execution-count">-</div>
            <div class="source-code">  USE SourceReceiverPositions</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">11</div>
            <div class="execution-count">-</div>
            <div class="source-code">  USE ArrMod</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">12</div>
            <div class="execution-count">-</div>
            <div class="source-code">  USE sspMod   ! used to construct image beams in the Cerveny style beam routines</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">13</div>
            <div class="execution-count">-</div>
            <div class="source-code">  USE WriteRay</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">14</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">15</div>
            <div class="execution-count">-</div>
            <div class="source-code">  IMPLICIT NONE</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">16</div>
            <div class="execution-count">-</div>
            <div class="source-code">  PUBLIC</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">17</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">18</div>
            <div class="execution-count">-</div>
            <div class="source-code">  INTEGER,          PRIVATE :: iz, ir, iS</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">19</div>
            <div class="execution-count">-</div>
            <div class="source-code">  REAL    (KIND=8), PRIVATE :: Ratio1 = 1.0D0   ! scale factor for a line source</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">20</div>
            <div class="execution-count">-</div>
            <div class="source-code">  REAL    (KIND=8), PRIVATE :: W, s, n, Amp, phase, const, phaseInt, q0, q, qold, RcvrDeclAngle, rA, rB</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">21</div>
            <div class="execution-count">-</div>
            <div class="source-code">  COMPLEX (KIND=8), PRIVATE :: delay</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">22</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">23</div>
            <div class="execution-count">-</div>
            <div class="source-code">CONTAINS</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">24</div>
            <div class="execution-count">#####</div>
            <div class="source-code">  SUBROUTINE InfluenceCervenyRayCen( U, eps, alpha, iBeamWindow2, RadiusMax )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">25</div>
            <div class="execution-count">-</div>
            <div class="source-code">  !! Paraxial (Cerveny-style) beams in ray-centered coordinates</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">26</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">27</div>
            <div class="execution-count">-</div>
            <div class="source-code">    INTEGER,          INTENT( IN    ) :: IBeamWindow2</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">28</div>
            <div class="execution-count">-</div>
            <div class="source-code">    REAL    (KIND=8), INTENT( IN    ) :: alpha, RadiusMax                ! take-off angle</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">29</div>
            <div class="execution-count">-</div>
            <div class="source-code">    COMPLEX,          INTENT( INOUT ) :: U( NRz_per_range, Pos%NRr )  ! complex pressure field</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">30</div>
            <div class="execution-count">-</div>
            <div class="source-code">    COMPLEX (KIND=8), INTENT( IN    ) :: eps                          ! LP: EPSILON is an intrinsic</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">31</div>
            <div class="execution-count">-</div>
            <div class="source-code">    INTEGER          :: ir1, ir2, KMAHV( MaxN ), KMAH, image</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">32</div>
            <div class="execution-count">-</div>
            <div class="source-code">    REAL    (KIND=8) :: nA, nB, nSq, c, zr, Polarity</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">33</div>
            <div class="execution-count">#####</div>
            <div class="source-code">    REAL    (KIND=8) :: znV( Beam%Nsteps ), rnV( Beam%Nsteps )   ! ray normal</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">34</div>
            <div class="execution-count">-</div>
            <div class="source-code">    COMPLEX (KIND=8) :: pVB( MaxN ), qVB( MaxN ), q, epsV( MaxN ), contri, gammaV( MaxN ), gamma, P_n, P_s</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">35</div>
            <div class="execution-count">-</div>
            <div class="source-code">    COMPLEX (KIND=8) :: tau</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">36</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">37</div>
            <div class="execution-count">#####</div>
            <div class="source-code">    SELECT CASE ( Beam%RunType( 1 : 1 ) )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">38</div>
            <div class="execution-count">-</div>
            <div class="source-code">    CASE ( &#x27;C&#x27;, &#x27;I&#x27;, &#x27;S&#x27; )   ! TL</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">39</div>
            <div class="execution-count">-</div>
            <div class="source-code">    CASE DEFAULT</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">40</div>
            <div class="execution-count">#####</div>
            <div class="source-code">       WRITE( PRTFile, * ) &#x27;Cerveny influence does not support eigenrays or arrivals&#x27;</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">41</div>
            <div class="execution-count">#####</div>
            <div class="source-code">       CALL ERROUT( &#x27;InfluenceCervenyRayCen&#x27;, &#x27;Cerveny influence does not support eigenrays or arrivals&#x27; )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">42</div>
            <div class="execution-count">-</div>
            <div class="source-code">    END SELECT</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">43</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">44</div>
            <div class="execution-count">-</div>
            <div class="source-code">!!! need to add logic related to NRz_per_range</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">45</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">46</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! During reflection imag(q) is constant and adjacent normals cannot bracket a segment of the TL</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">47</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! line, so no special treatment is necessary</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">48</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">49</div>
            <div class="execution-count">#####</div>
            <div class="source-code">    IF ( Beam%Type( 2 : 2 ) == &#x27;C&#x27; ) THEN</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">50</div>
            <div class="execution-count">#####</div>
            <div class="source-code">       epsV( 1 : Beam%Nsteps ) = i * ABS( ray2D( 1 : Beam%Nsteps )%q( 1 ) / ray2D( 1 : Beam%Nsteps )%q( 2 ) )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">51</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ELSE</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">52</div>
            <div class="execution-count">#####</div>
            <div class="source-code">       epsV( 1 : Beam%Nsteps ) = eps</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">53</div>
            <div class="execution-count">-</div>
            <div class="source-code">    END IF</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">54</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">55</div>
            <div class="execution-count">#####</div>
            <div class="source-code">    pVB(    1 : Beam%Nsteps ) = ray2D( 1 : Beam%Nsteps )%p( 1 ) + epsV( 1 : Beam%Nsteps ) * ray2D( 1 : Beam%Nsteps )%p( 2 )</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">56</div>
            <div class="execution-count">#####</div>
            <div class="source-code">    qVB(    1 : Beam%Nsteps ) = ray2D( 1 : Beam%Nsteps )%q( 1 ) + epsV( 1 : Beam%Nsteps ) * ray2D( 1 : Beam%Nsteps )%q( 2 )</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">57</div>
            <div class="execution-count">#####</div>
            <div class="source-code">    gammaV( 1 : Beam%Nsteps ) = pVB(   1 : Beam%Nsteps ) / qVB( 1 : Beam%Nsteps )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">58</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">59</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! pre-calculate ray normal based on tangent with c(s) scaling</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">60</div>
            <div class="execution-count">#####</div>
            <div class="source-code">    znV = -ray2D( 1 : Beam%Nsteps )%t( 1 ) * ray2D( 1 : Beam%Nsteps )%c</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">61</div>
            <div class="execution-count">#####</div>
            <div class="source-code">    rnV =  ray2D( 1 : Beam%Nsteps )%t( 2 ) * ray2D( 1 : Beam%Nsteps )%c</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">62</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">63</div>
            <div class="execution-count">#####</div>
            <div class="source-code">    IF ( Beam%RunType( 4 : 4 ) == &#x27;R&#x27; ) Ratio1 = SQRT( ABS( COS( alpha ) ) )  ! point source</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">64</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">65</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! compute KMAH index</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">66</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! Following is incorrect for &#x27;Cerveny&#x27;-style beamwidth (narrow as possible)</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">67</div>
            <div class="execution-count">#####</div>
            <div class="source-code">    KMAHV(  1 ) = 1</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">68</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">69</div>
            <div class="execution-count">#####</div>
            <div class="source-code">    DO iS = 2, Beam%Nsteps</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">70</div>
            <div class="execution-count">#####</div>
            <div class="source-code">       KMAHV(  iS ) = KMAHV( iS - 1 )</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">71</div>
            <div class="execution-count">#####</div>
            <div class="source-code">       CALL BranchCut( qVB( iS - 1 ), qVB( iS ), Beam%Type, KMAHV( iS ) )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">72</div>
            <div class="execution-count">-</div>
            <div class="source-code">    END DO</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">73</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">74</div>
            <div class="execution-count">#####</div>
            <div class="source-code">    RcvrDepths: DO iz = 1, NRz_per_range</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">75</div>
            <div class="execution-count">#####</div>
            <div class="source-code">       zR = Pos%Rz( iz )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">76</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">77</div>
            <div class="execution-count">#####</div>
            <div class="source-code">       Images: DO image = 1, Beam%Nimage</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">78</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">79</div>
            <div class="execution-count">-</div>
            <div class="source-code">          ! LP: Previous code did rnV = -rnV for image 2 and 3. When Nimage = 2,</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">80</div>
            <div class="execution-count">-</div>
            <div class="source-code">          ! this means rnV changes sign every step, which can&#x27;t possibly be</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">81</div>
            <div class="execution-count">-</div>
            <div class="source-code">          ! correct. This was fixed by mbp in InfluenceCervenyCart.</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">82</div>
            <div class="execution-count">#####</div>
            <div class="source-code">          Polarity = 1.0D0</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">83</div>
            <div class="execution-count">#####</div>
            <div class="source-code">          IF ( image == 2 ) Polarity = -1.0D0</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">84</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">85</div>
            <div class="execution-count">-</div>
            <div class="source-code">          !!! This logic means that the first step along the ray is skipped</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">86</div>
            <div class="execution-count">-</div>
            <div class="source-code">          !!! which is a problem if deltas is very large, e.g. isospeed problems</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">87</div>
            <div class="execution-count">-</div>
            <div class="source-code">          !!! I fixed this in InfluenceGeoHatRayCen</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">88</div>
            <div class="execution-count">#####</div>
            <div class="source-code">          ir1 = HUGE( ir1 )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">89</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">90</div>
            <div class="execution-count">#####</div>
            <div class="source-code">          Stepping: DO iS = 2, Beam%Nsteps</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">91</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">92</div>
            <div class="execution-count">-</div>
            <div class="source-code">             ! Compute ray-centered coordinates, (znV, rnV)</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">93</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">94</div>
            <div class="execution-count">-</div>
            <div class="source-code">             ! If normal parallel to TL-line, skip to next step on ray</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">95</div>
            <div class="execution-count">-</div>
            <div class="source-code">             ! LP: Changed from TINY( znV( iS ) ), see README.md.</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">96</div>
            <div class="execution-count">#####</div>
            <div class="source-code">             IF ( ABS( znV( iS ) ) &lt; EPSILON( znV( iS ) ) ) CYCLE Stepping</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">97</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">98</div>
            <div class="execution-count">#####</div>
            <div class="source-code">             SELECT CASE ( image )     ! Images of beams</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">99</div>
            <div class="execution-count">-</div>
            <div class="source-code">             CASE ( 1 )                ! True beam</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">100</div>
            <div class="execution-count">#####</div>
            <div class="source-code">                nB  = ( zR -                             ray2D( iS )%x( 2 )   ) / znV( iS )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">101</div>
            <div class="execution-count">-</div>
            <div class="source-code">             CASE ( 2 )                ! Surface-reflected beam</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">102</div>
            <div class="execution-count">#####</div>
            <div class="source-code">                nB  = ( zR - ( 2.0 * Bdry%Top%HS%Depth - ray2D( iS )%x( 2 ) ) ) / znV( iS )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">103</div>
            <div class="execution-count">-</div>
            <div class="source-code">             CASE ( 3 )                ! Bottom-reflected beam</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">104</div>
            <div class="execution-count">#####</div>
            <div class="source-code">                nB  = ( zR - ( 2.0 * Bdry%Bot%HS%Depth - ray2D( iS )%x( 2 ) ) ) / znV( iS )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">105</div>
            <div class="execution-count">-</div>
            <div class="source-code">             CASE DEFAULT</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">106</div>
            <div class="execution-count">#####</div>
            <div class="source-code">                WRITE( PRTFile, * ) &#x27;Beam%Nimage = &#x27;, Beam%Nimage</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">107</div>
            <div class="execution-count">#####</div>
            <div class="source-code">                CALL ERROUT( &#x27;InfluenceCervenyRayCen&#x27;, &#x27;Nimage must be 1, 2, or 3&#x27; )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">108</div>
            <div class="execution-count">-</div>
            <div class="source-code">             END SELECT</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">109</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">110</div>
            <div class="execution-count">#####</div>
            <div class="source-code">             rB  = ray2D( iS )%x( 1 ) + nB * rnV( iS ) * Polarity</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">111</div>
            <div class="execution-count">#####</div>
            <div class="source-code">             ir2 = RToIR( rB )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">112</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">113</div>
            <div class="execution-count">-</div>
            <div class="source-code">             ! detect and skip duplicate points (happens at boundary reflection)</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">114</div>
            <div class="execution-count">#####</div>
            <div class="source-code">             IF ( ir1 &gt;= ir2 .OR. &amp;</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">115</div>
            <div class="execution-count">#####</div>
            <div class="source-code">                &amp; ABS( ray2D( iS )%x( 1 ) - ray2D( iS - 1 )%x( 1 ) ) &lt; 1.0D3 * SPACING( ray2D( iS )%x( 1 ) ) ) THEN</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">116</div>
            <div class="execution-count">#####</div>
            <div class="source-code">                rA  = rB</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">117</div>
            <div class="execution-count">#####</div>
            <div class="source-code">                nA  = nB</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">118</div>
            <div class="execution-count">#####</div>
            <div class="source-code">                ir1 = ir2</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">119</div>
            <div class="execution-count">#####</div>
            <div class="source-code">                CYCLE Stepping</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">120</div>
            <div class="execution-count">-</div>
            <div class="source-code">             END IF</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">121</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">122</div>
            <div class="execution-count">#####</div>
            <div class="source-code">             RcvrRanges: DO ir = ir1 + 1, ir2    ! Compute influence for each rcvr</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">123</div>
            <div class="execution-count">#####</div>
            <div class="source-code">                W     = ( Pos%Rr( ir ) - rA ) / ( rB - rA )</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">124</div>
            <div class="execution-count">#####</div>
            <div class="source-code">                q     =    qVB( iS - 1 ) + W * (    qVB( iS ) -    qVB( iS - 1 ) )</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">125</div>
            <div class="execution-count">#####</div>
            <div class="source-code">                gamma = gammaV( iS - 1 ) + W * ( gammaV( iS ) - gammaV( iS - 1 ) )</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">126</div>
            <div class="execution-count">#####</div>
            <div class="source-code">                n     = nA + W * ( nB - nA )</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">127</div>
            <div class="execution-count">#####</div>
            <div class="source-code">                nSq   = n * n</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">128</div>
            <div class="execution-count">#####</div>
            <div class="source-code">                IF ( AIMAG( gamma ) &gt; 0 ) THEN</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">129</div>
            <div class="execution-count">#####</div>
            <div class="source-code">                   WRITE( PRTFile, * ) &#x27;Unbounded beam&#x27;</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">130</div>
            <div class="execution-count">#####</div>
            <div class="source-code">                   CYCLE RcvrRanges</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">131</div>
            <div class="execution-count">-</div>
            <div class="source-code">                END IF</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">132</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">133</div>
            <div class="execution-count">#####</div>
            <div class="source-code">                IF ( -0.5 * omega * AIMAG( gamma ) * nSq &lt; iBeamWindow2 ) THEN   ! Within beam window?</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">134</div>
            <div class="execution-count">#####</div>
            <div class="source-code">                   c      = ray2D( iS - 1 )%c</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">135</div>
            <div class="execution-count">#####</div>
            <div class="source-code">                   tau    = ray2D( iS - 1 )%tau + W * ( ray2D( iS )%tau - ray2D( iS - 1 )%tau )</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">136</div>
            <div class="execution-count">#####</div>
            <div class="source-code">                   contri = ratio1 * ray2D( iS )%Amp * SQRT( c * ABS( epsV( iS ) ) / q ) * &amp;</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">137</div>
            <div class="execution-count">#####</div>
            <div class="source-code">                        EXP( -i * ( omega * ( tau + 0.5 * gamma * nSq ) - ray2D( iS )%phase ) )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">138</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">139</div>
            <div class="execution-count">#####</div>
            <div class="source-code">                   SELECT CASE ( Beam%Component )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">140</div>
            <div class="execution-count">-</div>
            <div class="source-code">                   CASE ( &#x27;P&#x27; )   ! pressure</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">141</div>
            <div class="execution-count">-</div>
            <div class="source-code">                   CASE ( &#x27;V&#x27; )   ! vertical component</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">142</div>
            <div class="execution-count">#####</div>
            <div class="source-code">                      P_n    = -i * omega * gamma * n * contri</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">143</div>
            <div class="execution-count">#####</div>
            <div class="source-code">                      P_s    = -i * omega / c         * contri</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">144</div>
            <div class="execution-count">#####</div>
            <div class="source-code">                      contri = c * DOT_PRODUCT( [ P_n, P_s ], ray2D( iS )%t )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">145</div>
            <div class="execution-count">-</div>
            <div class="source-code">                   CASE ( &#x27;H&#x27; )   ! horizontal component</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">146</div>
            <div class="execution-count">#####</div>
            <div class="source-code">                      P_n    = -i * omega * gamma * n * contri</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">147</div>
            <div class="execution-count">#####</div>
            <div class="source-code">                      P_s    = -i * omega / c         * contri</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">148</div>
            <div class="execution-count">#####</div>
            <div class="source-code">                      contri = c * ( -P_n * ray2D( iS )%t( 2 ) + P_s * ray2D( iS )%t( 1 ) )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">149</div>
            <div class="execution-count">-</div>
            <div class="source-code">                   END SELECT</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">150</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">151</div>
            <div class="execution-count">#####</div>
            <div class="source-code">                   KMAH = KMAHV( iS - 1 )</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">152</div>
            <div class="execution-count">#####</div>
            <div class="source-code">                   CALL BranchCut( qVB( iS - 1 ), q, Beam%Type, KMAH ) ! Get correct branch of SQRT</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">153</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">154</div>
            <div class="execution-count">#####</div>
            <div class="source-code">                   IF ( KMAH  &lt; 0  ) contri = -contri</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">155</div>
            <div class="execution-count">#####</div>
            <div class="source-code">                   contri = Polarity * contri</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">156</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">157</div>
            <div class="execution-count">#####</div>
            <div class="source-code">                   SELECT CASE ( Beam%RunType( 1 : 1 ) )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">158</div>
            <div class="execution-count">-</div>
            <div class="source-code">                   CASE ( &#x27;I&#x27;, &#x27;S&#x27; )   ! Incoherent or Semi-coherent TL</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">159</div>
            <div class="execution-count">#####</div>
            <div class="source-code">                      contri = ABS( contri ) ** 2</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">160</div>
            <div class="execution-count">-</div>
            <div class="source-code">                   END SELECT</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">161</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">162</div>
            <div class="execution-count">#####</div>
            <div class="source-code">                   U( iz, ir ) = U( iz, ir ) + CMPLX( Hermite( n, RadiusMax, 2 * RadiusMax ) * contri )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">163</div>
            <div class="execution-count">-</div>
            <div class="source-code">                END IF</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">164</div>
            <div class="execution-count">-</div>
            <div class="source-code">             END DO RcvrRanges</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">165</div>
            <div class="execution-count">#####</div>
            <div class="source-code">             rA  = rB</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">166</div>
            <div class="execution-count">#####</div>
            <div class="source-code">             nA  = nB</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">167</div>
            <div class="execution-count">#####</div>
            <div class="source-code">             ir1 = ir2</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">168</div>
            <div class="execution-count">-</div>
            <div class="source-code">          END DO Stepping</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">169</div>
            <div class="execution-count">-</div>
            <div class="source-code">       END DO Images</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">170</div>
            <div class="execution-count">-</div>
            <div class="source-code">    END DO RcvrDepths</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">171</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">172</div>
            <div class="execution-count">#####</div>
            <div class="source-code">  END SUBROUTINE InfluenceCervenyRayCen</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">173</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">174</div>
            <div class="execution-count">-</div>
            <div class="source-code">  ! **********************************************************************!</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">175</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">176</div>
            <div class="execution-count">#####</div>
            <div class="source-code">  SUBROUTINE InfluenceCervenyCart( U, eps, alpha, iBeamWindow2, RadiusMax )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">177</div>
            <div class="execution-count">-</div>
            <div class="source-code">  !! Paraxial (Cerveny-style) beams in Cartesian coordinates</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">178</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">179</div>
            <div class="execution-count">-</div>
            <div class="source-code">    INTEGER,          INTENT( IN    ) :: IBeamWindow2</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">180</div>
            <div class="execution-count">-</div>
            <div class="source-code">    REAL    (KIND=8), INTENT( IN    ) :: alpha, RadiusMax                ! take-off angle</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">181</div>
            <div class="execution-count">-</div>
            <div class="source-code">    COMPLEX,          INTENT( INOUT ) :: U( NRz_per_range, Pos%NRr )  ! complex pressure field</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">182</div>
            <div class="execution-count">-</div>
            <div class="source-code">    COMPLEX (KIND=8), INTENT( IN    ) :: eps                          ! LP: EPSILON is an intrinsic</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">183</div>
            <div class="execution-count">-</div>
            <div class="source-code">    INTEGER          :: KMAHV( MaxN ), KMAH, irA, irB, Image</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">184</div>
            <div class="execution-count">-</div>
            <div class="source-code">    REAL    (KIND=8), SAVE :: Polarity = 1</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">185</div>
            <div class="execution-count">-</div>
            <div class="source-code">    REAL    (KIND=8) :: x( 2 ), rayt( 2 ), rayn( 2 ), Tr, Tz, zr, &amp;</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">186</div>
            <div class="execution-count">-</div>
            <div class="source-code">         c, cimag, cs, cn, csq, gradc( 2 ), crr, crz, czz, rho, deltaz</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">187</div>
            <div class="execution-count">-</div>
            <div class="source-code">    COMPLEX (KIND=8) :: pVB( MaxN ), qVB( MaxN ), q, epsV( MaxN ), contri, gammaV( MaxN ), gamma, const</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">188</div>
            <div class="execution-count">-</div>
            <div class="source-code">    COMPLEX (KIND=8) :: tau</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">189</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">190</div>
            <div class="execution-count">#####</div>
            <div class="source-code">    SELECT CASE ( Beam%RunType( 1 : 1 ) )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">191</div>
            <div class="execution-count">-</div>
            <div class="source-code">    CASE ( &#x27;C&#x27;, &#x27;I&#x27;, &#x27;S&#x27; )   ! TL</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">192</div>
            <div class="execution-count">-</div>
            <div class="source-code">    CASE DEFAULT</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">193</div>
            <div class="execution-count">#####</div>
            <div class="source-code">       WRITE( PRTFile, * ) &#x27;Cerveny influence does not support eigenrays or arrivals&#x27;</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">194</div>
            <div class="execution-count">#####</div>
            <div class="source-code">       CALL ERROUT( &#x27;InfluenceCervenyRayCen&#x27;, &#x27;Cerveny influence does not support eigenrays or arrivals&#x27; )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">195</div>
            <div class="execution-count">-</div>
            <div class="source-code">    END SELECT</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">196</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">197</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! need to add logic related to NRz_per_range</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">198</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">199</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! During reflection imag(q) is constant and adjacent normals cannot bracket a segment of the TL</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">200</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! line, so no special treatment is necessary</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">201</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">202</div>
            <div class="execution-count">#####</div>
            <div class="source-code">    IF ( Beam%Type( 2 : 2 ) == &#x27;C&#x27; ) THEN</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">203</div>
            <div class="execution-count">#####</div>
            <div class="source-code">       epsV( 1 : Beam%Nsteps ) = i * ABS( ray2D( 1 : Beam%Nsteps )%q( 1 ) / ray2D( 1 : Beam%Nsteps )%q( 2 ) )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">204</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ELSE</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">205</div>
            <div class="execution-count">#####</div>
            <div class="source-code">       epsV( 1 : Beam%Nsteps ) = eps</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">206</div>
            <div class="execution-count">-</div>
            <div class="source-code">    END IF</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">207</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">208</div>
            <div class="execution-count">#####</div>
            <div class="source-code">    pVB( 1 : Beam%Nsteps ) = ray2D( 1 : Beam%Nsteps )%p( 1 ) + epsV( 1 : Beam%Nsteps ) * ray2D( 1 : Beam%Nsteps )%p( 2 )</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">209</div>
            <div class="execution-count">#####</div>
            <div class="source-code">    qVB( 1 : Beam%Nsteps ) = ray2D( 1 : Beam%Nsteps )%q( 1 ) + epsV( 1 : Beam%Nsteps ) * ray2D( 1 : Beam%Nsteps )%q( 2 )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">210</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">211</div>
            <div class="execution-count">#####</div>
            <div class="source-code">    IF ( Beam%RunType( 4 : 4 ) == &#x27;R&#x27; ) Ratio1 = SQRT( ABS( COS( alpha ) ) )  ! point source</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">212</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">213</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! Form gamma and KMAH index</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">214</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! Treatment of KMAH index is incorrect for &#x27;Cerveny&#x27; style beam width BeamType</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">215</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">216</div>
            <div class="execution-count">#####</div>
            <div class="source-code">    Stepping0: DO iS = 1, Beam%Nsteps</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">217</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">218</div>
            <div class="execution-count">#####</div>
            <div class="source-code">       rayt = ray2D( iS )%c * ray2D( iS )%t   ! unit tangent</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">219</div>
            <div class="execution-count">#####</div>
            <div class="source-code">       rayn = [ rayt( 2 ), -rayt( 1 ) ]       ! unit normal</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">220</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">221</div>
            <div class="execution-count">#####</div>
            <div class="source-code">       CALL EvaluateSSP( ray2D( iS )%x, ray2D( iS )%t, c, cimag, gradc, crr, crz, czz, rho, Freq, &#x27;TAB&#x27; )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">222</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">223</div>
            <div class="execution-count">#####</div>
            <div class="source-code">       csq = c * c</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">224</div>
            <div class="execution-count">#####</div>
            <div class="source-code">       cS  = DOT_PRODUCT( gradc, rayt )</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">225</div>
            <div class="execution-count">#####</div>
            <div class="source-code">       cN  = DOT_PRODUCT( gradc, rayn )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">226</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">227</div>
            <div class="execution-count">#####</div>
            <div class="source-code">       Tr  = rayt(  1 )</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">228</div>
            <div class="execution-count">#####</div>
            <div class="source-code">       Tz  = rayt(  2 )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">229</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">230</div>
            <div class="execution-count">#####</div>
            <div class="source-code">       gammaV( iS ) = 0.0</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">231</div>
            <div class="execution-count">#####</div>
            <div class="source-code">       IF ( qVB( iS ) /= 0.0 ) THEN</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">232</div>
            <div class="execution-count">#####</div>
            <div class="source-code">          gammaV( iS ) = 0.5 * ( pVB( iS ) / qVB( iS ) * Tr**2 + 2.0 * cN / csq * Tz * Tr - cS / csq * Tz**2 )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">233</div>
            <div class="execution-count">-</div>
            <div class="source-code">       END IF</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">234</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">235</div>
            <div class="execution-count">#####</div>
            <div class="source-code">       IF ( iS == 1 ) THEN</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">236</div>
            <div class="execution-count">#####</div>
            <div class="source-code">          KMAHV( 1 ) = 1</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">237</div>
            <div class="execution-count">-</div>
            <div class="source-code">       ELSE</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">238</div>
            <div class="execution-count">#####</div>
            <div class="source-code">          KMAHV( iS ) = KMAHV( iS - 1 )</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">239</div>
            <div class="execution-count">#####</div>
            <div class="source-code">          CALL BranchCut( qVB( iS - 1 ), qVB( iS ), Beam%Type, KMAHV( iS ) )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">240</div>
            <div class="execution-count">-</div>
            <div class="source-code">       END IF</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">241</div>
            <div class="execution-count">-</div>
            <div class="source-code">    END DO Stepping0</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">242</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">243</div>
            <div class="execution-count">#####</div>
            <div class="source-code">    Stepping: DO iS = 3, Beam%Nsteps</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">244</div>
            <div class="execution-count">-</div>
            <div class="source-code">       ! LP: BUG: Assumes rays may never travel left.</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">245</div>
            <div class="execution-count">#####</div>
            <div class="source-code">       IF ( ray2D( iS     )%x( 1 ) &gt; Pos%Rr( Pos%NRr ) ) RETURN</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">246</div>
            <div class="execution-count">#####</div>
            <div class="source-code">       rA = ray2D( iS - 1 )%x( 1 )</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">247</div>
            <div class="execution-count">#####</div>
            <div class="source-code">       rB = ray2D( iS     )%x( 1 )</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">248</div>
            <div class="execution-count">#####</div>
            <div class="source-code">       IF ( ABS( rB - rA ) &lt; 1.0D3 * SPACING( rB ) ) CYCLE Stepping   ! don&#x27;t process duplicate points</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">249</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">250</div>
            <div class="execution-count">#####</div>
            <div class="source-code">       irA = RToIR( rA )</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">251</div>
            <div class="execution-count">#####</div>
            <div class="source-code">       irB = RToIR( rB )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">252</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">253</div>
            <div class="execution-count">#####</div>
            <div class="source-code">       IF ( irA &gt;= irB ) CYCLE Stepping</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">254</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">255</div>
            <div class="execution-count">#####</div>
            <div class="source-code">       RcvrRanges: DO ir = irA + 1, irB</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">256</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">257</div>
            <div class="execution-count">#####</div>
            <div class="source-code">          W     = ( Pos%Rr( ir ) - rA ) / ( rB - rA )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">258</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">259</div>
            <div class="execution-count">#####</div>
            <div class="source-code">          x     = ray2D(  iS - 1 )%x    + W * ( ray2D(  iS )%x   -  ray2D(  iS - 1 )%x   )</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">260</div>
            <div class="execution-count">#####</div>
            <div class="source-code">          rayt  = ray2D(  iS - 1 )%t    + W * ( ray2D(  iS )%t   -  ray2D(  iS - 1 )%t   )</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">261</div>
            <div class="execution-count">#####</div>
            <div class="source-code">          c     = ray2D(  iS - 1 )%c    + W * ( ray2D(  iS )%c   -  ray2D(  iS - 1 )%c   )</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">262</div>
            <div class="execution-count">#####</div>
            <div class="source-code">          q     = qVB(    iS - 1 )      + W * ( qVB(    iS )     -  qVB(    iS - 1 )     )</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">263</div>
            <div class="execution-count">#####</div>
            <div class="source-code">          tau   = ray2D(  iS - 1 )%tau  + W * ( ray2D(  iS )%tau -  ray2D(  iS - 1 )%tau )</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">264</div>
            <div class="execution-count">#####</div>
            <div class="source-code">          gamma = gammaV( iS - 1 )      + W * ( gammaV( iS )     -  gammaV( iS - 1 )     )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">265</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">266</div>
            <div class="execution-count">#####</div>
            <div class="source-code">          IF ( AIMAG( gamma ) &gt; 0 ) THEN</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">267</div>
            <div class="execution-count">#####</div>
            <div class="source-code">             WRITE( PRTFile, * ) &#x27;Unbounded beam&#x27;</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">268</div>
            <div class="execution-count">#####</div>
            <div class="source-code">             WRITE( PRTFile, * ) gammaV( iS - 1 ), gammaV( iS ), gamma</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">269</div>
            <div class="execution-count">#####</div>
            <div class="source-code">             CYCLE RcvrRanges</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">270</div>
            <div class="execution-count">-</div>
            <div class="source-code">          END IF</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">271</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">272</div>
            <div class="execution-count">#####</div>
            <div class="source-code">          const = Ratio1 * SQRT( c * ABS( epsV( iS - 1 ) ) / q )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">273</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">274</div>
            <div class="execution-count">-</div>
            <div class="source-code">          ! Get correct branch of SQRT</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">275</div>
            <div class="execution-count">#####</div>
            <div class="source-code">          KMAH = KMAHV( iS - 1 )</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">276</div>
            <div class="execution-count">#####</div>
            <div class="source-code">          CALL BranchCut( qVB( iS - 1 ), q, Beam%Type, KMAH )</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">277</div>
            <div class="execution-count">#####</div>
            <div class="source-code">          IF ( KMAH &lt; 0 ) const = -const</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">278</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">279</div>
            <div class="execution-count">#####</div>
            <div class="source-code">          RcvrDepths: DO iz = 1, NRz_per_range</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">280</div>
            <div class="execution-count">#####</div>
            <div class="source-code">             zR = Pos%Rz( iz )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">281</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">282</div>
            <div class="execution-count">#####</div>
            <div class="source-code">             contri = 0.0</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">283</div>
            <div class="execution-count">#####</div>
            <div class="source-code">             ImageLoop: DO Image = 1, Beam%Nimage</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">284</div>
            <div class="execution-count">#####</div>
            <div class="source-code">                SELECT CASE ( Image )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">285</div>
            <div class="execution-count">-</div>
            <div class="source-code">                CASE ( 1 )   ! True beam</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">286</div>
            <div class="execution-count">#####</div>
            <div class="source-code">                   deltaz = zR - x( 2 )</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">287</div>
            <div class="execution-count">#####</div>
            <div class="source-code">                   Polarity = +1.0D0</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">288</div>
            <div class="execution-count">-</div>
            <div class="source-code">                CASE ( 2 )   ! Surface reflected beam</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">289</div>
            <div class="execution-count">#####</div>
            <div class="source-code">                   deltaz = -zR + 2.0 * Bdry%Top%HS%Depth - x( 2 )</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">290</div>
            <div class="execution-count">#####</div>
            <div class="source-code">                   Polarity = -1.0D0</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">291</div>
            <div class="execution-count">-</div>
            <div class="source-code">                CASE ( 3 )   ! Bottom  reflected beam</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">292</div>
            <div class="execution-count">#####</div>
            <div class="source-code">                   deltaz = -zR + 2.0 * Bdry%Bot%HS%Depth - x( 2 )</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">293</div>
            <div class="execution-count">#####</div>
            <div class="source-code">                   Polarity = +1.0D0   ! assumes rigid bottom</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">294</div>
            <div class="execution-count">-</div>
            <div class="source-code">                END SELECT</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">295</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">296</div>
            <div class="execution-count">#####</div>
            <div class="source-code">                IF ( omega * AIMAG( gamma ) * deltaz ** 2 &lt; iBeamWindow2 ) &amp;</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">297</div>
            <div class="execution-count">#####</div>
            <div class="source-code">                     contri =  contri + Polarity * ray2D( iS )%Amp * Hermite( deltaz, RadiusMax, 2.0 * RadiusMax ) * &amp;</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">298</div>
            <div class="execution-count">#####</div>
            <div class="source-code">                     EXP( -i * ( omega * ( tau + rayt( 2 ) * deltaz + gamma * deltaz**2 ) - ray2D( iS )%Phase ) )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">299</div>
            <div class="execution-count">-</div>
            <div class="source-code">             END DO ImageLoop</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">300</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">301</div>
            <div class="execution-count">-</div>
            <div class="source-code">             ! contribution to field</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">302</div>
            <div class="execution-count">#####</div>
            <div class="source-code">             SELECT CASE( Beam%RunType( 1 : 1 ) )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">303</div>
            <div class="execution-count">-</div>
            <div class="source-code">             CASE ( &#x27;C&#x27; )        ! coherent</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">304</div>
            <div class="execution-count">#####</div>
            <div class="source-code">                contri = const * contri</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">305</div>
            <div class="execution-count">-</div>
            <div class="source-code">             CASE ( &#x27;I&#x27;, &#x27;S&#x27; )   ! incoherent or semi-coherent</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">306</div>
            <div class="execution-count">#####</div>
            <div class="source-code">                contri = ABS( const * contri ) ** 2</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">307</div>
            <div class="execution-count">-</div>
            <div class="source-code">             END SELECT</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">308</div>
            <div class="execution-count">#####</div>
            <div class="source-code">             U( iz, ir ) = U( iz, ir ) + CMPLX( contri )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">309</div>
            <div class="execution-count">-</div>
            <div class="source-code">          END DO RcvrDepths</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">310</div>
            <div class="execution-count">-</div>
            <div class="source-code">       END DO RcvrRanges</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">311</div>
            <div class="execution-count">-</div>
            <div class="source-code">    END DO Stepping</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">312</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">313</div>
            <div class="execution-count">-</div>
            <div class="source-code">  END SUBROUTINE InfluenceCervenyCart</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">314</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">315</div>
            <div class="execution-count">-</div>
            <div class="source-code">  ! **********************************************************************!</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">316</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">317</div>
            <div class="execution-count">#####</div>
            <div class="source-code">  SUBROUTINE InfluenceGeoHatRayCen( U, alpha, dalpha )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">318</div>
            <div class="execution-count">-</div>
            <div class="source-code">  !! Geometrically-spreading beams with a hat-shaped beam in ray-centered coordinates</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">319</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">320</div>
            <div class="execution-count">-</div>
            <div class="source-code">    REAL (KIND=8), INTENT( IN    ) :: alpha, dalpha                 ! take-off angle</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">321</div>
            <div class="execution-count">-</div>
            <div class="source-code">    COMPLEX,       INTENT( INOUT ) :: U( NRz_per_range, Pos%NRr )   ! complex pressure field</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">322</div>
            <div class="execution-count">-</div>
            <div class="source-code">    INTEGER          :: irA, irB, II</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">323</div>
            <div class="execution-count">#####</div>
            <div class="source-code">    REAL    (KIND=8) :: nA, nB, zr, L, dq( Beam%Nsteps - 1 )</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">324</div>
            <div class="execution-count">#####</div>
            <div class="source-code">    REAL    (KIND=8) :: znV( Beam%Nsteps ), rnV( Beam%Nsteps ),  RcvrDeclAngleV ( Beam%Nsteps )</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">325</div>
            <div class="execution-count">#####</div>
            <div class="source-code">    COMPLEX (KIND=8) :: dtau( Beam%Nsteps - 1 )</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">326</div>
            <div class="execution-count">#####</div>
            <div class="source-code">    REAL    (KIND=8) :: KMAHphase( Beam%Nsteps )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">327</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">328</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! need to add logic related to NRz_per_range</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">329</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">330</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! LP: See discussion of this change in the readme.</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">331</div>
            <div class="execution-count">#####</div>
            <div class="source-code">    qOld = ray2D( 1 )%q( 1 )</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">332</div>
            <div class="execution-count">#####</div>
            <div class="source-code">    phase = 0</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">333</div>
            <div class="execution-count">#####</div>
            <div class="source-code">    KMAHphase( 1 ) = 0</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">334</div>
            <div class="execution-count">#####</div>
            <div class="source-code">    DO is = 2, Beam%Nsteps</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">335</div>
            <div class="execution-count">#####</div>
            <div class="source-code">       q = ray2D( is )%q( 1 )</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">336</div>
            <div class="execution-count">#####</div>
            <div class="source-code">       CALL IncPhaseIfCaustic( .TRUE. )</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">337</div>
            <div class="execution-count">#####</div>
            <div class="source-code">       qOld = q</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">338</div>
            <div class="execution-count">#####</div>
            <div class="source-code">       KMAHphase( is ) = phase</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">339</div>
            <div class="execution-count">-</div>
            <div class="source-code">    END DO</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">340</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">341</div>
            <div class="execution-count">#####</div>
            <div class="source-code">    q0           = ray2D( 1 )%c / Dalpha   ! Reference for J = q0 / q</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">342</div>
            <div class="execution-count">#####</div>
            <div class="source-code">    SrcDeclAngle = RadDeg * alpha          ! take-off angle in degrees</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">343</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">344</div>
            <div class="execution-count">#####</div>
            <div class="source-code">    dq   = ray2D( 2 : Beam%Nsteps )%q( 1 ) - ray2D( 1 : Beam%Nsteps - 1 )%q( 1 )</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">345</div>
            <div class="execution-count">#####</div>
            <div class="source-code">    dtau = ray2D( 2 : Beam%Nsteps )%tau    - ray2D( 1 : Beam%Nsteps - 1 )%tau</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">346</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">347</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! pre-calculate ray normal based on tangent with c(s) scaling</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">348</div>
            <div class="execution-count">#####</div>
            <div class="source-code">    znV = -ray2D( 1 : Beam%Nsteps )%t( 1 ) * ray2D( 1 : Beam%Nsteps )%c</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">349</div>
            <div class="execution-count">#####</div>
            <div class="source-code">    rnV =  ray2D( 1 : Beam%Nsteps )%t( 2 ) * ray2D( 1 : Beam%Nsteps )%c</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">350</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">351</div>
            <div class="execution-count">#####</div>
            <div class="source-code">    RcvrDeclAngleV( 1 : Beam%Nsteps ) = RadDeg * ATAN2( ray2D( 1 : Beam%Nsteps )%t( 2 ), ray2D( 1 : Beam%Nsteps )%t( 1 ) )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">352</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">353</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! During reflection imag(q) is constant and adjacent normals cannot bracket a segment of the TL</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">354</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! line, so no special treatment is necessary</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">355</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">356</div>
            <div class="execution-count">#####</div>
            <div class="source-code">    IF ( Beam%RunType( 4 : 4 ) == &#x27;R&#x27; ) Ratio1 = SQRT( ABS( COS( alpha ) ) )  ! point source</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">357</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">358</div>
            <div class="execution-count">#####</div>
            <div class="source-code">    ray2D( 1 : Beam%Nsteps )%Amp = Ratio1 * SQRT( ray2D( 1 : Beam%Nsteps )%c ) * ray2D( 1 : Beam%Nsteps )%Amp   ! pre-apply some scaling</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">359</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">360</div>
            <div class="execution-count">#####</div>
            <div class="source-code">    RcvrDepths: DO iz = 1, NRz_per_range</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">361</div>
            <div class="execution-count">#####</div>
            <div class="source-code">       zR = Pos%Rz( iz )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">362</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">363</div>
            <div class="execution-count">#####</div>
            <div class="source-code">       IF ( ABS( znV( 1 ) ) &lt; 1D-6 ) THEN   ! normal parallel to horizontal receiver line</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">364</div>
            <div class="execution-count">#####</div>
            <div class="source-code">          nA  = 1D10</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">365</div>
            <div class="execution-count">#####</div>
            <div class="source-code">          rA  = 1D10</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">366</div>
            <div class="execution-count">#####</div>
            <div class="source-code">          irA = 1</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">367</div>
            <div class="execution-count">-</div>
            <div class="source-code">       ELSE</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">368</div>
            <div class="execution-count">#####</div>
            <div class="source-code">          nA  = ( zR - ray2D( 1 )%x( 2 )   ) / znV( 1 )</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">369</div>
            <div class="execution-count">#####</div>
            <div class="source-code">          rA  = ray2D( 1 )%x( 1 ) + nA * rnV( 1 )</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">370</div>
            <div class="execution-count">#####</div>
            <div class="source-code">          irA = RToIR( rA )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">371</div>
            <div class="execution-count">-</div>
            <div class="source-code">       END IF</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">372</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">373</div>
            <div class="execution-count">#####</div>
            <div class="source-code">       Stepping: DO iS = 2, Beam%Nsteps</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">374</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">375</div>
            <div class="execution-count">-</div>
            <div class="source-code">          ! Compute ray-centered coordinates, (znV, rnV)</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">376</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">377</div>
            <div class="execution-count">#####</div>
            <div class="source-code">          IF ( ABS( znV( iS ) ) &lt; 1D-10 ) CYCLE Stepping   ! If normal parallel to TL-line, skip to next step on ray</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">378</div>
            <div class="execution-count">#####</div>
            <div class="source-code">          nB  = ( zR - ray2D( iS )%x( 2 )   ) / znV( iS )</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">379</div>
            <div class="execution-count">#####</div>
            <div class="source-code">          rB  = ray2D( iS )%x( 1 ) + nB * rnV( iS )</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">380</div>
            <div class="execution-count">#####</div>
            <div class="source-code">          irB = RToIR( rB )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">381</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">382</div>
            <div class="execution-count">-</div>
            <div class="source-code">          ! detect and skip duplicate points (happens at boundary reflection)</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">383</div>
            <div class="execution-count">#####</div>
            <div class="source-code">          IF ( ABS( ray2D( iS )%x( 1 ) - ray2D( iS - 1 )%x( 1 ) ) &lt; 1.0D3 * SPACING( ray2D( iS )%x( 1 ) ) .OR. irA == irB ) THEN</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">384</div>
            <div class="execution-count">#####</div>
            <div class="source-code">             rA  = rB</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">385</div>
            <div class="execution-count">#####</div>
            <div class="source-code">             nA  = nB</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">386</div>
            <div class="execution-count">#####</div>
            <div class="source-code">             irA = irB</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">387</div>
            <div class="execution-count">#####</div>
            <div class="source-code">             CYCLE Stepping</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">388</div>
            <div class="execution-count">-</div>
            <div class="source-code">          END IF</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">389</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">390</div>
            <div class="execution-count">#####</div>
            <div class="source-code">          RcvrDeclAngle = RcvrDeclAngleV( iS )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">391</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">392</div>
            <div class="execution-count">-</div>
            <div class="source-code">          ! *** Compute contributions to bracketed receivers ***</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">393</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">394</div>
            <div class="execution-count">#####</div>
            <div class="source-code">          II = 0</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">395</div>
            <div class="execution-count">#####</div>
            <div class="source-code">          IF ( irB &lt;= irA ) II = 1   ! going backwards in range</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">396</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">397</div>
            <div class="execution-count">#####</div>
            <div class="source-code">          RcvrRanges: DO ir = irA + 1 - II, irB + II, SIGN( 1, irB - irA )  ! Compute influence for each rcvr</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">398</div>
            <div class="execution-count">#####</div>
            <div class="source-code">             W = ( Pos%Rr( ir ) - rA ) / ( rB - rA )</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">399</div>
            <div class="execution-count">#####</div>
            <div class="source-code">             n = ABS( nA                + W * ( nB - nA ) )</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">400</div>
            <div class="execution-count">#####</div>
            <div class="source-code">             q = ray2D( iS - 1 )%q( 1 ) + W * dq( iS - 1 )     ! interpolated amplitude</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">401</div>
            <div class="execution-count">#####</div>
            <div class="source-code">             L = ABS( q ) / q0   ! beam radius</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">402</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">403</div>
            <div class="execution-count">#####</div>
            <div class="source-code">             IF ( n &lt; L ) THEN   ! in beamwindow?</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">404</div>
            <div class="execution-count">#####</div>
            <div class="source-code">                delay    = ray2D( iS - 1 )%tau + W * dtau( iS - 1 )   ! interpolated delay</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">405</div>
            <div class="execution-count">#####</div>
            <div class="source-code">                const    = ray2D( iS )%Amp / SQRT( ABS( q ) )</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">406</div>
            <div class="execution-count">#####</div>
            <div class="source-code">                W        = ( L - n ) / L   ! hat function: 1 on center, 0 on edge</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">407</div>
            <div class="execution-count">#####</div>
            <div class="source-code">                Amp      = const * W</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">408</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">409</div>
            <div class="execution-count">#####</div>
            <div class="source-code">                phase = KMAHphase( iS - 1 )</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">410</div>
            <div class="execution-count">#####</div>
            <div class="source-code">                qOld = ray2D( is - 1 )%q( 1 )</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">411</div>
            <div class="execution-count">#####</div>
            <div class="source-code">                CALL FinalPhase( .FALSE. )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">412</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">413</div>
            <div class="execution-count">#####</div>
            <div class="source-code">                CALL ApplyContribution( U( iz, ir ) )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">414</div>
            <div class="execution-count">-</div>
            <div class="source-code">             END IF</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">415</div>
            <div class="execution-count">-</div>
            <div class="source-code">          END DO RcvrRanges</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">416</div>
            <div class="execution-count">#####</div>
            <div class="source-code">          rA  = rB</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">417</div>
            <div class="execution-count">#####</div>
            <div class="source-code">          nA  = nB</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">418</div>
            <div class="execution-count">#####</div>
            <div class="source-code">          irA = irB</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">419</div>
            <div class="execution-count">-</div>
            <div class="source-code">       END DO Stepping</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">420</div>
            <div class="execution-count">-</div>
            <div class="source-code">    END DO RcvrDepths</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">421</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">422</div>
            <div class="execution-count">#####</div>
            <div class="source-code">  END SUBROUTINE InfluenceGeoHatRayCen</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">423</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">424</div>
            <div class="execution-count">-</div>
            <div class="source-code">  ! **********************************************************************!</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">425</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line executed">
            <div class="line-number">426</div>
            <div class="execution-count">111280</div>
            <div class="source-code">  SUBROUTINE InfluenceGeoHatCart( U, alpha, Dalpha )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">427</div>
            <div class="execution-count">-</div>
            <div class="source-code">  !! Geometric, hat-shaped beams in Cartesisan coordinates</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">428</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">429</div>
            <div class="execution-count">-</div>
            <div class="source-code">    REAL (KIND=8), INTENT( IN    ) :: alpha, dalpha                 ! take-off angle, angular spacing</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">430</div>
            <div class="execution-count">-</div>
            <div class="source-code">    COMPLEX,       INTENT( INOUT ) :: U( NRz_per_range, Pos%NRr )   ! complex pressure field</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">431</div>
            <div class="execution-count">-</div>
            <div class="source-code">    INTEGER          :: irT( 1 ), irTT</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">432</div>
            <div class="execution-count">111280*</div>
            <div class="source-code">    REAL    (KIND=8) :: x_ray( 2 ), rayt( 2 ), rayn( 2 ), x_rcvr( 2, NRz_per_range ), rLen, RadiusMax, zMin, zMax, dqds</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">433</div>
            <div class="execution-count">-</div>
            <div class="source-code">    COMPLEX (KIND=8) :: dtauds</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">434</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line executed">
            <div class="line-number">435</div>
            <div class="execution-count">111280</div>
            <div class="source-code">    q0           = ray2D( 1 )%c / Dalpha   ! Reference for J = q0 / q</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">436</div>
            <div class="execution-count">111280</div>
            <div class="source-code">    SrcDeclAngle = RadDeg * alpha          ! take-off angle in degrees</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">437</div>
            <div class="execution-count">111280</div>
            <div class="source-code">    phase        = 0.0</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">438</div>
            <div class="execution-count">111280</div>
            <div class="source-code">    qOld         = ray2D( 1 )%q( 1 )       ! used to track KMAH index</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">439</div>
            <div class="execution-count">111280</div>
            <div class="source-code">    rA           = ray2D( 1 )%x( 1 )       ! range at start of ray</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">440</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">441</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! what if never satisfied?</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">442</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! what if there is a single receiver (ir = 0 possible)</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">443</div>
            <div class="execution-count">20856580*</div>
            <div class="source-code">    irT = MINLOC( Pos%Rr( 1 : Pos%NRr ), MASK = Pos%Rr( 1 : Pos%NRr ) &gt; rA )   ! find index of first receiver to the right of rA</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">444</div>
            <div class="execution-count">111280</div>
            <div class="source-code">    ir  = irT( 1 )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">445</div>
            <div class="execution-count">111280*</div>
            <div class="source-code">    IF ( ray2D( 1 )%t( 1 ) &lt; 0.0d0 .AND. ir &gt; 1 ) ir = ir - 1  ! if ray is left-traveling, get the first receiver to the left of rA</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">446</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line executed">
            <div class="line-number">447</div>
            <div class="execution-count">111280</div>
            <div class="source-code">    IF ( Beam%RunType( 4 : 4 ) == &#x27;R&#x27; ) Ratio1 = SQRT( ABS( COS( alpha ) ) )  ! point source</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">448</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">449</div>
            <div class="execution-count">29485159*</div>
            <div class="source-code">    Stepping: DO iS = 2, Beam%Nsteps</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">450</div>
            <div class="execution-count">29373879*</div>
            <div class="source-code">       rB     = ray2D( iS     )%x( 1 )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">451</div>
            <div class="execution-count">88121637*</div>
            <div class="source-code">       x_ray  = ray2D( iS - 1 )%x</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">452</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">453</div>
            <div class="execution-count">-</div>
            <div class="source-code">       ! compute normalized tangent (compute it because we need to measure the step length)</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">454</div>
            <div class="execution-count">88121637*</div>
            <div class="source-code">       rayt = ray2D( iS )%x - ray2D( iS - 1 )%x</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">455</div>
            <div class="execution-count">88121637</div>
            <div class="source-code">       rlen = NORM2( rayt )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">456</div>
            <div class="execution-count">29373879*</div>
            <div class="source-code">       IF ( rlen &lt; 1.0D3 * SPACING( ray2D( iS )%x( 1 ) ) ) CYCLE Stepping  ! if duplicate point in ray, skip to next step along the ray</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">457</div>
            <div class="execution-count">84498798</div>
            <div class="source-code">       rayt = rayt / rlen                    ! unit tangent to ray</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">458</div>
            <div class="execution-count">84498798</div>
            <div class="source-code">       rayn = [ -rayt( 2 ), rayt( 1 ) ]      ! unit normal  to ray</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">459</div>
            <div class="execution-count">28166266</div>
            <div class="source-code">       RcvrDeclAngle = RadDeg * ATAN2( rayt( 2 ), rayt( 1 ) )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">460</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">461</div>
            <div class="execution-count">28166266*</div>
            <div class="source-code">       dqds   = ray2D( iS )%q( 1 ) - ray2D( iS - 1 )%q( 1 )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">462</div>
            <div class="execution-count">28166266*</div>
            <div class="source-code">       dtauds = ray2D( iS )%tau    - ray2D( iS - 1 )%tau</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">463</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">464</div>
            <div class="execution-count">28166266*</div>
            <div class="source-code">       q  = ray2D( iS - 1 )%q( 1 )</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">465</div>
            <div class="execution-count">28166266</div>
            <div class="source-code">       CALL IncPhaseIfCaustic( .TRUE. )</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">466</div>
            <div class="execution-count">28166266</div>
            <div class="source-code">       qold = q</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">467</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">468</div>
            <div class="execution-count">28166266*</div>
            <div class="source-code">       RadiusMax = MAX( ABS( ray2D( iS - 1 )%q( 1 ) ), ABS( ray2D( iS )%q( 1 ) ) ) / q0 / ABS( rayt( 1 ) ) ! beam radius projected onto vertical line</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">469</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">470</div>
            <div class="execution-count">-</div>
            <div class="source-code">       ! depth limits of beam</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">471</div>
            <div class="execution-count">28166266</div>
            <div class="source-code">       IF ( ABS( rayt( 1 ) ) &gt; 0.5 ) THEN   ! shallow angle ray</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">472</div>
            <div class="execution-count">24621898*</div>
            <div class="source-code">          zmin   = min( ray2D( iS - 1 )%x( 2 ), ray2D( iS )%x( 2 ) ) - RadiusMax</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">473</div>
            <div class="execution-count">24621898*</div>
            <div class="source-code">          zmax   = max( ray2D( iS - 1 )%x( 2 ), ray2D( iS )%x( 2 ) ) + RadiusMax</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">474</div>
            <div class="execution-count">-</div>
            <div class="source-code">       ELSE                                 ! steep angle ray</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">475</div>
            <div class="execution-count">3544368</div>
            <div class="source-code">          zmin = -HUGE( zmin )</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">476</div>
            <div class="execution-count">3544368</div>
            <div class="source-code">          zmax = +HUGE( zmax )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">477</div>
            <div class="execution-count">-</div>
            <div class="source-code">       END IF</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">478</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">479</div>
            <div class="execution-count">-</div>
            <div class="source-code">       ! compute beam influence for this segment of the ray</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">480</div>
            <div class="execution-count">15044214</div>
            <div class="source-code">       RcvrRanges: DO</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">481</div>
            <div class="execution-count">-</div>
            <div class="source-code">          ! is Rr( ir ) contained in [ rA, rB )? Then compute beam influence</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">482</div>
            <div class="execution-count">43210480*</div>
            <div class="source-code">          IF ( Pos%Rr( ir ) &gt;= MIN( rA, rB ) .AND. Pos%Rr( ir ) &lt; MAX( rA, rB ) ) THEN</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">483</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">484</div>
            <div class="execution-count">594492674*</div>
            <div class="source-code">             x_rcvr( 1, 1 : NRz_per_range ) = Pos%Rr( ir )</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">485</div>
            <div class="execution-count">15095283</div>
            <div class="source-code">             IF ( Beam%RunType( 5 : 5 ) == &#x27;I&#x27; ) THEN</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">486</div>
            <div class="execution-count">#####</div>
            <div class="source-code">                x_rcvr( 2, 1 ) = Pos%Rz( ir )                  ! irregular   grid</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">487</div>
            <div class="execution-count">-</div>
            <div class="source-code">             ELSE</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">488</div>
            <div class="execution-count">594492674*</div>
            <div class="source-code">                x_rcvr( 2, 1 : NRz_per_range ) = Pos%Rz( 1 : NRz_per_range )   ! rectilinear grid</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">489</div>
            <div class="execution-count">-</div>
            <div class="source-code">             END IF</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">490</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">491</div>
            <div class="execution-count">594492674*</div>
            <div class="source-code">             RcvrDepths: DO iz = 1, NRz_per_range</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">492</div>
            <div class="execution-count">579397391*</div>
            <div class="source-code">                IF ( x_rcvr( 2, iz ) &lt; zmin .OR. x_rcvr( 2, iz ) &gt; zmax ) CYCLE RcvrDepths</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">493</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">494</div>
            <div class="execution-count">524664210*</div>
            <div class="source-code">                s         =      DOT_PRODUCT( x_rcvr( :, iz ) - x_ray, rayt ) / rlen ! proportional distance along ray</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">495</div>
            <div class="execution-count">524664210*</div>
            <div class="source-code">                n         = ABS( DOT_PRODUCT( x_rcvr( :, iz ) - x_ray, rayn ) )      ! normal distance to ray</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">496</div>
            <div class="execution-count">174888070*</div>
            <div class="source-code">                q         = ray2D( iS - 1 )%q( 1 ) + s * dqds               ! interpolated amplitude</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">497</div>
            <div class="execution-count">174888070</div>
            <div class="source-code">                RadiusMax = ABS( q / q0 )                                   ! beam radius</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">498</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line executed">
            <div class="line-number">499</div>
            <div class="execution-count">189983353</div>
            <div class="source-code">                IF ( n &lt; RadiusMax ) THEN</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">500</div>
            <div class="execution-count">4846997*</div>
            <div class="source-code">                   delay    = ray2D( iS - 1 )%tau + s * dtauds              ! interpolated delay</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">501</div>
            <div class="execution-count">4846997*</div>
            <div class="source-code">                   const    = Ratio1 * SQRT( ray2D( iS )%c / ABS( q ) ) * ray2D( iS )%Amp</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">502</div>
            <div class="execution-count">4846997</div>
            <div class="source-code">                   W        = ( RadiusMax - n ) / RadiusMax   ! hat function: 1 on center, 0 on edge</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">503</div>
            <div class="execution-count">4846997</div>
            <div class="source-code">                   Amp      = const * W</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">504</div>
            <div class="execution-count">4846997</div>
            <div class="source-code">                   CALL FinalPhase( .FALSE. )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">505</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">506</div>
            <div class="execution-count">4846997*</div>
            <div class="source-code">                   CALL ApplyContribution( U( iz, ir ) )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">507</div>
            <div class="execution-count">-</div>
            <div class="source-code">                END IF</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">508</div>
            <div class="execution-count">-</div>
            <div class="source-code">             END DO RcvrDepths</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">509</div>
            <div class="execution-count">-</div>
            <div class="source-code">          END IF</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">510</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">511</div>
            <div class="execution-count">-</div>
            <div class="source-code">          ! bump receiver index, ir, towards rB</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">512</div>
            <div class="execution-count">43210480*</div>
            <div class="source-code">          IF ( Pos%Rr( ir ) &lt; rB ) THEN</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">513</div>
            <div class="execution-count">23283818</div>
            <div class="source-code">             IF ( ir &gt;= Pos%NRr        ) EXIT RcvrRanges  ! go to next step on ray</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">514</div>
            <div class="execution-count">23081251</div>
            <div class="source-code">             irTT = ir + 1                                ! bump right</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">515</div>
            <div class="execution-count">23081251*</div>
            <div class="source-code">             IF ( Pos%Rr( irTT ) &gt;= rB ) EXIT RcvrRanges</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">516</div>
            <div class="execution-count">-</div>
            <div class="source-code">          ELSE</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">517</div>
            <div class="execution-count">19926662</div>
            <div class="source-code">             IF ( ir &lt;= 1              ) EXIT RcvrRanges  ! go to next step on ray</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">518</div>
            <div class="execution-count">124823</div>
            <div class="source-code">             irTT = ir - 1                                ! bump left</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">519</div>
            <div class="execution-count">124823*</div>
            <div class="source-code">             IF ( Pos%Rr( irTT ) &lt;= rB ) EXIT RcvrRanges</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">520</div>
            <div class="execution-count">-</div>
            <div class="source-code">          END IF</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">521</div>
            <div class="execution-count">15044214</div>
            <div class="source-code">          ir = irTT</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">522</div>
            <div class="execution-count">-</div>
            <div class="source-code">       END DO RcvrRanges</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">523</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line executed">
            <div class="line-number">524</div>
            <div class="execution-count">28277546</div>
            <div class="source-code">       rA = rB</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">525</div>
            <div class="execution-count">-</div>
            <div class="source-code">    END DO Stepping</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">526</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line executed">
            <div class="line-number">527</div>
            <div class="execution-count">111280</div>
            <div class="source-code">  END SUBROUTINE InfluenceGeoHatCart</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">528</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">529</div>
            <div class="execution-count">-</div>
            <div class="source-code">  ! **********************************************************************!</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">530</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line executed">
            <div class="line-number">531</div>
            <div class="execution-count">4600</div>
            <div class="source-code">  SUBROUTINE InfluenceGeoGaussianCart( U, alpha, Dalpha )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">532</div>
            <div class="execution-count">-</div>
            <div class="source-code">  !! Geometric, Gaussian beams in Cartesian coordintes</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">533</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">534</div>
            <div class="execution-count">-</div>
            <div class="source-code">    INTEGER,       PARAMETER       :: BeamWindow = 4               ! beam window: kills beams outside e**(-0.5 * ibwin**2 )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">535</div>
            <div class="execution-count">-</div>
            <div class="source-code">    REAL (KIND=8), INTENT( IN    ) :: alpha, dalpha                ! take-off angle, angular spacing</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">536</div>
            <div class="execution-count">-</div>
            <div class="source-code">    COMPLEX,       INTENT( INOUT ) :: U( NRz_per_range, Pos%NRr )  ! complex pressure field</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">537</div>
            <div class="execution-count">-</div>
            <div class="source-code">    INTEGER          :: irT( 1 ), irTT</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">538</div>
            <div class="execution-count">-</div>
            <div class="source-code">    REAL    (KIND=8) :: x_ray( 2 ), rayt( 2 ), rayn( 2 ), x_rcvr( 2 ), rLen, RadiusMax, zMin, zMax, sigma, lambda, A, dqds</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">539</div>
            <div class="execution-count">-</div>
            <div class="source-code">    COMPLEX (KIND=8) :: dtauds</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">540</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line executed">
            <div class="line-number">541</div>
            <div class="execution-count">4600</div>
            <div class="source-code">    q0           = ray2D( 1 )%c / Dalpha   ! Reference for J = q0 / q</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">542</div>
            <div class="execution-count">4600</div>
            <div class="source-code">    SrcDeclAngle = RadDeg * alpha          ! take-off angle in degrees</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">543</div>
            <div class="execution-count">4600</div>
            <div class="source-code">    phase        = 0</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">544</div>
            <div class="execution-count">4600</div>
            <div class="source-code">    qOld         = ray2D( 1 )%q( 1 )       ! used to track KMAH index</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">545</div>
            <div class="execution-count">4600</div>
            <div class="source-code">    rA           = ray2D( 1 )%x( 1 )       ! range at start of ray</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">546</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">547</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! what if never satisfied?</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">548</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! what if there is a single receiver (ir = 0 possible)</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">549</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">550</div>
            <div class="execution-count">4609200*</div>
            <div class="source-code">    irT = MINLOC( Pos%Rr( 1 : Pos%NRr ), MASK = Pos%Rr( 1 : Pos%NRr ) &gt; rA )      ! find index of first receiver to the right of rA</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">551</div>
            <div class="execution-count">4600</div>
            <div class="source-code">    ir  = irT( 1 )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">552</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">553</div>
            <div class="execution-count">4600*</div>
            <div class="source-code">    IF ( ray2D( 1 )%t( 1 ) &lt; 0.0d0 .AND. ir &gt; 1 ) ir = ir - 1  ! if ray is left-traveling, get the first receiver to the left of rA</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">554</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">555</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! sqrt( 2 * pi ) represents a sum of Gaussians in free space</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">556</div>
            <div class="execution-count">4600</div>
            <div class="source-code">    IF ( Beam%RunType( 4 : 4 ) == &#x27;R&#x27; ) THEN</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">557</div>
            <div class="execution-count">4600</div>
            <div class="source-code">       Ratio1 = SQRT( ABS( COS( alpha ) ) ) / SQRT( 2. * pi )   ! point source</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">558</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ELSE</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">559</div>
            <div class="execution-count">#####</div>
            <div class="source-code">       Ratio1 = 1 / SQRT( 2. * pi )                             ! line  source</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">560</div>
            <div class="execution-count">-</div>
            <div class="source-code">    END IF</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">561</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">562</div>
            <div class="execution-count">1103577*</div>
            <div class="source-code">    Stepping: DO iS = 2, Beam%Nsteps</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">563</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">564</div>
            <div class="execution-count">1098977*</div>
            <div class="source-code">       rB    = ray2D( iS     )%x( 1 )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">565</div>
            <div class="execution-count">3296931*</div>
            <div class="source-code">       x_ray = ray2D( iS - 1 )%x</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">566</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">567</div>
            <div class="execution-count">-</div>
            <div class="source-code">       ! compute normalized tangent (compute it because we need to measure the step length)</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">568</div>
            <div class="execution-count">3296931*</div>
            <div class="source-code">       rayt = ray2D( iS )%x - ray2D( iS - 1 )%x</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">569</div>
            <div class="execution-count">3296931</div>
            <div class="source-code">       rlen = NORM2( rayt )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">570</div>
            <div class="execution-count">1098977*</div>
            <div class="source-code">       IF ( rlen &lt; 1.0D3 * SPACING( ray2D( iS )%x( 1 ) ) ) CYCLE Stepping  ! if duplicate point in ray, skip to next step along the ray</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">571</div>
            <div class="execution-count">3190617</div>
            <div class="source-code">       rayt = rayt / rlen</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">572</div>
            <div class="execution-count">3190617</div>
            <div class="source-code">       rayn = [ -rayt( 2 ), rayt( 1 ) ]      ! unit normal to ray</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">573</div>
            <div class="execution-count">1063539</div>
            <div class="source-code">       RcvrDeclAngle = RadDeg * ATAN2( rayt( 2 ), rayt( 1 ) )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">574</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">575</div>
            <div class="execution-count">1063539*</div>
            <div class="source-code">       dqds   = ray2D( iS )%q( 1 ) - ray2D( iS - 1 )%q( 1 )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">576</div>
            <div class="execution-count">1063539*</div>
            <div class="source-code">       dtauds = ray2D( iS )%tau    - ray2D( iS - 1 )%tau</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">577</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">578</div>
            <div class="execution-count">1063539*</div>
            <div class="source-code">       q  = ray2D( iS - 1 )%q( 1 )</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">579</div>
            <div class="execution-count">1063539</div>
            <div class="source-code">       CALL IncPhaseIfCaustic( .TRUE. )</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">580</div>
            <div class="execution-count">1063539</div>
            <div class="source-code">       qold = q</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">581</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">582</div>
            <div class="execution-count">-</div>
            <div class="source-code">       ! calculate beam width</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">583</div>
            <div class="execution-count">1063539*</div>
            <div class="source-code">       lambda    = ray2D( iS - 1 )%c / freq</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">584</div>
            <div class="execution-count">1063539*</div>
            <div class="source-code">       sigma     = MAX( ABS( ray2D( iS - 1 )%q( 1 ) ), ABS( ray2D( iS )%q( 1 ) ) ) / q0 / ABS( rayt( 1 ) ) ! beam radius projected onto vertical line</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">585</div>
            <div class="execution-count">1063539*</div>
            <div class="source-code">       sigma     = MAX( sigma, MIN( 0.2 * freq * REAL( ray2D( iS )%tau ), pi * lambda ) )</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">586</div>
            <div class="execution-count">1063539</div>
            <div class="source-code">       RadiusMax = BeamWindow * sigma</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">587</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">588</div>
            <div class="execution-count">-</div>
            <div class="source-code">       ! depth limits of beam</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">589</div>
            <div class="execution-count">-</div>
            <div class="source-code">       ! LP: For rays shot at exactly 60 degrees, they will hit this edge case.</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">590</div>
            <div class="execution-count">-</div>
            <div class="source-code">       ! This is a sharp edge--the handling on each side of this edge may be</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">591</div>
            <div class="execution-count">-</div>
            <div class="source-code">       ! significantly different. So, moved the edge away from the round number.</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">592</div>
            <div class="execution-count">1063539</div>
            <div class="source-code">       IF ( ABS( rayt( 1 ) ) &gt; 0.50001 ) THEN   ! shallow angle ray</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">593</div>
            <div class="execution-count">827017*</div>
            <div class="source-code">          zmin   = min( ray2D( iS - 1 )%x( 2 ), ray2D( iS )%x( 2 ) ) - RadiusMax</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">594</div>
            <div class="execution-count">827017*</div>
            <div class="source-code">          zmax   = max( ray2D( iS - 1 )%x( 2 ), ray2D( iS )%x( 2 ) ) + RadiusMax</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">595</div>
            <div class="execution-count">-</div>
            <div class="source-code">       ELSE                                 ! steep angle ray</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">596</div>
            <div class="execution-count">236522</div>
            <div class="source-code">          zmin = -HUGE( zmin )</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">597</div>
            <div class="execution-count">236522</div>
            <div class="source-code">          zmax = +HUGE( zmax )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">598</div>
            <div class="execution-count">-</div>
            <div class="source-code">       END IF</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">599</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">600</div>
            <div class="execution-count">-</div>
            <div class="source-code">       ! compute beam influence for this segment of the ray</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">601</div>
            <div class="execution-count">1510842</div>
            <div class="source-code">       RcvrRanges: DO</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">602</div>
            <div class="execution-count">-</div>
            <div class="source-code">          ! WRITE( PRTFile, * ) &#x27;iS&#x27;, iS-2, &#x27;ir&#x27;, ir-1</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">603</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">604</div>
            <div class="execution-count">-</div>
            <div class="source-code">          ! is Rr( ir ) contained in [ rA, rB )? Then compute beam influence</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">605</div>
            <div class="execution-count">2574381*</div>
            <div class="source-code">          IF ( Pos%Rr( ir ) &gt;= MIN( rA, rB ) .AND. Pos%Rr( ir ) &lt; MAX( rA, rB ) ) THEN</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">606</div>
            <div class="execution-count">-</div>
            <div class="source-code">             ! WRITE( PRTFile, * ) &#x27;  rA&#x27;, rA, &#x27;rB&#x27;, rB</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">607</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">608</div>
            <div class="execution-count">913432660*</div>
            <div class="source-code">             RcvrDepths: DO iz = 1, NRz_per_range</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">609</div>
            <div class="execution-count">911915330</div>
            <div class="source-code">                IF ( Beam%RunType( 5 : 5 ) == &#x27;I&#x27; ) THEN</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">610</div>
            <div class="execution-count">#####</div>
            <div class="source-code">                   x_rcvr = [ Pos%Rr( ir ), Pos%Rz( ir ) ]   ! irregular   grid</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">611</div>
            <div class="execution-count">-</div>
            <div class="source-code">                ELSE</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">612</div>
            <div class="execution-count">2735745990*</div>
            <div class="source-code">                   x_rcvr = [ Pos%Rr( ir ), Pos%Rz( iz ) ]   ! rectilinear grid</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">613</div>
            <div class="execution-count">-</div>
            <div class="source-code">                END IF</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">614</div>
            <div class="execution-count">911915330</div>
            <div class="source-code">                IF ( x_rcvr( 2 ) &lt; zmin .OR. x_rcvr( 2 ) &gt; zmax ) CYCLE RcvrDepths</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">615</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line executed">
            <div class="line-number">616</div>
            <div class="execution-count">338916528</div>
            <div class="source-code">                s      =      DOT_PRODUCT( x_rcvr - x_ray, rayt ) / rlen  ! proportional distance along ray</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">617</div>
            <div class="execution-count">338916528</div>
            <div class="source-code">                n      = ABS( DOT_PRODUCT( x_rcvr - x_ray, rayn ) )       ! normal distance to ray</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">618</div>
            <div class="execution-count">112972176*</div>
            <div class="source-code">                q      = ray2D( iS - 1 )%q( 1 ) + s * dqds                ! interpolated amplitude</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">619</div>
            <div class="execution-count">112972176</div>
            <div class="source-code">                sigma  = ABS( q / q0 )                                    ! beam radius</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">620</div>
            <div class="execution-count">112972176*</div>
            <div class="source-code">                sigma  = MAX( sigma, MIN( 0.2 * freq * REAL( ray2D( iS )%tau ), pi * lambda ) )  ! min pi * lambda, unless near</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">621</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line executed">
            <div class="line-number">622</div>
            <div class="execution-count">114489506</div>
            <div class="source-code">                IF ( n &lt; BeamWindow * sigma ) THEN   ! Within beam window?</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">623</div>
            <div class="execution-count">-</div>
            <div class="source-code">                   ! IF ( ir-1 &gt;= 0 .AND. ir-1 &lt;= 2 ) THEN</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">624</div>
            <div class="execution-count">-</div>
            <div class="source-code">                   !    WRITE( PRTFile, * ) &#x27;    iz n sigma&#x27;, iz-1, n, sigma</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">625</div>
            <div class="execution-count">-</div>
            <div class="source-code">                   ! END IF</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">626</div>
            <div class="execution-count">75828128</div>
            <div class="source-code">                   A        = ABS( q0 / q )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">627</div>
            <div class="execution-count">75828128*</div>
            <div class="source-code">                   delay    = ray2D( iS - 1 )%tau + s * dtauds     ! interpolated delay</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">628</div>
            <div class="execution-count">75828128*</div>
            <div class="source-code">                   const    = Ratio1 * SQRT( ray2D( iS )%c / ABS( q ) ) * ray2D( iS )%Amp</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">629</div>
            <div class="execution-count">75828128</div>
            <div class="source-code">                   W        = EXP( -0.5 * ( n / sigma ) ** 2 ) / ( sigma * A )   ! Gaussian decay</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">630</div>
            <div class="execution-count">75828128</div>
            <div class="source-code">                   Amp      = const * W</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">631</div>
            <div class="execution-count">75828128</div>
            <div class="source-code">                   CALL FinalPhase( .TRUE. )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">632</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">633</div>
            <div class="execution-count">75828128*</div>
            <div class="source-code">                   CALL ApplyContribution( U( iz, ir ) )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">634</div>
            <div class="execution-count">-</div>
            <div class="source-code">                END IF</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">635</div>
            <div class="execution-count">-</div>
            <div class="source-code">             END DO RcvrDepths</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">636</div>
            <div class="execution-count">-</div>
            <div class="source-code">          END IF</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">637</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">638</div>
            <div class="execution-count">-</div>
            <div class="source-code">          ! receiver not bracketed; bump receiver index, ir, towards rB</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">639</div>
            <div class="execution-count">2574381*</div>
            <div class="source-code">          IF ( rB &gt; Pos%Rr( ir ) ) THEN</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">640</div>
            <div class="execution-count">2499035</div>
            <div class="source-code">             IF ( ir &gt;= Pos%NRr        ) EXIT RcvrRanges  ! go to next step on ray</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">641</div>
            <div class="execution-count">2495513</div>
            <div class="source-code">             irTT = ir + 1                                ! bump right</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">642</div>
            <div class="execution-count">2495513*</div>
            <div class="source-code">             IF ( Pos%Rr( irTT ) &gt;= rB ) EXIT RcvrRanges  ! go to next step on ray</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">643</div>
            <div class="execution-count">-</div>
            <div class="source-code">          ELSE</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">644</div>
            <div class="execution-count">75346*</div>
            <div class="source-code">             IF ( ir &lt;= 1              ) EXIT RcvrRanges  ! go to next step on ray</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">645</div>
            <div class="execution-count">75346</div>
            <div class="source-code">             irTT = ir - 1                                ! bump left</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">646</div>
            <div class="execution-count">75346*</div>
            <div class="source-code">             IF ( Pos%Rr( irTT ) &lt;= rB ) EXIT RcvrRanges  ! go to next step on ray</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">647</div>
            <div class="execution-count">-</div>
            <div class="source-code">          END IF</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">648</div>
            <div class="execution-count">1510842</div>
            <div class="source-code">          ir = irTT</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">649</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">650</div>
            <div class="execution-count">-</div>
            <div class="source-code">       END DO RcvrRanges</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">651</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line executed">
            <div class="line-number">652</div>
            <div class="execution-count">1068139</div>
            <div class="source-code">       rA = rB</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">653</div>
            <div class="execution-count">-</div>
            <div class="source-code">    END DO Stepping</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">654</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line executed">
            <div class="line-number">655</div>
            <div class="execution-count">4600</div>
            <div class="source-code">  END SUBROUTINE InfluenceGeoGaussianCart</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">656</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">657</div>
            <div class="execution-count">-</div>
            <div class="source-code">  ! **********************************************************************!</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">658</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line executed">
            <div class="line-number">659</div>
            <div class="execution-count">80675125</div>
            <div class="source-code">  SUBROUTINE ApplyContribution( U )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">660</div>
            <div class="execution-count">-</div>
            <div class="source-code">  !! Applies beam contribution to pressure field</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">661</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">662</div>
            <div class="execution-count">-</div>
            <div class="source-code">    COMPLEX, INTENT( INOUT ) :: U</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">663</div>
            <div class="execution-count">-</div>
            <div class="source-code">    COMPLEX ( KIND=4 ) :: dfield</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">664</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line executed">
            <div class="line-number">665</div>
            <div class="execution-count">340</div>
            <div class="source-code">    SELECT CASE( Beam%RunType( 1 : 1 ) )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">666</div>
            <div class="execution-count">-</div>
            <div class="source-code">    CASE ( &#x27;E&#x27; )                ! eigenrays</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">667</div>
            <div class="execution-count">680</div>
            <div class="source-code">       IF ( Title( 1 :  9 ) == &#x27;BELLHOP- &#x27; ) THEN   ! BELLHOP run</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">668</div>
            <div class="execution-count">340</div>
            <div class="source-code">          CALL WriteRay2D( SrcDeclAngle, iS )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">669</div>
            <div class="execution-count">-</div>
            <div class="source-code">       ELSE                                         ! BELLHOP3D run</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">670</div>
            <div class="execution-count">#####</div>
            <div class="source-code">          CALL WriteRay3D( DegRad * SrcDeclAngle, DegRad * SrcAzimAngle, is )   ! produces no output if NR=1</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">671</div>
            <div class="execution-count">-</div>
            <div class="source-code">       END IF</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">672</div>
            <div class="execution-count">-</div>
            <div class="source-code">    CASE ( &#x27;A&#x27;, &#x27;a&#x27; )           ! arrivals</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">673</div>
            <div class="execution-count">-</div>
            <div class="source-code">       CALL AddArr( omega, iz, ir, Amp, phaseInt, delay, SrcDeclAngle, &amp;</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">674</div>
            <div class="execution-count">1234*</div>
            <div class="source-code">                  &amp; RcvrDeclAngle, ray2D( iS )%NumTopBnc, ray2D( iS )%NumBotBnc )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">675</div>
            <div class="execution-count">-</div>
            <div class="source-code">    CASE ( &#x27;C&#x27; )                ! coherent TL</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">676</div>
            <div class="execution-count">80673551</div>
            <div class="source-code">       dfield = CMPLX( Amp * EXP( -i * ( omega * delay - phaseInt ) ) )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">677</div>
            <div class="execution-count">-</div>
            <div class="source-code">       ! WRITE( PRTFile, * ) &#x27;ApplyContribution dfield&#x27;, dfield</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">678</div>
            <div class="execution-count">80673551*</div>
            <div class="source-code">       U = U + dfield</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">679</div>
            <div class="execution-count">-</div>
            <div class="source-code">                     ! omega * n * n / ( 2 * ray2d( iS )%c**2 * delay ) ) ) )   ! curvature correction</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">680</div>
            <div class="execution-count">-</div>
            <div class="source-code">    CASE DEFAULT                ! incoherent/semicoherent TL</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">681</div>
            <div class="execution-count">80676359*</div>
            <div class="source-code">       IF ( Beam%Type( 1 : 1 ) == &#x27;B&#x27; ) THEN   ! Gaussian beam</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">682</div>
            <div class="execution-count">#####</div>
            <div class="source-code">          U = U + SNGL( SQRT( 2. * pi ) * ( const * EXP( AIMAG( omega * delay ) ) ) ** 2 * W )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">683</div>
            <div class="execution-count">-</div>
            <div class="source-code">       ELSE</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">684</div>
            <div class="execution-count">#####</div>
            <div class="source-code">          U = U + SNGL(                   ( const * EXP( AIMAG( omega * delay ) ) ) ** 2 * W )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">685</div>
            <div class="execution-count">-</div>
            <div class="source-code">       END IF</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">686</div>
            <div class="execution-count">-</div>
            <div class="source-code">    END SELECT</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">687</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line executed">
            <div class="line-number">688</div>
            <div class="execution-count">80675125</div>
            <div class="source-code">  END SUBROUTINE ApplyContribution</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">689</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">690</div>
            <div class="execution-count">-</div>
            <div class="source-code">  ! **********************************************************************!</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">691</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">692</div>
            <div class="execution-count">#####</div>
            <div class="source-code">  SUBROUTINE InfluenceSGB( U, alpha, Dalpha, RadiusMax )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">693</div>
            <div class="execution-count">-</div>
            <div class="source-code">  !! Bucker&#x27;s Simple Gaussian Beams in Cartesian coordinates</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">694</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">695</div>
            <div class="execution-count">-</div>
            <div class="source-code">    REAL (KIND=8), INTENT( IN    ) :: alpha, dalpha, RadiusMax      ! take-off angle, angular spacing</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">696</div>
            <div class="execution-count">-</div>
            <div class="source-code">    COMPLEX,       INTENT( INOUT ) :: U( NRz_per_range, Pos%NRr )   ! complex pressure field</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">697</div>
            <div class="execution-count">-</div>
            <div class="source-code">    REAL    (KIND=8)  :: x( 2 ), rayt( 2 ), A, beta, cn, CPA, Adeltaz, deltaz, DS, sint, SX1, thet</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">698</div>
            <div class="execution-count">-</div>
            <div class="source-code">    COMPLEX (KIND=8)  :: contri, tau</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">699</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">700</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! LP: Added ABS to match other influence functions. Without it, this will</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">701</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! crash (sqrt of negative real) for rays shot backwards.</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">702</div>
            <div class="execution-count">#####</div>
            <div class="source-code">    Ratio1 = SQRT( ABS( COS( alpha ) ) )</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">703</div>
            <div class="execution-count">#####</div>
            <div class="source-code">    phase  = 0</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">704</div>
            <div class="execution-count">#####</div>
            <div class="source-code">    qOld   = 1.0</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">705</div>
            <div class="execution-count">#####</div>
            <div class="source-code">    BETA   = 0.98  ! Beam Factor</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">706</div>
            <div class="execution-count">#####</div>
            <div class="source-code">    A      = -4.0 * LOG( BETA ) / Dalpha**2</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">707</div>
            <div class="execution-count">#####</div>
            <div class="source-code">    CN     = Dalpha * SQRT( A / pi )</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">708</div>
            <div class="execution-count">#####</div>
            <div class="source-code">    rA     = ray2D( 1 )%x( 1 )</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">709</div>
            <div class="execution-count">#####</div>
            <div class="source-code">    ir     = 1</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">710</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">711</div>
            <div class="execution-count">#####</div>
            <div class="source-code">    Stepping: DO iS = 2, Beam%Nsteps</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">712</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">713</div>
            <div class="execution-count">#####</div>
            <div class="source-code">       RcvrDeclAngle = RadDeg * ATAN2( ray2D( iS )%t( 2 ), ray2D( iS )%t( 1 ) )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">714</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">715</div>
            <div class="execution-count">#####</div>
            <div class="source-code">       rB = ray2D( iS )%x( 1 )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">716</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">717</div>
            <div class="execution-count">-</div>
            <div class="source-code">       ! phase shifts at caustics</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">718</div>
            <div class="execution-count">#####</div>
            <div class="source-code">       q  = ray2D( iS - 1 )%q( 1 )</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">719</div>
            <div class="execution-count">#####</div>
            <div class="source-code">       CALL IncPhaseIfCaustic( .FALSE. )</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">720</div>
            <div class="execution-count">#####</div>
            <div class="source-code">       qold = q</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">721</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">722</div>
            <div class="execution-count">-</div>
            <div class="source-code">       ! Loop over bracketed receiver ranges</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">723</div>
            <div class="execution-count">-</div>
            <div class="source-code">       ! LP: BUG: This way of setting up the loop assumes the ray always travels</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">724</div>
            <div class="execution-count">-</div>
            <div class="source-code">       ! towards positive R, which is not true for certain bathymetries (or for</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">725</div>
            <div class="execution-count">-</div>
            <div class="source-code">       ! rays simply shot backwards, which previously would also crash during</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">726</div>
            <div class="execution-count">-</div>
            <div class="source-code">       ! the setup, see above).</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">727</div>
            <div class="execution-count">#####</div>
            <div class="source-code">       RcvrRanges: DO WHILE ( ABS( rB - rA ) &gt; 1.0D3 * SPACING( rA ) .AND. rB &gt; Pos%Rr( ir ) )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">728</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">729</div>
            <div class="execution-count">#####</div>
            <div class="source-code">          W     = ( Pos%Rr( ir ) - rA ) / ( rB - rA )</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">730</div>
            <div class="execution-count">#####</div>
            <div class="source-code">          x     = ray2D( iS - 1 )%x      + W * ( ray2D( iS )%x      - ray2D( iS - 1 )%x )</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">731</div>
            <div class="execution-count">#####</div>
            <div class="source-code">          rayt  = ray2D( iS - 1 )%t      + W * ( ray2D( iS )%t      - ray2D( iS - 1 )%t )</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">732</div>
            <div class="execution-count">#####</div>
            <div class="source-code">          q     = ray2D( iS - 1 )%q( 1 ) + W * ( ray2D( iS )%q( 1 ) - ray2D( iS - 1 )%q( 1 ) )</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">733</div>
            <div class="execution-count">#####</div>
            <div class="source-code">          tau   = ray2D( iS - 1 )%tau    + W * ( ray2D( iS )%tau    - ray2D( iS - 1 )%tau )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">734</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">735</div>
            <div class="execution-count">-</div>
            <div class="source-code">          ! BUG: following is incorrect because ray doesn&#x27;t always use a step of deltas</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">736</div>
            <div class="execution-count">-</div>
            <div class="source-code">          ! LP: The do while ignores extremely small steps, but those small steps</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">737</div>
            <div class="execution-count">-</div>
            <div class="source-code">          ! still increment iS, so the later ray segments still treat it as if</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">738</div>
            <div class="execution-count">-</div>
            <div class="source-code">          ! all steps leading up to them were of size deltas.</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">739</div>
            <div class="execution-count">#####</div>
            <div class="source-code">          SINT  = ( iS - 1 ) * Beam%deltas + W * Beam%deltas</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">740</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">741</div>
            <div class="execution-count">#####</div>
            <div class="source-code">          CALL IncPhaseIfCaustic( .FALSE. )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">742</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">743</div>
            <div class="execution-count">-</div>
            <div class="source-code">          ! WRITE( PRTFile, * ) &#x27;is ir&#x27;, is-2, ir-1</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">744</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">745</div>
            <div class="execution-count">#####</div>
            <div class="source-code">          RcvrDepths: DO iz = 1, NRz_per_range</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">746</div>
            <div class="execution-count">#####</div>
            <div class="source-code">             deltaz =  Pos%Rz( iz ) - x( 2 )   ! ray to rcvr distance</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">747</div>
            <div class="execution-count">-</div>
            <div class="source-code">             ! LP: Reinstated this condition for eigenrays and arrivals, as</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">748</div>
            <div class="execution-count">-</div>
            <div class="source-code">             ! without it every ray would be an eigenray / arrival.</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">749</div>
            <div class="execution-count">#####</div>
            <div class="source-code">             Adeltaz    = ABS( deltaz )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">750</div>
            <div class="execution-count">-</div>
            <div class="source-code">             IF ( Adeltaz &lt; RadiusMax .OR. Beam%RunType( 1 : 1 ) == &#x27;C&#x27; &amp;</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">751</div>
            <div class="execution-count">#####</div>
            <div class="source-code">                   .OR. Beam%RunType( 1 : 1 ) == &#x27;I&#x27; .OR. Beam%RunType( 1 : 1 ) == &#x27;S&#x27; ) THEN</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">752</div>
            <div class="execution-count">-</div>
            <div class="source-code">                ! LP: Changed to use ApplyContribution in order to support</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">753</div>
            <div class="execution-count">-</div>
            <div class="source-code">                ! incoherent, semi-coherent, and arrivals.</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">754</div>
            <div class="execution-count">#####</div>
            <div class="source-code">                SrcDeclAngle = RadDeg * alpha   ! take-off angle in degrees</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">755</div>
            <div class="execution-count">-</div>
            <div class="source-code">                CPA    = ABS( deltaz * ( rB - rA ) ) / SQRT( ( rB - rA )**2 + &amp;</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">756</div>
            <div class="execution-count">#####</div>
            <div class="source-code">                            &amp; ( ray2D( iS )%x( 2 ) - ray2D( iS - 1 )%x( 2 ) )**2  )</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">757</div>
            <div class="execution-count">#####</div>
            <div class="source-code">                DS     = SQRT( deltaz **2 - CPA **2 )</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">758</div>
            <div class="execution-count">#####</div>
            <div class="source-code">                SX1    = SINT + DS</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">759</div>
            <div class="execution-count">#####</div>
            <div class="source-code">                thet   = ATAN( CPA / SX1 )</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">760</div>
            <div class="execution-count">#####</div>
            <div class="source-code">                delay  = tau + rayt( 2 ) * deltaz</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">761</div>
            <div class="execution-count">#####</div>
            <div class="source-code">                const  = Ratio1 * CN * ray2D( iS )%Amp / SQRT( SX1 )</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">762</div>
            <div class="execution-count">#####</div>
            <div class="source-code">                W      = EXP( -A * thet ** 2 )</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">763</div>
            <div class="execution-count">#####</div>
            <div class="source-code">                Amp    = const * W</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">764</div>
            <div class="execution-count">#####</div>
            <div class="source-code">                phaseInt = ray2D( iS )%Phase + phase</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">765</div>
            <div class="execution-count">#####</div>
            <div class="source-code">                CALL ApplyContribution( U( iz, ir ) )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">766</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">767</div>
            <div class="execution-count">-</div>
            <div class="source-code">             END IF</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">768</div>
            <div class="execution-count">-</div>
            <div class="source-code">          END DO RcvrDepths</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">769</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">770</div>
            <div class="execution-count">#####</div>
            <div class="source-code">          qOld = q</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">771</div>
            <div class="execution-count">#####</div>
            <div class="source-code">          ir   = ir + 1</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">772</div>
            <div class="execution-count">#####</div>
            <div class="source-code">          IF ( ir &gt; Pos%NRr ) RETURN</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">773</div>
            <div class="execution-count">-</div>
            <div class="source-code">       END DO RcvrRanges</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">774</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">775</div>
            <div class="execution-count">#####</div>
            <div class="source-code">       rA = rB</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">776</div>
            <div class="execution-count">-</div>
            <div class="source-code">    END DO Stepping</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">777</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">778</div>
            <div class="execution-count">-</div>
            <div class="source-code">  END SUBROUTINE InfluenceSGB</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">779</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">780</div>
            <div class="execution-count">-</div>
            <div class="source-code">  ! **********************************************************************!</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">781</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">782</div>
            <div class="execution-count">#####</div>
            <div class="source-code">  SUBROUTINE BranchCut( q1C, q2C, BeamType, KMAH )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">783</div>
            <div class="execution-count">-</div>
            <div class="source-code">  !! Checks for a branch cut crossing and updates KMAH accordingly</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">784</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">785</div>
            <div class="execution-count">-</div>
            <div class="source-code">    COMPLEX  (KIND=8), INTENT( IN )    :: q1C, q2C</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">786</div>
            <div class="execution-count">-</div>
            <div class="source-code">    CHARACTER (LEN=4), INTENT( IN )    :: BeamType</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">787</div>
            <div class="execution-count">-</div>
            <div class="source-code">    INTEGER,           INTENT( INOUT ) :: KMAH</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">788</div>
            <div class="execution-count">-</div>
            <div class="source-code">    REAL     (KIND=8)                  :: q1, q2</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">789</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">790</div>
            <div class="execution-count">#####</div>
            <div class="source-code">    SELECT CASE ( BeamType( 2 : 2 ) )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">791</div>
            <div class="execution-count">-</div>
            <div class="source-code">    CASE ( &#x27;W&#x27; )   ! WKBeams</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">792</div>
            <div class="execution-count">#####</div>
            <div class="source-code">       q1 = REAL( q1C )</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">793</div>
            <div class="execution-count">#####</div>
            <div class="source-code">       q2 = REAL( q2C )</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">794</div>
            <div class="execution-count">#####</div>
            <div class="source-code">       IF ( ( q1 &lt; 0.0 .AND. q2 &gt;= 0.0 ) .OR. &amp;</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">795</div>
            <div class="execution-count">#####</div>
            <div class="source-code">            ( q1 &gt; 0.0 .AND. q2 &lt;= 0.0 ) ) KMAH = -KMAH</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">796</div>
            <div class="execution-count">-</div>
            <div class="source-code">    CASE DEFAULT</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">797</div>
            <div class="execution-count">#####</div>
            <div class="source-code">       IF ( REAL( q2C ) &lt; 0.0 ) THEN</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">798</div>
            <div class="execution-count">#####</div>
            <div class="source-code">          q1 = AIMAG( q1C )</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">799</div>
            <div class="execution-count">#####</div>
            <div class="source-code">          q2 = AIMAG( q2C )</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">800</div>
            <div class="execution-count">#####</div>
            <div class="source-code">          IF ( ( q1 &lt; 0.0 .AND. q2 &gt;= 0.0 ) .OR. &amp;</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">801</div>
            <div class="execution-count">#####</div>
            <div class="source-code">               ( q1 &gt; 0.0 .AND. q2 &lt;= 0.0 ) ) KMAH = -KMAH</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">802</div>
            <div class="execution-count">-</div>
            <div class="source-code">       END IF</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">803</div>
            <div class="execution-count">-</div>
            <div class="source-code">    END SELECT</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">804</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">805</div>
            <div class="execution-count">#####</div>
            <div class="source-code">  END SUBROUTINE BranchCut</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">806</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">807</div>
            <div class="execution-count">-</div>
            <div class="source-code">  ! **********************************************************************!</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">808</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">809</div>
            <div class="execution-count">8*</div>
            <div class="source-code">  SUBROUTINE ScalePressure( Dalpha, c, r, U, NRz, Nr, RunType, freq )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">810</div>
            <div class="execution-count">-</div>
            <div class="source-code">  !! Scale the pressure field</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">811</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">812</div>
            <div class="execution-count">-</div>
            <div class="source-code">    REAL,              PARAMETER       :: pi = 3.14159265</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">813</div>
            <div class="execution-count">-</div>
            <div class="source-code">    INTEGER,           INTENT( IN    ) :: NRz, Nr</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">814</div>
            <div class="execution-count">-</div>
            <div class="source-code">    REAL,              INTENT( IN    ) :: r( Nr )         ! ranges</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">815</div>
            <div class="execution-count">-</div>
            <div class="source-code">    REAL     (KIND=8), INTENT( IN    ) :: Dalpha, freq, c ! angular spacing between rays, source frequency, nominal sound speed</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">816</div>
            <div class="execution-count">-</div>
            <div class="source-code">    COMPLEX,           INTENT( INOUT ) :: U( NRz, Nr )    ! Pressure field</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">817</div>
            <div class="execution-count">-</div>
            <div class="source-code">    CHARACTER (LEN=5), INTENT( IN    ) :: RunType</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">818</div>
            <div class="execution-count">-</div>
            <div class="source-code">    REAL     (KIND=8)                  :: const, factor</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">819</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">820</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! Compute scale factor for field</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">821</div>
            <div class="execution-count">#####</div>
            <div class="source-code">    SELECT CASE ( RunType( 2 : 2 ) )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">822</div>
            <div class="execution-count">-</div>
            <div class="source-code">    CASE ( &#x27;C&#x27; )   ! Cerveny Gaussian beams in Cartesian coordinates</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">823</div>
            <div class="execution-count">#####</div>
            <div class="source-code">       const = -Dalpha * SQRT( freq ) / c</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">824</div>
            <div class="execution-count">-</div>
            <div class="source-code">    CASE ( &#x27;R&#x27; )   ! Cerveny Gaussian beams in Ray-centered coordinates</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">825</div>
            <div class="execution-count">#####</div>
            <div class="source-code">       const = -Dalpha * SQRT( freq ) / c</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">826</div>
            <div class="execution-count">-</div>
            <div class="source-code">    CASE DEFAULT</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">827</div>
            <div class="execution-count">8</div>
            <div class="source-code">       const = -1.0</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">828</div>
            <div class="execution-count">-</div>
            <div class="source-code">    END SELECT</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">829</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">830</div>
            <div class="execution-count">8*</div>
            <div class="source-code">    IF ( RunType( 1 : 1 ) /= &#x27;C&#x27; ) U = SQRT( REAL( U ) ) ! For incoherent run, convert intensity to pressure</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">831</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">832</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! scale and/or incorporate cylindrical spreading</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">833</div>
            <div class="execution-count">6011*</div>
            <div class="source-code">    Ranges: DO ir = 1, Nr</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">834</div>
            <div class="execution-count">6003</div>
            <div class="source-code">       IF ( RunType( 4 : 4 ) == &#x27;X&#x27; ) THEN   ! line source</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">835</div>
            <div class="execution-count">501</div>
            <div class="source-code">          factor = -4.0 * SQRT( pi ) * const</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">836</div>
            <div class="execution-count">-</div>
            <div class="source-code">       ELSE                                  ! point source</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">837</div>
            <div class="execution-count">5502*</div>
            <div class="source-code">          IF ( r ( ir ) == 0 ) THEN</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">838</div>
            <div class="execution-count">5</div>
            <div class="source-code">             factor = 0.0D0                  ! avoid /0 at origin, return pressure = 0</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">839</div>
            <div class="execution-count">-</div>
            <div class="source-code">          ELSE</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">840</div>
            <div class="execution-count">5497*</div>
            <div class="source-code">             factor = const / SQRT( ABS( r( ir ) ) )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">841</div>
            <div class="execution-count">-</div>
            <div class="source-code">          END IF</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">842</div>
            <div class="execution-count">-</div>
            <div class="source-code">       END IF</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">843</div>
            <div class="execution-count">1059114*</div>
            <div class="source-code">       U( :, ir ) = SNGL( factor ) * U( :, ir )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">844</div>
            <div class="execution-count">-</div>
            <div class="source-code">    END DO Ranges</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">845</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line executed">
            <div class="line-number">846</div>
            <div class="execution-count">8</div>
            <div class="source-code">  END SUBROUTINE ScalePressure</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">847</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">848</div>
            <div class="execution-count">-</div>
            <div class="source-code">  ! **********************************************************************!</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">849</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">850</div>
            <div class="execution-count">#####</div>
            <div class="source-code">  REAL (KIND=8 ) FUNCTION Hermite( x, x1, x2 )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">851</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">852</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! Calculates a smoothing function based on the h0 hermite cubic</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">853</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! x is the point where the function is to be evaluated</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">854</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! returns:</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">855</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! [  0, x1  ] = 1</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">856</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! [ x1, x2  ] = cubic taper from 1 to 0</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">857</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! [ x2, inf ] = 0</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">858</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">859</div>
            <div class="execution-count">-</div>
            <div class="source-code">    REAL (KIND=8 ), INTENT( IN  ) :: x, x1, x2</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">860</div>
            <div class="execution-count">-</div>
            <div class="source-code">    REAL (KIND=8 )                :: Ax, u</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">861</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">862</div>
            <div class="execution-count">#####</div>
            <div class="source-code">    Ax  = ABS( x  )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">863</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">864</div>
            <div class="execution-count">#####</div>
            <div class="source-code">    IF ( Ax &lt;= x1 ) THEN</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">865</div>
            <div class="execution-count">#####</div>
            <div class="source-code">       Hermite = 1.0d0</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">866</div>
            <div class="execution-count">#####</div>
            <div class="source-code">    ELSE IF ( Ax &gt;= x2 ) THEN</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">867</div>
            <div class="execution-count">#####</div>
            <div class="source-code">       Hermite = 0.0d0</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">868</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ELSE</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">869</div>
            <div class="execution-count">#####</div>
            <div class="source-code">       u       = ( Ax - x1 ) / ( x2 - x1 )</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">870</div>
            <div class="execution-count">#####</div>
            <div class="source-code">       Hermite = ( 1.0d0 + 2.0d0 * u ) * ( 1.0d0 - u ) ** 2</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">871</div>
            <div class="execution-count">-</div>
            <div class="source-code">    END IF</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">872</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">873</div>
            <div class="execution-count">-</div>
            <div class="source-code">    !hermit = hermit / ( 0.5 * ( x1 + x2 ) )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">874</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">875</div>
            <div class="execution-count">#####</div>
            <div class="source-code">  END FUNCTION Hermite</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">876</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">877</div>
            <div class="execution-count">-</div>
            <div class="source-code">  ! **********************************************************************!</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">878</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line executed">
            <div class="line-number">879</div>
            <div class="execution-count">80675125</div>
            <div class="source-code">  SUBROUTINE FinalPhase( isGaussian )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">880</div>
            <div class="execution-count">-</div>
            <div class="source-code">    LOGICAL, INTENT( IN ) :: isGaussian</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">881</div>
            <div class="execution-count">-</div>
            <div class="source-code">    INTEGER :: phaseStepNum</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">882</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">883</div>
            <div class="execution-count">-</div>
            <div class="source-code">    !! phase shifts at caustics</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">884</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">885</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! this should be precomputed [LP: While IncPhaseIfCaustic can be</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">886</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! precomputed, FinalPhase cannot, as it is dependent on the interpolated `q`</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">887</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! value which is not known until the main run.]</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">888</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! LP: All 2D functions discard the ray point phase if the condition is met,</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">889</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! probably BUG</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">890</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! LP: 2D Gaussian Cartesian reads the phase from the current point, all</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">891</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! others (including 3D) read the phase from the previous point, probably BUG</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">892</div>
            <div class="execution-count">80675125</div>
            <div class="source-code">    IF ( isGaussian ) THEN</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">893</div>
            <div class="execution-count">75828128</div>
            <div class="source-code">       phaseStepNum = iS</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">894</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ELSE</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">895</div>
            <div class="execution-count">4846997</div>
            <div class="source-code">       phaseStepNum = iS - 1</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">896</div>
            <div class="execution-count">-</div>
            <div class="source-code">    END IF</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">897</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">898</div>
            <div class="execution-count">80675125*</div>
            <div class="source-code">    phaseInt = ray2D( phaseStepNum )%Phase + phase</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">899</div>
            <div class="execution-count">80675125</div>
            <div class="source-code">    IF ( IsAtCaustic( .TRUE. ) ) &amp;</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">900</div>
            <div class="execution-count">89091</div>
            <div class="source-code">       phaseInt = phase + pi / 2.</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">901</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line executed">
            <div class="line-number">902</div>
            <div class="execution-count">80675125</div>
            <div class="source-code">  END SUBROUTINE FinalPhase</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">903</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">904</div>
            <div class="execution-count">-</div>
            <div class="source-code">  ! **********************************************************************!</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">905</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line executed">
            <div class="line-number">906</div>
            <div class="execution-count">29229805</div>
            <div class="source-code">  SUBROUTINE IncPhaseIfCaustic( qleq0 )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">907</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">908</div>
            <div class="execution-count">-</div>
            <div class="source-code">    !! phase shifts at caustics</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">909</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">910</div>
            <div class="execution-count">-</div>
            <div class="source-code">    LOGICAL, INTENT( IN ) :: qleq0</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">911</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line executed">
            <div class="line-number">912</div>
            <div class="execution-count">29229805</div>
            <div class="source-code">    IF ( IsAtCaustic( qleq0 ) ) &amp;</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">913</div>
            <div class="execution-count">3141</div>
            <div class="source-code">       phase = phase + pi / 2.</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">914</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line executed">
            <div class="line-number">915</div>
            <div class="execution-count">29229805</div>
            <div class="source-code">  END SUBROUTINE IncPhaseIfCaustic</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">916</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">917</div>
            <div class="execution-count">-</div>
            <div class="source-code">  ! **********************************************************************!</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">918</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line executed">
            <div class="line-number">919</div>
            <div class="execution-count">109904930</div>
            <div class="source-code">  LOGICAL FUNCTION IsAtCaustic( qleq0 )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">920</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">921</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! LP: There are two versions of the phase shift condition used in the</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">922</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! BELLHOP code, with the equalities in opposite positions. qleq0 false is</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">923</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! only used in SGB.</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">924</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">925</div>
            <div class="execution-count">-</div>
            <div class="source-code">    LOGICAL, INTENT( IN ) :: qleq0</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">926</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line executed">
            <div class="line-number">927</div>
            <div class="execution-count">109904930</div>
            <div class="source-code">    IF ( qleq0 ) THEN</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">928</div>
            <div class="execution-count">109904930</div>
            <div class="source-code">       IsAtCaustic = q &lt;= 0.0d0 .AND. qOld &gt;  0.0d0 .OR. q &gt;= 0.0d0 .AND. qOld &lt;  0.0d0</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">929</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ELSE</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">930</div>
            <div class="execution-count">#####</div>
            <div class="source-code">       IsAtCaustic = q &lt;  0.0d0 .AND. qOld &gt;= 0.0d0 .OR. q &gt;  0.0d0 .AND. qOld &lt;= 0.0d0</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">931</div>
            <div class="execution-count">-</div>
            <div class="source-code">    END IF</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">932</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line executed">
            <div class="line-number">933</div>
            <div class="execution-count">109904930</div>
            <div class="source-code">  END FUNCTION IsAtCaustic</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">934</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">935</div>
            <div class="execution-count">-</div>
            <div class="source-code">END MODULE Influence</div>
        </div>
    </div>

    <div class="footer">
        <p><strong>Legend:</strong></p>
        <ul>
            <li><span style="background-color: #d4edda; padding: 2px 4px;">Green</span> - Executed lines</li>
            <li><span style="background-color: #f8d7da; padding: 2px 4px;">Red</span> - Not executed lines</li>
            <li><span style="background-color: #f8f9fa; padding: 2px 4px;">Gray</span> - Non-executable lines (comments, declarations)</li>
        </ul>
        <p><strong>Execution Count:</strong> Number of times each line was executed. ##### indicates never executed, - indicates non-executable.</p>
    </div>
</body>
</html>