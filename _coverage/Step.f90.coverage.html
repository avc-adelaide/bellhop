<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coverage Report: Step.f90</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            margin: 20px;
            background-color: #f9f9f9;
        }
        .header {
            background-color: #2c3e50;
            color: white;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .summary {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        .metric {
            background-color: #ecf0f1;
            padding: 10px;
            border-radius: 3px;
            text-align: center;
            min-width: 120px;
        }
        .metric-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #27ae60;
        }
        .code-container {
            background-color: white;
            border: 1px solid #bdc3c7;
            border-radius: 5px;
            overflow: auto;
        }
        .code-line {
            display: flex;
            border-bottom: 1px solid #ecf0f1;
        }
        .line-number {
            background-color: #f8f9fa;
            padding: 2px 8px;
            width: 60px;
            text-align: right;
            border-right: 1px solid #dee2e6;
            color: #6c757d;
        }
        .execution-count {
            background-color: #f8f9fa;
            padding: 2px 8px;
            width: 80px;
            text-align: right;
            border-right: 1px solid #dee2e6;
            color: #495057;
        }
        .source-code {
            padding: 2px 8px;
            flex: 1;
            white-space: pre;
        }
        .executed { background-color: #d4edda; }
        .not-executed { background-color: #f8d7da; }
        .non-executable { background-color: #f8f9fa; }
        .footer {
            margin-top: 20px;
            padding: 15px;
            background-color: #e9ecef;
            border-radius: 5px;
            font-size: 0.9em;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Coverage Report: Step.f90</h1>
        <p>Generated from GCOV analysis of Fortran source code</p>
    </div>

    <div class="summary">
        <div class="metric">
            <div class="metric-value">98.7%</div>
            <div>Lines Executed</div>
            <div>159 total lines</div>
        </div>
        <div class="metric">
            <div class="metric-value">84.8%</div>
            <div>Branches Executed</div>
            <div>210 total branches</div>
        </div>
        <div class="metric">
            <div class="metric-value">100.0%</div>
            <div>Calls Executed</div>
            <div>6 total calls</div>
        </div>
    </div>

    <div class="code-container">
        <div class="code-line non-executable">
            <div class="line-number">0</div>
            <div class="execution-count">-</div>
            <div class="source-code">Source:Step.f90</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">0</div>
            <div class="execution-count">-</div>
            <div class="source-code">Graph:Step.gcno</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">0</div>
            <div class="execution-count">-</div>
            <div class="source-code">Data:Step.gcda</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">0</div>
            <div class="execution-count">-</div>
            <div class="source-code">Runs:57</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">1</div>
            <div class="execution-count">-</div>
            <div class="source-code">!! Ray stepping module with adaptive step size control</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">2</div>
            <div class="execution-count">-</div>
            <div class="source-code">MODULE Step</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">3</div>
            <div class="execution-count">-</div>
            <div class="source-code">  !! Ray propagation with adaptive step size control and boundary interaction handling</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">4</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">5</div>
            <div class="execution-count">-</div>
            <div class="source-code">  USE bellhopMod</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">6</div>
            <div class="execution-count">-</div>
            <div class="source-code">  USE sspMod</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">7</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">8</div>
            <div class="execution-count">-</div>
            <div class="source-code">  IMPLICIT NONE</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">9</div>
            <div class="execution-count">-</div>
            <div class="source-code">  PUBLIC</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">10</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">11</div>
            <div class="execution-count">-</div>
            <div class="source-code">  REAL (KIND=8), PARAMETER, PRIVATE :: INFINITESIMAL_STEP_SIZE = 1.0d-6</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">12</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">13</div>
            <div class="execution-count">-</div>
            <div class="source-code">CONTAINS</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">14</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line executed">
            <div class="line-number">15</div>
            <div class="execution-count">29262613</div>
            <div class="source-code">  SUBROUTINE Step2D( ray0, ray2, topRefl, botRefl, Topx, Topn, Botx, Botn )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">16</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">17</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! Does a single step along the ray</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">18</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! x denotes the ray coordinate, (r,z)</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">19</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! t denotes the scaled tangent to the ray (previously (rho, zeta))</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">20</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! c * t would be the unit tangent</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">21</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">22</div>
            <div class="execution-count">-</div>
            <div class="source-code">    USE BdryMod</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">23</div>
            <div class="execution-count">-</div>
            <div class="source-code">    TYPE( ray2DPt ), INTENT( INOUT ) :: ray0, ray2</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">24</div>
            <div class="execution-count">-</div>
            <div class="source-code">    TYPE( ray2DPt ) :: ray1</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">25</div>
            <div class="execution-count">-</div>
            <div class="source-code">    REAL (KIND=8 ), INTENT( IN ) :: Topx( 2 ), Topn( 2 ), Botx( 2 ), Botn( 2 )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">26</div>
            <div class="execution-count">-</div>
            <div class="source-code">    LOGICAL, INTENT( OUT ) :: topRefl, botRefl</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">27</div>
            <div class="execution-count">-</div>
            <div class="source-code">    INTEGER            :: iSegz0, iSegr0</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">28</div>
            <div class="execution-count">-</div>
            <div class="source-code">    REAL     (KIND=8 ) :: gradc0( 2 ), gradc1( 2 ), gradc2( 2 ), &amp;</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">29</div>
            <div class="execution-count">-</div>
            <div class="source-code">         c0, cimag0, crr0, crz0, czz0, csq0, cnn0_csq0, &amp;</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">30</div>
            <div class="execution-count">-</div>
            <div class="source-code">         c1, cimag1, crr1, crz1, czz1, csq1, cnn1_csq1, &amp;</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">31</div>
            <div class="execution-count">-</div>
            <div class="source-code">         c2, cimag2, crr2, crz2, czz2, urayt0( 2 ), urayt1( 2 ), &amp;</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">32</div>
            <div class="execution-count">-</div>
            <div class="source-code">         h, halfh, ray2n( 2 ), RM, RN, gradcjump( 2 ), cnjump, csjump, w0, w1, rho</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">33</div>
            <div class="execution-count">-</div>
            <div class="source-code">    REAL (KIND=8 ) :: urayt2( 2 ), unitdt( 2 ), unitdp( 2 ), unitdq( 2 )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">34</div>
            <div class="execution-count">-</div>
            <div class="source-code">    COMPLEX (KIND=8 ) :: unitdtau</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">35</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">36</div>
            <div class="execution-count">-</div>
            <div class="source-code">    IF ( STEP_DEBUGGING ) THEN</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">37</div>
            <div class="execution-count">-</div>
            <div class="source-code">       WRITE( PRTFile, * )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">38</div>
            <div class="execution-count">-</div>
            <div class="source-code">       WRITE( PRTFile, * ) &#x27;ray0 x t p q tau amp&#x27;, ray0%x, ray0%t, ray0%p, ray0%q, ray0%tau, ray0%Amp</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">39</div>
            <div class="execution-count">-</div>
            <div class="source-code">       WRITE( PRTFile, * ) &#x27;iSegr iSegz&#x27;, iSegr, iSegz</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">40</div>
            <div class="execution-count">-</div>
            <div class="source-code">    END IF</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">41</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">42</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! IF ( ray0%x( 1 ) &gt; 10.0 ) THEN</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">43</div>
            <div class="execution-count">-</div>
            <div class="source-code">    !    STOP &#x27;Enough&#x27;</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">44</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! END IF</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">45</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">46</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! The numerical integrator used here is a version of the polygon (a.k.a. midpoint, leapfrog, or Box method), and similar</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">47</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! to the Heun (second order Runge-Kutta method).</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">48</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! However, it&#x27;s modified to allow for a dynamic step change, while preserving the second-order accuracy).</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">49</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">50</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! *** Phase 1 (an Euler step)</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">51</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line executed">
            <div class="line-number">52</div>
            <div class="execution-count">29262613</div>
            <div class="source-code">    CALL EvaluateSSP( ray0%x, ray0%t, c0, cimag0, gradc0, crr0, crz0, czz0, rho, freq, &#x27;TAB&#x27; )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">53</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line executed">
            <div class="line-number">54</div>
            <div class="execution-count">29262613</div>
            <div class="source-code">    csq0      = c0 * c0</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">55</div>
            <div class="execution-count">29262613</div>
            <div class="source-code">    cnn0_csq0 = crr0 * ray0%t( 2 )**2 - 2.0 * crz0 * ray0%t( 1 ) * ray0%t( 2 ) + czz0 * ray0%t( 1 )**2</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">56</div>
            <div class="execution-count">29262613</div>
            <div class="source-code">    iSegz0    = iSegz     ! make note of current layer</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">57</div>
            <div class="execution-count">29262613</div>
            <div class="source-code">    iSegr0    = iSegr</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">58</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line executed">
            <div class="line-number">59</div>
            <div class="execution-count">29262613</div>
            <div class="source-code">    h = Beam%deltas       ! initially set the step h, to the basic one, deltas</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">60</div>
            <div class="execution-count">87787839</div>
            <div class="source-code">    urayt0 = c0 * ray0%t  ! unit tangent</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">61</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line executed">
            <div class="line-number">62</div>
            <div class="execution-count">29262613</div>
            <div class="source-code">    CALL ReduceStep2D( ray0%x, urayt0, iSegz0, iSegr0, Topx, Topn, Botx, Botn, h ) ! reduce h to land on boundary</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">63</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! WRITE( PRTFile, * ) &#x27;out h, urayt0&#x27;, h, urayt0</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">64</div>
            <div class="execution-count">29262613</div>
            <div class="source-code">    halfh = 0.5 * h   ! first step of the modified polygon method is a half step</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">65</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line executed">
            <div class="line-number">66</div>
            <div class="execution-count">87787839</div>
            <div class="source-code">    ray1%x = ray0%x + halfh * urayt0</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">67</div>
            <div class="execution-count">87787839</div>
            <div class="source-code">    ray1%t = ray0%t - halfh * gradc0 / csq0</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">68</div>
            <div class="execution-count">87787839</div>
            <div class="source-code">    ray1%p = ray0%p - halfh * cnn0_csq0 * ray0%q</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">69</div>
            <div class="execution-count">87787839</div>
            <div class="source-code">    ray1%q = ray0%q + halfh * c0        * ray0%p</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">70</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">71</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! WRITE( PRTFile, * ) &#x27;ray1 x t p q&#x27;, ray1%x, ray1%t, ray1%p, ray1%q</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">72</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">73</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! *** Phase 2</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">74</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line executed">
            <div class="line-number">75</div>
            <div class="execution-count">29262613</div>
            <div class="source-code">    CALL EvaluateSSP( ray1%x, ray1%t, c1, cimag1, gradc1, crr1, crz1, czz1, rho, freq, &#x27;TAB&#x27; )</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">76</div>
            <div class="execution-count">29262613</div>
            <div class="source-code">    csq1      = c1 * c1</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">77</div>
            <div class="execution-count">29262613</div>
            <div class="source-code">    cnn1_csq1 = crr1 * ray1%t( 2 )**2 - 2.0 * crz1 * ray1%t( 1 ) * ray1%t( 2 ) + czz1 * ray1%t( 1 )**2</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">78</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">79</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! The Munk test case with a horizontally launched ray caused problems.</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">80</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! The ray vertexes on an interface and can ping-pong around that interface.</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">81</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! Have to be careful in that case about big changes to the stepsize (that invalidate the leap-frog scheme) in phase II.</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">82</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! A modified Heun or Box method could also work.</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">83</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line executed">
            <div class="line-number">84</div>
            <div class="execution-count">87787839</div>
            <div class="source-code">    urayt1 = c1 * ray1%t   ! unit tangent</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">85</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line executed">
            <div class="line-number">86</div>
            <div class="execution-count">29262613</div>
            <div class="source-code">    CALL ReduceStep2D( ray0%x, urayt1, iSegz0, iSegr0, Topx, Topn, Botx, Botn, h ) ! reduce h to land on boundary</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">87</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">88</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! WRITE( PRTFile, * ) &#x27;urayt1&#x27;, urayt1, &#x27;out h 2&#x27;, h</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">89</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">90</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! use blend of f&#x27; based on proportion of a full step used.</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">91</div>
            <div class="execution-count">29262613</div>
            <div class="source-code">    w1  = h / ( 2.0d0 * halfh )</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">92</div>
            <div class="execution-count">29262613</div>
            <div class="source-code">    w0  = 1.0d0 - w1</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">93</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! WRITE( PRTFile, * ) &#x27;w1 w0&#x27;, w1, w0</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">94</div>
            <div class="execution-count">87787839</div>
            <div class="source-code">    urayt2   =  w0 * urayt0                      + w1 * urayt1</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">95</div>
            <div class="execution-count">87787839</div>
            <div class="source-code">    unitdt   = -w0 * gradc0 / csq0               - w1 * gradc1 / csq1</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">96</div>
            <div class="execution-count">87787839</div>
            <div class="source-code">    unitdp   = -w0 * cnn0_csq0 * ray0%q          - w1 * cnn1_csq1 * ray1%q</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">97</div>
            <div class="execution-count">87787839</div>
            <div class="source-code">    unitdq   =  w0 * c0        * ray0%p          + w1 * c1        * ray1%p</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">98</div>
            <div class="execution-count">29262613</div>
            <div class="source-code">    unitdtau =  w0 / CMPLX( c0, cimag0, KIND=8 ) + w1 / CMPLX( c1, cimag1, KIND=8 )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">99</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">100</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! Take the blended ray tangent (urayt2) and find the minimum step size (h)</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">101</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! to put this on a boundary, and ensure that the resulting position</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">102</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! (ray2.x) gets put precisely on the boundary.</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">103</div>
            <div class="execution-count">-</div>
            <div class="source-code">    CALL StepToBdry2D(ray0%x, ray2%x, urayt2, h, topRefl, botRefl, &amp;</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">104</div>
            <div class="execution-count">29262613</div>
            <div class="source-code">       iSegz0, iSegr0, Topx, Topn, Botx, Botn)</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">105</div>
            <div class="execution-count">87787839</div>
            <div class="source-code">    ray2%t   = ray0%t   + h * unitdt</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">106</div>
            <div class="execution-count">87787839</div>
            <div class="source-code">    ray2%p   = ray0%p   + h * unitdp</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">107</div>
            <div class="execution-count">87787839</div>
            <div class="source-code">    ray2%q   = ray0%q   + h * unitdq</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">108</div>
            <div class="execution-count">29262613</div>
            <div class="source-code">    ray2%tau = ray0%tau + h * unitdtau</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">109</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">110</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! WRITE( PRTFile, * ) &#x27;ray2 x t p q tau&#x27;, ray2%x, ray2%t, ray2%p, ray2%q, ray2%tau</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">111</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line executed">
            <div class="line-number">112</div>
            <div class="execution-count">29262613</div>
            <div class="source-code">    ray2%Amp       = ray0%Amp</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">113</div>
            <div class="execution-count">29262613</div>
            <div class="source-code">    ray2%Phase     = ray0%Phase</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">114</div>
            <div class="execution-count">29262613</div>
            <div class="source-code">    ray2%NumTopBnc = ray0%NumTopBnc</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">115</div>
            <div class="execution-count">29262613</div>
            <div class="source-code">    ray2%NumBotBnc = ray0%NumBotBnc</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">116</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">117</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! If we crossed an interface, apply jump condition</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">118</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line executed">
            <div class="line-number">119</div>
            <div class="execution-count">29262613</div>
            <div class="source-code">    CALL EvaluateSSP( ray2%x, ray2%t, c2, cimag2, gradc2, crr2, crz2, czz2, rho, freq, &#x27;TAB&#x27; )</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">120</div>
            <div class="execution-count">29262613</div>
            <div class="source-code">    ray2%c = c2</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">121</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line executed">
            <div class="line-number">122</div>
            <div class="execution-count">29262613</div>
            <div class="source-code">    IF ( iSegz /= iSegz0 .OR. iSegr /= iSegr0 ) THEN</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">123</div>
            <div class="execution-count">2650527</div>
            <div class="source-code">       gradcjump =  gradc2 - gradc0</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">124</div>
            <div class="execution-count">2650527</div>
            <div class="source-code">       ray2n     = [ -ray2%t( 2 ), ray2%t( 1 ) ]   ! ray normal</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">125</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line executed">
            <div class="line-number">126</div>
            <div class="execution-count">2650527</div>
            <div class="source-code">       cnjump    = DOT_PRODUCT( gradcjump, ray2n  )</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">127</div>
            <div class="execution-count">2650527</div>
            <div class="source-code">       csjump    = DOT_PRODUCT( gradcjump, ray2%t )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">128</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line executed">
            <div class="line-number">129</div>
            <div class="execution-count">883509</div>
            <div class="source-code">       IF ( iSegz /= iSegz0 ) THEN         ! crossing in depth</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">130</div>
            <div class="execution-count">868780</div>
            <div class="source-code">          RM = +ray2%t( 1 ) / ray2%t( 2 )  ! this is tan( alpha ) where alpha is the angle of incidence</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">131</div>
            <div class="execution-count">-</div>
            <div class="source-code">       ELSE                                ! crossing in range</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">132</div>
            <div class="execution-count">14729</div>
            <div class="source-code">          RM = -ray2%t( 2 ) / ray2%t( 1 )  ! this is tan( alpha ) where alpha is the angle of incidence</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">133</div>
            <div class="execution-count">-</div>
            <div class="source-code">       END IF</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">134</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line executed">
            <div class="line-number">135</div>
            <div class="execution-count">883509</div>
            <div class="source-code">       RN     = RM * ( 2 * cnjump - RM * csjump ) / c2</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">136</div>
            <div class="execution-count">2650527</div>
            <div class="source-code">       ray2%p = ray2%p - ray2%q * RN</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">137</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">138</div>
            <div class="execution-count">-</div>
            <div class="source-code">    END IF</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">139</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line executed">
            <div class="line-number">140</div>
            <div class="execution-count">29262613</div>
            <div class="source-code">  END SUBROUTINE Step2D</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">141</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">142</div>
            <div class="execution-count">-</div>
            <div class="source-code">  ! **********************************************************************!</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">143</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line executed">
            <div class="line-number">144</div>
            <div class="execution-count">58525226</div>
            <div class="source-code">  SUBROUTINE ReduceStep2D( x0, urayt, iSegz0, iSegr0, Topx, Topn, Botx, Botn, h )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">145</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">146</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! calculate a reduced step size, h, that lands on any points where the environment changes</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">147</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">148</div>
            <div class="execution-count">-</div>
            <div class="source-code">    USE BdryMod</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">149</div>
            <div class="execution-count">-</div>
            <div class="source-code">    INTEGER,       INTENT( IN    ) :: iSegz0, iSegr0                             ! SSP layer the ray is in</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">150</div>
            <div class="execution-count">-</div>
            <div class="source-code">    REAL (KIND=8), INTENT( IN    ) :: x0( 2 ), urayt( 2 )                        ! ray coordinate and tangent</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">151</div>
            <div class="execution-count">-</div>
            <div class="source-code">    REAL (KIND=8), INTENT( IN    ) :: Topx( 2 ), Topn( 2 ), Botx( 2 ), Botn( 2 ) ! Top, bottom coordinate and normal</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">152</div>
            <div class="execution-count">-</div>
            <div class="source-code">    REAL (KIND=8), INTENT( INOUT ) :: h                                          ! reduced step size</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">153</div>
            <div class="execution-count">-</div>
            <div class="source-code">    REAL (KIND=8)                  :: hInt, hBoxr, hBoxz, hTop, hBot, hSeg       ! step sizes</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">154</div>
            <div class="execution-count">-</div>
            <div class="source-code">    REAL (KIND=8)                  :: x( 2 ), d( 2 ), d0( 2 ), rSeg( 2 )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">155</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">156</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! Detect interface or boundary crossing and reduce step, if necessary, to land on that crossing.</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">157</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! Keep in mind possibility that user put source right on an interface</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">158</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! and that multiple events can occur (crossing interface, top, and bottom in a single step).</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">159</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line executed">
            <div class="line-number">160</div>
            <div class="execution-count">175575678</div>
            <div class="source-code">    x = x0 + h * urayt ! make a trial step</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">161</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">162</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! interface crossing in depth</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">163</div>
            <div class="execution-count">58525226</div>
            <div class="source-code">    hInt = huge( hInt )</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">164</div>
            <div class="execution-count">58525226</div>
            <div class="source-code">    IF ( ABS( urayt( 2 ) ) &gt; EPSILON( hInt ) ) THEN</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">165</div>
            <div class="execution-count">58521994*</div>
            <div class="source-code">       IF        ( SSP%z( iSegz0     ) &gt; x(  2 ) ) THEN</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">166</div>
            <div class="execution-count">1265609*</div>
            <div class="source-code">          hInt = ( SSP%z( iSegz0     ) - x0( 2 ) ) / urayt( 2 )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">167</div>
            <div class="execution-count">57256385*</div>
            <div class="source-code">       ELSE IF   ( SSP%z( iSegz0 + 1 ) &lt; x(  2 ) ) THEN</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">168</div>
            <div class="execution-count">1256077*</div>
            <div class="source-code">          hInt = ( SSP%z( iSegz0 + 1 ) - x0( 2 ) ) / urayt( 2 )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">169</div>
            <div class="execution-count">-</div>
            <div class="source-code">       END IF</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">170</div>
            <div class="execution-count">-</div>
            <div class="source-code">    END IF</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">171</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">172</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! ray mask using a box centered at ( 0, 0 )</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">173</div>
            <div class="execution-count">58525226</div>
            <div class="source-code">    hBoxr    = huge( hBoxr )</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">174</div>
            <div class="execution-count">58525226</div>
            <div class="source-code">    IF ( ABS( x( 1 ) ) &gt; Beam%Box%r ) THEN</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">175</div>
            <div class="execution-count">785756</div>
            <div class="source-code">       hBoxr = ( Beam%Box%r - ABS( x0( 1 ) ) ) / ABS( urayt( 1 ) )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">176</div>
            <div class="execution-count">-</div>
            <div class="source-code">    END IF</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">177</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line executed">
            <div class="line-number">178</div>
            <div class="execution-count">58525226</div>
            <div class="source-code">    hBoxz    = huge( hBoxz )</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">179</div>
            <div class="execution-count">58525226</div>
            <div class="source-code">    IF ( ABS( x( 2 ) ) &gt; Beam%Box%z ) THEN</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">180</div>
            <div class="execution-count">473574</div>
            <div class="source-code">       hBoxz = ( Beam%Box%z - ABS( x0( 2 ) ) ) / ABS( urayt( 2 ) )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">181</div>
            <div class="execution-count">-</div>
            <div class="source-code">    END IF</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">182</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">183</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! top crossing</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">184</div>
            <div class="execution-count">58525226</div>
            <div class="source-code">    hTop = huge( hTop )</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">185</div>
            <div class="execution-count">175575678</div>
            <div class="source-code">    d  = x - Topx               ! vector from top to ray</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">186</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! LP: Changed from EPSILON( hTop ) to 0 in conjunction with StepToBdry2D change here.</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">187</div>
            <div class="execution-count">175575678</div>
            <div class="source-code">    IF ( DOT_PRODUCT( Topn, d ) &gt;= 0.0D0 ) THEN</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">188</div>
            <div class="execution-count">3722895</div>
            <div class="source-code">       d0   = x0 - Topx         ! vector from top    node to ray origin</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">189</div>
            <div class="execution-count">6204825</div>
            <div class="source-code">       hTop = -DOT_PRODUCT( d0, Topn ) / DOT_PRODUCT( urayt, Topn )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">190</div>
            <div class="execution-count">-</div>
            <div class="source-code">    END IF</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">191</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">192</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! bottom crossing</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">193</div>
            <div class="execution-count">58525226</div>
            <div class="source-code">    hBot = huge( hBot )</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">194</div>
            <div class="execution-count">175575678</div>
            <div class="source-code">    d  = x - Botx               ! vector from bottom to ray</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">195</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! LP: Changed from EPSILON( hBot ) to 0 in conjunction with StepToBdry2D change here.</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">196</div>
            <div class="execution-count">175575678</div>
            <div class="source-code">    IF ( DOT_PRODUCT( Botn, d ) &gt;= 0.0D0 ) THEN</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">197</div>
            <div class="execution-count">3669015</div>
            <div class="source-code">       d0   = x0 - Botx         ! vector from bottom node to ray origin</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">198</div>
            <div class="execution-count">6115025</div>
            <div class="source-code">       hBot = -DOT_PRODUCT( d0, Botn ) / DOT_PRODUCT( urayt, Botn )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">199</div>
            <div class="execution-count">-</div>
            <div class="source-code">    END IF</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">200</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">201</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! top or bottom segment crossing in range</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">202</div>
            <div class="execution-count">58525226</div>
            <div class="source-code">    rSeg( 1 ) = MAX( rTopSeg( 1 ), rBotSeg( 1 ) )</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">203</div>
            <div class="execution-count">58525226</div>
            <div class="source-code">    rSeg( 2 ) = MIN( rTopSeg( 2 ), rBotSeg( 2 ) )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">204</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line executed">
            <div class="line-number">205</div>
            <div class="execution-count">58525226</div>
            <div class="source-code">    IF ( SSP%Type == &#x27;Q&#x27; ) THEN</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">206</div>
            <div class="execution-count">1525908*</div>
            <div class="source-code">       rSeg( 1 ) = MAX( rSeg( 1 ), SSP%Seg%r( iSegr0     ) )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">207</div>
            <div class="execution-count">1525908*</div>
            <div class="source-code">       rSeg( 2 ) = MIN( rSeg( 2 ), SSP%Seg%r( iSegr0 + 1 ) )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">208</div>
            <div class="execution-count">-</div>
            <div class="source-code">    END IF</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">209</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line executed">
            <div class="line-number">210</div>
            <div class="execution-count">58525226</div>
            <div class="source-code">    hSeg = huge( hSeg )</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">211</div>
            <div class="execution-count">58525226</div>
            <div class="source-code">    IF ( ABS( urayt( 1 ) )  &gt; EPSILON( hSeg ) ) THEN</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">212</div>
            <div class="execution-count">58525226</div>
            <div class="source-code">       IF         ( x(  1 ) &lt; rSeg( 1 ) ) THEN</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">213</div>
            <div class="execution-count">10443</div>
            <div class="source-code">          hSeg = -( x0( 1 ) - rSeg( 1 ) ) / urayt( 1 )</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">214</div>
            <div class="execution-count">58514783</div>
            <div class="source-code">       ELSE IF    ( x(  1 ) &gt; rSeg( 2 ) ) THEN</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">215</div>
            <div class="execution-count">1529313</div>
            <div class="source-code">          hSeg = -( x0( 1 ) - rSeg( 2 ) ) / urayt( 1 )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">216</div>
            <div class="execution-count">-</div>
            <div class="source-code">       END IF</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">217</div>
            <div class="execution-count">-</div>
            <div class="source-code">    END IF</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">218</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line executed">
            <div class="line-number">219</div>
            <div class="execution-count">58525226</div>
            <div class="source-code">    h = MIN( h, hInt, hBoxr, hBoxz, hTop, hBot, hSeg )      ! take limit set by shortest distance to a crossing</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">220</div>
            <div class="execution-count">58525226</div>
            <div class="source-code">    IF ( h &lt; INFINITESIMAL_STEP_SIZE * Beam%deltas ) THEN   ! is it taking an infinitesimal step?</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">221</div>
            <div class="execution-count">331</div>
            <div class="source-code">       h = INFINITESIMAL_STEP_SIZE * Beam%deltas            ! make sure we make some motion</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">222</div>
            <div class="execution-count">331</div>
            <div class="source-code">       iSmallStepCtr = iSmallStepCtr + 1   ! keep a count of the number of sequential small steps</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">223</div>
            <div class="execution-count">-</div>
            <div class="source-code">       IF ( STEP_DEBUGGING ) THEN</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">224</div>
            <div class="execution-count">-</div>
            <div class="source-code">          WRITE( PRTFile, * ) &#x27;Small step forced to&#x27;, h</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">225</div>
            <div class="execution-count">-</div>
            <div class="source-code">       END IF</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">226</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ELSE</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">227</div>
            <div class="execution-count">58524895</div>
            <div class="source-code">       iSmallStepCtr = 0                   ! didn&#x27;t do a small step so reset the counter</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">228</div>
            <div class="execution-count">-</div>
            <div class="source-code">    END IF</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">229</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line executed">
            <div class="line-number">230</div>
            <div class="execution-count">58525226</div>
            <div class="source-code">  END SUBROUTINE ReduceStep2D</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">231</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">232</div>
            <div class="execution-count">-</div>
            <div class="source-code">  ! **********************************************************************!</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">233</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line executed">
            <div class="line-number">234</div>
            <div class="execution-count">29262613</div>
            <div class="source-code">  SUBROUTINE StepToBdry2D( x0, x2, urayt, h, topRefl, botRefl, &amp;</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">235</div>
            <div class="execution-count">-</div>
            <div class="source-code">       iSegz0, iSegr0, Topx, Topn, Botx, Botn )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">236</div>
            <div class="execution-count">-</div>
            <div class="source-code">    USE BdryMod</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">237</div>
            <div class="execution-count">-</div>
            <div class="source-code">    REAL (KIND=8), INTENT( IN    ) :: x0( 2 ), urayt( 2 )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">238</div>
            <div class="execution-count">-</div>
            <div class="source-code">    REAL (KIND=8), INTENT( INOUT ) :: x2( 2 ), h</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">239</div>
            <div class="execution-count">-</div>
            <div class="source-code">    INTEGER,       INTENT( IN    ) :: iSegz0, iSegr0                             ! SSP layer the ray is in</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">240</div>
            <div class="execution-count">-</div>
            <div class="source-code">    REAL (KIND=8), INTENT( IN    ) :: Topx( 2 ), Topn( 2 ), Botx( 2 ), Botn( 2 ) ! Top, bottom coordinate and normal</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">241</div>
            <div class="execution-count">-</div>
            <div class="source-code">    LOGICAL,       INTENT( OUT   ) :: topRefl, botRefl</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">242</div>
            <div class="execution-count">-</div>
            <div class="source-code">    REAL (KIND=8)                  :: d( 2 ), d0( 2 ), rSeg( 2 )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">243</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">244</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! Original step due to maximum step size</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">245</div>
            <div class="execution-count">29262613</div>
            <div class="source-code">    h = Beam%deltas</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">246</div>
            <div class="execution-count">87787839</div>
            <div class="source-code">    x2 = x0 + h * urayt</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">247</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">248</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! interface crossing in depth</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">249</div>
            <div class="execution-count">29262613</div>
            <div class="source-code">    IF ( ABS( urayt( 2 ) ) &gt; EPSILON( h ) ) THEN</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">250</div>
            <div class="execution-count">29260997*</div>
            <div class="source-code">       IF      ( SSP%z( iSegz0     ) &gt; x2( 2 ) ) THEN</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">251</div>
            <div class="execution-count">989582*</div>
            <div class="source-code">          h  = ( SSP%z( iSegz0     ) - x0( 2 ) ) / urayt( 2 )</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">252</div>
            <div class="execution-count">989582</div>
            <div class="source-code">          x2( 1 ) = x0( 1 ) + h * urayt( 1 )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">253</div>
            <div class="execution-count">989582*</div>
            <div class="source-code">          x2( 2 ) = SSP%z( iSegz0 )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">254</div>
            <div class="execution-count">-</div>
            <div class="source-code">          IF ( STEP_DEBUGGING ) THEN</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">255</div>
            <div class="execution-count">-</div>
            <div class="source-code">             WRITE( PRTFile, * ) &#x27;StepToBdry2D lower depth h to&#x27;, h, x2</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">256</div>
            <div class="execution-count">-</div>
            <div class="source-code">          END IF</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">257</div>
            <div class="execution-count">28271415*</div>
            <div class="source-code">       ELSE IF ( SSP%z( iSegz0 + 1 ) &lt; x2( 2 ) ) THEN</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">258</div>
            <div class="execution-count">1096094*</div>
            <div class="source-code">          h  = ( SSP%z( iSegz0 + 1 ) - x0( 2 ) ) / urayt( 2 )</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">259</div>
            <div class="execution-count">1096094</div>
            <div class="source-code">          x2( 1 ) = x0( 1 ) + h * urayt( 1 )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">260</div>
            <div class="execution-count">1096094*</div>
            <div class="source-code">          x2( 2 ) = SSP%z( iSegz0 + 1 )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">261</div>
            <div class="execution-count">-</div>
            <div class="source-code">          IF ( STEP_DEBUGGING ) THEN</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">262</div>
            <div class="execution-count">-</div>
            <div class="source-code">             WRITE( PRTFile, * ) &#x27;StepToBdry2D upper depth h to&#x27;, h, x2</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">263</div>
            <div class="execution-count">-</div>
            <div class="source-code">          END IF</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">264</div>
            <div class="execution-count">-</div>
            <div class="source-code">       END IF</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">265</div>
            <div class="execution-count">-</div>
            <div class="source-code">    END IF</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">266</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">267</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! ray mask using a box centered at ( 0, 0 )</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">268</div>
            <div class="execution-count">29262613</div>
            <div class="source-code">    IF ( ABS( x2( 1 ) ) &gt; Beam%Box%r ) THEN</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">269</div>
            <div class="execution-count">789255</div>
            <div class="source-code">       h = ( Beam%Box%r - ABS( x0( 1 ) ) ) / ABS( urayt( 1 ) )</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">270</div>
            <div class="execution-count">789255</div>
            <div class="source-code">       x2( 2 ) = x0( 2 ) + h * urayt( 2 )</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">271</div>
            <div class="execution-count">789255</div>
            <div class="source-code">       x2( 1 ) = SIGN( Beam%Box%r, x0( 1 ) )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">272</div>
            <div class="execution-count">-</div>
            <div class="source-code">       IF ( STEP_DEBUGGING ) THEN</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">273</div>
            <div class="execution-count">-</div>
            <div class="source-code">          WRITE( PRTFile, * ) &#x27;StepToBdry2D beam box crossing R h to&#x27;, h, x2</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">274</div>
            <div class="execution-count">-</div>
            <div class="source-code">       END IF</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">275</div>
            <div class="execution-count">-</div>
            <div class="source-code">    END IF</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">276</div>
            <div class="execution-count">29262613</div>
            <div class="source-code">    IF ( ABS( x2( 2 ) ) &gt; Beam%Box%z ) THEN</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">277</div>
            <div class="execution-count">726</div>
            <div class="source-code">       h = ( Beam%Box%z - ABS( x0( 2 ) ) ) / ABS( urayt( 2 ) )</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">278</div>
            <div class="execution-count">726</div>
            <div class="source-code">       x2( 1 ) = x0( 1 ) + h * urayt( 1 )</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">279</div>
            <div class="execution-count">726</div>
            <div class="source-code">       x2( 2 ) = SIGN( Beam%Box%z, x0( 2 ) )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">280</div>
            <div class="execution-count">-</div>
            <div class="source-code">       IF ( STEP_DEBUGGING ) THEN</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">281</div>
            <div class="execution-count">-</div>
            <div class="source-code">          WRITE( PRTFile, * ) &#x27;StepToBdry2D beam box crossing Z h to&#x27;, h, x2</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">282</div>
            <div class="execution-count">-</div>
            <div class="source-code">       END IF</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">283</div>
            <div class="execution-count">-</div>
            <div class="source-code">    END IF</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">284</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">285</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! top crossing</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">286</div>
            <div class="execution-count">87787839</div>
            <div class="source-code">    d = x2 - Topx             ! vector from top to ray</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">287</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! LP: Originally, this value had to be &gt; a small positive number, meaning the</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">288</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! new step really had to be outside the boundary, not just to the boundary.</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">289</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! Also, this is not missing a normalization factor, Topn is normalized so</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">290</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! this is actually the distance above the top in meters.</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">291</div>
            <div class="execution-count">87787839</div>
            <div class="source-code">    IF ( DOT_PRODUCT( Topn, d ) &gt; -INFINITESIMAL_STEP_SIZE ) THEN</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">292</div>
            <div class="execution-count">1813689</div>
            <div class="source-code">       d0 = x0 - Topx         ! vector from top node to ray origin</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">293</div>
            <div class="execution-count">3022815</div>
            <div class="source-code">       h = -DOT_PRODUCT( d0, Topn ) / DOT_PRODUCT( urayt, Topn )</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">294</div>
            <div class="execution-count">1813689</div>
            <div class="source-code">       x2 = x0 + h * urayt</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">295</div>
            <div class="execution-count">-</div>
            <div class="source-code">       ! Snap to exact top depth value if it&#x27;s flat</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">296</div>
            <div class="execution-count">604563</div>
            <div class="source-code">       IF ( ABS( Topn( 1 ) ) &lt; EPSILON( Topn( 1 ) ) ) THEN</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">297</div>
            <div class="execution-count">604563</div>
            <div class="source-code">          x2( 2 ) = Topx( 2 )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">298</div>
            <div class="execution-count">-</div>
            <div class="source-code">       END IF</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">299</div>
            <div class="execution-count">-</div>
            <div class="source-code">       IF ( STEP_DEBUGGING ) THEN</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">300</div>
            <div class="execution-count">-</div>
            <div class="source-code">          WRITE( PRTFile, * ) &#x27;StepToBdry2D top crossing h to&#x27;, h, x2</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">301</div>
            <div class="execution-count">-</div>
            <div class="source-code">       END IF</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">302</div>
            <div class="execution-count">604563</div>
            <div class="source-code">       topRefl = .TRUE.</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">303</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ELSE</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">304</div>
            <div class="execution-count">28658050</div>
            <div class="source-code">       topRefl = .FALSE.</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">305</div>
            <div class="execution-count">-</div>
            <div class="source-code">    END IF</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">306</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">307</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! bottom crossing</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">308</div>
            <div class="execution-count">87787839</div>
            <div class="source-code">    d = x2 - Botx              ! vector from bottom to ray</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">309</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! See comment above for top case.</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">310</div>
            <div class="execution-count">87787839</div>
            <div class="source-code">    IF ( DOT_PRODUCT( Botn, d ) &gt; -INFINITESIMAL_STEP_SIZE ) THEN</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">311</div>
            <div class="execution-count">1924101</div>
            <div class="source-code">       d0  = x0 - Botx         ! vector from bottom node to ray origin</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">312</div>
            <div class="execution-count">3206835</div>
            <div class="source-code">       h = -DOT_PRODUCT( d0, Botn ) / DOT_PRODUCT( urayt, Botn )</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">313</div>
            <div class="execution-count">1924101</div>
            <div class="source-code">       x2 = x0 + h * urayt</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">314</div>
            <div class="execution-count">-</div>
            <div class="source-code">       ! Snap to exact bottom depth value if it&#x27;s flat</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">315</div>
            <div class="execution-count">641367</div>
            <div class="source-code">       IF ( ABS( Botn( 1 ) ) &lt; EPSILON( Botn( 1 ) ) ) THEN</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">316</div>
            <div class="execution-count">601162</div>
            <div class="source-code">          x2( 2 ) = Botx( 2 )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">317</div>
            <div class="execution-count">-</div>
            <div class="source-code">       END IF</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">318</div>
            <div class="execution-count">-</div>
            <div class="source-code">       IF ( STEP_DEBUGGING ) THEN</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">319</div>
            <div class="execution-count">-</div>
            <div class="source-code">          WRITE( PRTFile, * ) &#x27;StepToBdry2D bottom crossing h to&#x27;, h, x2</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">320</div>
            <div class="execution-count">-</div>
            <div class="source-code">       END IF</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">321</div>
            <div class="execution-count">641367</div>
            <div class="source-code">       botRefl = .TRUE.</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">322</div>
            <div class="execution-count">-</div>
            <div class="source-code">       ! Should not ever be able to cross both, but in case it does, make sure</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">323</div>
            <div class="execution-count">-</div>
            <div class="source-code">       ! only the crossing we exactly landed on is active</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">324</div>
            <div class="execution-count">641367</div>
            <div class="source-code">       topRefl = .FALSE.</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">325</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ELSE</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">326</div>
            <div class="execution-count">28621246</div>
            <div class="source-code">       botRefl = .FALSE.</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">327</div>
            <div class="execution-count">-</div>
            <div class="source-code">    END IF</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">328</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">329</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ! top or bottom segment crossing in range</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">330</div>
            <div class="execution-count">29262613</div>
            <div class="source-code">    rSeg( 1 ) = MAX( rTopSeg( 1 ), rBotSeg( 1 ) ) ! LP: lower range bound (not an x value)</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">331</div>
            <div class="execution-count">29262613</div>
            <div class="source-code">    rSeg( 2 ) = MIN( rTopSeg( 2 ), rBotSeg( 2 ) ) ! LP: upper range bound (not a y value)</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">332</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line executed">
            <div class="line-number">333</div>
            <div class="execution-count">29262613</div>
            <div class="source-code">    IF ( SSP%Type == &#x27;Q&#x27; ) THEN</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">334</div>
            <div class="execution-count">762954*</div>
            <div class="source-code">       rSeg( 1 ) = MAX( rSeg( 1 ), SSP%Seg%r( iSegr0     ) )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">335</div>
            <div class="execution-count">762954*</div>
            <div class="source-code">       rSeg( 2 ) = MIN( rSeg( 2 ), SSP%Seg%r( iSegr0 + 1 ) )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">336</div>
            <div class="execution-count">-</div>
            <div class="source-code">    END IF</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">337</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line executed">
            <div class="line-number">338</div>
            <div class="execution-count">29262613</div>
            <div class="source-code">    IF ( ABS( urayt( 1 ) )  &gt; EPSILON( h ) ) THEN</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">339</div>
            <div class="execution-count">29262613</div>
            <div class="source-code">       IF      ( x2( 1 ) &lt; rSeg( 1 ) ) THEN</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">340</div>
            <div class="execution-count">753261</div>
            <div class="source-code">          h = -( x0( 1 ) - rSeg( 1 ) ) / urayt( 1 )</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">341</div>
            <div class="execution-count">753261</div>
            <div class="source-code">          x2( 1 ) = rSeg( 1 )</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">342</div>
            <div class="execution-count">753261</div>
            <div class="source-code">          x2( 2 ) = x0( 2 ) + h * urayt( 2 )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">343</div>
            <div class="execution-count">-</div>
            <div class="source-code">          IF ( STEP_DEBUGGING ) THEN</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">344</div>
            <div class="execution-count">-</div>
            <div class="source-code">             WRITE( PRTFile, * ) &#x27;StepToBdry2D lower range h to&#x27;, h, x2</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">345</div>
            <div class="execution-count">-</div>
            <div class="source-code">          END IF</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">346</div>
            <div class="execution-count">753261</div>
            <div class="source-code">          topRefl = .FALSE.</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">347</div>
            <div class="execution-count">753261</div>
            <div class="source-code">          botRefl = .FALSE.</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">348</div>
            <div class="execution-count">28509352</div>
            <div class="source-code">       ELSE IF ( x2( 1 ) &gt; rSeg( 2 ) ) THEN</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">349</div>
            <div class="execution-count">18654</div>
            <div class="source-code">          h = -( x0( 1 ) - rSeg( 2 ) ) / urayt( 1 )</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">350</div>
            <div class="execution-count">18654</div>
            <div class="source-code">          x2( 1 ) = rSeg( 2 )</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">351</div>
            <div class="execution-count">18654</div>
            <div class="source-code">          x2( 2 ) = x0( 2 ) + h * urayt( 2 )</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">352</div>
            <div class="execution-count">-</div>
            <div class="source-code">          IF ( STEP_DEBUGGING ) THEN</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">353</div>
            <div class="execution-count">-</div>
            <div class="source-code">             WRITE( PRTFile, * ) &#x27;StepToBdry2D upper range h to&#x27;, h, x2</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">354</div>
            <div class="execution-count">-</div>
            <div class="source-code">          END IF</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">355</div>
            <div class="execution-count">18654</div>
            <div class="source-code">          topRefl = .FALSE.</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">356</div>
            <div class="execution-count">18654</div>
            <div class="source-code">          botRefl = .FALSE.</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">357</div>
            <div class="execution-count">-</div>
            <div class="source-code">       END IF</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">358</div>
            <div class="execution-count">-</div>
            <div class="source-code">    END IF</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">359</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line executed">
            <div class="line-number">360</div>
            <div class="execution-count">29262613</div>
            <div class="source-code">    IF ( h &lt; INFINITESIMAL_STEP_SIZE * Beam%deltas ) THEN   ! is it taking an infinitesimal step?</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">361</div>
            <div class="execution-count">747216</div>
            <div class="source-code">       h = INFINITESIMAL_STEP_SIZE * Beam%deltas            ! make sure we make some motion</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">362</div>
            <div class="execution-count">2241648</div>
            <div class="source-code">       x2 = x0 + h * urayt</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">363</div>
            <div class="execution-count">-</div>
            <div class="source-code">       IF ( STEP_DEBUGGING ) THEN</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">364</div>
            <div class="execution-count">-</div>
            <div class="source-code">          WRITE( PRTFile, * ) &#x27;StepToBdry2D small step forced h to&#x27;, h, x2</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">365</div>
            <div class="execution-count">-</div>
            <div class="source-code">       END IF</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">366</div>
            <div class="execution-count">-</div>
            <div class="source-code">       ! Recheck reflection conditions</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">367</div>
            <div class="execution-count">2241648</div>
            <div class="source-code">       d = x2 - Topx             ! vector from top to ray</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">368</div>
            <div class="execution-count">2241648</div>
            <div class="source-code">       IF ( DOT_PRODUCT( Topn, d ) &gt; EPSILON( h ) ) THEN</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">369</div>
            <div class="execution-count">1</div>
            <div class="source-code">          topRefl = .TRUE.</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">370</div>
            <div class="execution-count">-</div>
            <div class="source-code">       ELSE</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">371</div>
            <div class="execution-count">747215</div>
            <div class="source-code">          topRefl = .FALSE.</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">372</div>
            <div class="execution-count">-</div>
            <div class="source-code">       END IF</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">373</div>
            <div class="execution-count">2241648</div>
            <div class="source-code">       d = x2 - Botx              ! vector from bottom to ray</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">374</div>
            <div class="execution-count">2241648</div>
            <div class="source-code">       IF ( DOT_PRODUCT( Botn, d ) &gt; EPSILON( h ) ) THEN</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">375</div>
            <div class="execution-count">#####</div>
            <div class="source-code">          botRefl = .TRUE.</div>
        </div>
        <div class="code-line not-executed">
            <div class="line-number">376</div>
            <div class="execution-count">#####</div>
            <div class="source-code">          topRefl = .FALSE.</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">377</div>
            <div class="execution-count">-</div>
            <div class="source-code">       ELSE</div>
        </div>
        <div class="code-line executed">
            <div class="line-number">378</div>
            <div class="execution-count">747216</div>
            <div class="source-code">          botRefl = .FALSE.</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">379</div>
            <div class="execution-count">-</div>
            <div class="source-code">       END IF</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">380</div>
            <div class="execution-count">-</div>
            <div class="source-code">    ELSE</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">381</div>
            <div class="execution-count">-</div>
            <div class="source-code">       IF ( STEP_DEBUGGING ) THEN</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">382</div>
            <div class="execution-count">-</div>
            <div class="source-code">          WRITE( PRTFile, * ) &#x27;StepToBdry2D normal h to&#x27;, h, x2</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">383</div>
            <div class="execution-count">-</div>
            <div class="source-code">       END IF</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">384</div>
            <div class="execution-count">-</div>
            <div class="source-code">    END IF</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">385</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line executed">
            <div class="line-number">386</div>
            <div class="execution-count">29262613</div>
            <div class="source-code">  END SUBROUTINE StepToBdry2D</div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">387</div>
            <div class="execution-count">-</div>
            <div class="source-code"></div>
        </div>
        <div class="code-line non-executable">
            <div class="line-number">388</div>
            <div class="execution-count">-</div>
            <div class="source-code">END MODULE Step</div>
        </div>
    </div>

    <div class="footer">
        <p><strong>Legend:</strong></p>
        <ul>
            <li><span style="background-color: #d4edda; padding: 2px 4px;">Green</span> - Executed lines</li>
            <li><span style="background-color: #f8d7da; padding: 2px 4px;">Red</span> - Not executed lines</li>
            <li><span style="background-color: #f8f9fa; padding: 2px 4px;">Gray</span> - Non-executable lines (comments, declarations)</li>
        </ul>
        <p><strong>Execution Count:</strong> Number of times each line was executed. ##### indicates never executed, - indicates non-executable.</p>
    </div>
</body>
</html>